<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vendys Internal Docs</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <style>
    :root {
      --bg-primary:#ffffff; --bg-secondary:#f8fafd; --bg-tertiary:#f0f4f9;
      --bg-hover:#e8eef6; --bg-active:#dce6f2; --border:#e2e8f0;
      --border-subtle:#edf1f7; --text-primary:#1a2332; --text-secondary:#4a5568;
      --text-muted:#94a3b8; --accent:#4a90d9; --accent-dim:rgba(74,144,217,0.06);
      --accent-border:rgba(74,144,217,0.2); --accent-bg:#eef4fb;
      --danger:#e85d5d; --warn:#d49a2a; --gnb-h:40px; --lnb-w:230px;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Noto Sans KR',-apple-system,sans-serif;background:var(--bg-primary);color:var(--text-primary);height:100vh;overflow:hidden;font-size:13px}

    .login-screen{display:flex;align-items:center;justify-content:center;height:100vh;background:var(--bg-secondary)}
    .login-card{text-align:center;padding:48px;max-width:360px}
    .login-logo{font-size:11px;font-weight:600;letter-spacing:3px;text-transform:uppercase;color:var(--accent);margin-bottom:6px}
    .login-title{font-size:20px;font-weight:300;color:var(--text-primary);margin-bottom:36px}
    .login-btn{display:inline-flex;align-items:center;gap:10px;padding:11px 24px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:13px;font-family:inherit;cursor:pointer;transition:all .15s;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .login-btn:hover{background:var(--bg-tertiary);border-color:var(--accent-border)}
    .login-btn svg{width:16px;height:16px}
    .login-notice{margin-top:20px;font-size:11px;color:var(--text-muted)}
    .login-error{margin-top:14px;padding:9px 14px;background:rgba(232,93,93,.06);border:1px solid rgba(232,93,93,.15);border-radius:5px;font-size:12px;color:var(--danger);display:none}

    .loading{display:flex;align-items:center;justify-content:center;height:100vh;background:var(--bg-secondary)}
    .spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .5s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .gnb{display:none;height:var(--gnb-h);background:var(--bg-primary);border-bottom:1px solid var(--border);padding:0 12px;align-items:center;justify-content:space-between;position:fixed;top:0;left:0;right:0;z-index:100}
    .gnb.active{display:flex}
    .gnb-left{display:flex;align-items:center;gap:16px}
    .gnb-brand{font-size:12px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--accent)}
    .gnb-sep{width:1px;height:16px;background:var(--border)}
    .gnb-tabs{display:flex;gap:2px}
    .gnb-tab{padding:4px 10px;border-radius:4px;font-size:12px;color:var(--text-muted);cursor:pointer;transition:all .1s}
    .gnb-tab:hover{color:var(--text-secondary);background:var(--bg-tertiary)}
    .gnb-tab.active{color:var(--accent);background:var(--accent-dim);font-weight:500}
    .gnb-right{display:flex;align-items:center;gap:12px}

    /* Hamburger button - hidden on desktop */
    .gnb-hamburger{display:none;width:28px;height:28px;border:none;background:none;cursor:pointer;padding:4px;border-radius:4px;color:var(--text-secondary);transition:all .1s;flex-shrink:0}
    .gnb-hamburger:hover{background:var(--bg-tertiary);color:var(--text-primary)}
    .gnb-hamburger svg{width:20px;height:20px}

    .search-box{position:relative;width:220px}
    .search-input{width:100%;padding:6px 10px 6px 30px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:5px;color:var(--text-primary);font-size:12px;font-family:inherit;outline:none;transition:all .15s}
    .search-input::placeholder{color:var(--text-muted)}
    .search-input:focus{border-color:var(--accent);background:var(--bg-primary);box-shadow:0 0 0 3px var(--accent-dim)}
    .search-icon{position:absolute;left:9px;top:50%;transform:translateY(-50%);width:14px;height:14px;color:var(--text-muted);pointer-events:none}
    .search-kbd{position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:10px;color:var(--text-muted);background:var(--bg-primary);padding:1px 5px;border-radius:3px;border:1px solid var(--border)}
    .search-results{display:none;position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;max-height:280px;overflow-y:auto;box-shadow:0 8px 24px rgba(0,0,0,.08);z-index:200}
    .search-results.open{display:block}
    .search-result-item{padding:8px 12px;cursor:pointer;transition:background .1s;border-bottom:1px solid var(--border-subtle)}
    .search-result-item:last-child{border-bottom:none}
    .search-result-item:hover{background:var(--bg-tertiary)}
    .search-result-title{font-size:12px;color:var(--text-primary);font-weight:500}
    .search-result-path{font-size:10px;color:var(--text-muted);margin-top:2px}
    .search-result-snippet{font-size:11px;color:var(--text-muted);margin-top:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .search-result-snippet mark{background:var(--accent-bg);color:var(--accent);border-radius:1px;padding:0 1px}
    .search-empty{padding:16px 12px;text-align:center;font-size:12px;color:var(--text-muted)}

    .gnb-user{display:flex;align-items:center;gap:8px;padding:4px 8px;border-radius:4px;cursor:pointer;transition:background .1s;position:relative}
    .gnb-user:hover{background:var(--bg-tertiary)}
    .gnb-avatar{width:24px;height:24px;border-radius:50%;background:var(--bg-active);overflow:hidden;border:1px solid var(--border)}
    .gnb-avatar img{width:100%;height:100%;object-fit:cover}
    .gnb-username{font-size:12px;color:var(--text-secondary)}
    .user-menu{display:none;position:absolute;top:calc(100% + 6px);right:0;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;min-width:140px;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.08);z-index:200}
    .user-menu.open{display:block}
    .user-menu-item{padding:8px 14px;font-size:12px;color:var(--text-secondary);cursor:pointer;transition:all .1s}
    .user-menu-item:hover{background:var(--bg-tertiary);color:var(--text-primary)}
    .user-menu-item.danger{color:var(--danger)}
    .user-menu-item.danger:hover{background:rgba(232,93,93,.04)}

    .main-layout{display:none;margin-top:var(--gnb-h);height:calc(100vh - var(--gnb-h))}
    .main-layout.active{display:grid;grid-template-columns:var(--lnb-w) 1fr}

    /* LNB backdrop overlay for mobile */
    .lnb-backdrop{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(26,35,50,.3);z-index:150}
    .lnb-backdrop.open{display:block}

    .lnb{background:var(--bg-secondary);border-right:1px solid var(--border);display:flex;flex-direction:column;height:calc(100vh - var(--gnb-h));overflow:hidden}
    .lnb-header{padding:8px 10px 6px;border-bottom:1px solid var(--border-subtle);flex-shrink:0}
    .lnb-section-title{font-size:11px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--text-muted)}
    /* Mobile tabs inside LNB */
    .lnb-mobile-tabs{display:none;padding:6px 8px;border-bottom:1px solid var(--border-subtle);gap:4px;flex-shrink:0;flex-wrap:wrap}
    .lnb-mobile-tab{padding:3px 8px;border-radius:3px;font-size:11px;color:var(--text-muted);cursor:pointer;transition:all .1s;border:1px solid transparent}
    .lnb-mobile-tab:hover{color:var(--text-secondary);background:var(--bg-tertiary)}
    .lnb-mobile-tab.active{color:var(--accent);background:var(--accent-dim);border-color:var(--accent-border);font-weight:500}
    .lnb-tree{flex:1;overflow-y:auto;padding:4px 4px}
    .lnb-tree::-webkit-scrollbar{width:3px}
    .lnb-tree::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

    .tree-row{display:flex;align-items:center;gap:3px;padding:3px 6px;border-radius:3px;cursor:pointer;transition:all .08s;font-size:12px;color:var(--text-secondary)}
    .tree-row:hover{background:var(--bg-hover);color:var(--text-primary)}
    .tree-row.active{background:var(--accent-bg);color:var(--accent)}
    .tree-toggle{width:16px;height:16px;flex-shrink:0;display:flex;align-items:center;justify-content:center;color:var(--text-muted);transition:transform .15s}
    .tree-toggle.expanded{transform:rotate(90deg)}
    .tree-toggle.hidden{visibility:hidden}
    .tree-icon{width:14px;height:14px;flex-shrink:0;color:var(--text-muted);opacity:.5}
    .tree-row.active .tree-icon{color:var(--accent);opacity:1}
    .tree-label{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .tree-children{display:none;padding-left:12px}
    .tree-children.open{display:block}

    .content-area{height:calc(100vh - var(--gnb-h));overflow-y:auto;padding:16px 24px 24px;background:var(--bg-primary)}
    .content-area::-webkit-scrollbar{width:4px}
    .content-area::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
    .content-loading{display:flex;align-items:center;justify-content:center;padding:60px;color:var(--text-muted);font-size:13px;gap:8px}
    .content-loading .spinner{width:16px;height:16px}

    .breadcrumb{display:flex;align-items:center;gap:6px;margin-bottom:10px;font-size:11px}
    .breadcrumb-item{color:var(--text-muted);cursor:pointer;transition:color .1s}
    .breadcrumb-item:hover{color:var(--accent)}
    .breadcrumb-item.current{color:var(--text-secondary);cursor:default}
    .breadcrumb-sep{color:var(--text-muted);font-size:10px}

    .doc-title-wrap{display:flex;align-items:center;gap:8px;margin-bottom:4px}
    .doc-title{font-size:20px;font-weight:600;letter-spacing:-.5px}
    .doc-meta{font-size:11px;color:var(--text-muted);margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border-subtle)}
    .doc-body h2{font-size:15px;font-weight:600;margin:16px 0 6px;color:var(--text-primary)}
    .doc-body h3{font-size:13px;font-weight:600;margin:12px 0 4px;color:var(--text-primary)}
    .doc-body p{font-size:13px;line-height:1.6;color:var(--text-secondary);margin-bottom:6px}
    .doc-body code{font-family:'JetBrains Mono',monospace;font-size:12px;background:var(--accent-bg);border:1px solid var(--accent-border);padding:1px 5px;border-radius:3px;color:var(--accent)}
    .doc-body pre{background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;padding:10px 14px;margin:8px 0;overflow-x:auto;font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.5;color:var(--text-secondary)}
    .doc-body pre code{background:none;border:none;padding:0;color:inherit;font-size:inherit}
    .doc-body ul,.doc-body ol{padding-left:18px;margin-bottom:6px}
    .doc-body li{font-size:13px;line-height:1.6;color:var(--text-secondary);margin-bottom:1px}
    .doc-body .callout{padding:8px 12px;background:var(--accent-bg);border-left:3px solid var(--accent);border-radius:0 4px 4px 0;margin:8px 0;font-size:12px;color:var(--text-secondary);line-height:1.5}
    .doc-body .callout-warn{padding:8px 12px;background:rgba(212,154,42,.06);border-left:3px solid var(--warn);border-radius:0 4px 4px 0;margin:8px 0;font-size:12px;color:var(--text-secondary);line-height:1.5}
    .doc-body table{width:100%;border-collapse:collapse;margin:8px 0;font-size:12px}
    .doc-body th{text-align:left;padding:5px 10px;background:var(--bg-tertiary);border:1px solid var(--border);color:var(--text-primary);font-weight:500}
    .doc-body td{padding:5px 10px;border:1px solid var(--border);color:var(--text-secondary)}

    .child-pages{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:6px;margin-top:12px}
    .child-page-card{padding:10px 12px;background:var(--bg-primary);border:1px solid var(--border);border-radius:4px;cursor:pointer;transition:all .12s}
    .child-page-card:hover{border-color:var(--accent-border);background:var(--accent-bg)}
    .child-page-card-title{font-size:12px;font-weight:500;color:var(--text-primary);margin-bottom:2px}
    .child-page-card-desc{font-size:11px;color:var(--text-muted);line-height:1.4}

    /* Guide Button */
    .guide-btn{width:22px;height:22px;border-radius:50%;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-muted);font-size:12px;font-weight:600;font-family:'JetBrains Mono',monospace;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0}
    .guide-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-bg)}

    /* Guide Modal */
    .guide-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(26,35,50,.35);z-index:500;align-items:center;justify-content:center}
    .guide-overlay.open{display:flex}
    .guide-modal{background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;width:min(720px,90vw);max-height:80vh;display:flex;flex-direction:column;box-shadow:0 16px 48px rgba(0,0,0,.12)}
    .guide-modal-header{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-bottom:1px solid var(--border);flex-shrink:0}
    .guide-modal-title{font-size:13px;font-weight:600;color:var(--text-primary)}
    .guide-modal-close{width:24px;height:24px;border:none;background:none;color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:3px;transition:all .1s}
    .guide-modal-close:hover{background:var(--bg-tertiary);color:var(--text-primary)}
    .guide-modal-body{flex:1;overflow-y:auto;padding:16px 20px}
    .guide-modal-body::-webkit-scrollbar{width:3px}
    .guide-modal-body::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
    .guide-modal-body h1{font-size:17px;font-weight:600;margin:0 0 10px;color:var(--text-primary)}
    .guide-modal-body h2{font-size:14px;font-weight:600;margin:14px 0 6px;color:var(--text-primary)}
    .guide-modal-body h3{font-size:12px;font-weight:600;margin:10px 0 4px;color:var(--text-primary)}
    .guide-modal-body p{font-size:12px;line-height:1.6;color:var(--text-secondary);margin-bottom:6px}
    .guide-modal-body ul,.guide-modal-body ol{padding-left:18px;margin-bottom:6px}
    .guide-modal-body li{font-size:12px;line-height:1.6;color:var(--text-secondary);margin-bottom:1px}
    .guide-modal-body code{font-family:'JetBrains Mono',monospace;font-size:11px;background:var(--accent-bg);border:1px solid var(--accent-border);padding:1px 4px;border-radius:3px;color:var(--accent)}
    .guide-modal-body pre{background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;padding:10px 14px;margin:6px 0;overflow-x:auto;font-family:'JetBrains Mono',monospace;font-size:11px;line-height:1.5;color:var(--text-secondary)}
    .guide-modal-body pre code{background:none;border:none;padding:0;color:inherit;font-size:inherit}
    .guide-modal-body table{width:100%;border-collapse:collapse;margin:6px 0;font-size:11px}
    .guide-modal-body th{text-align:left;padding:4px 8px;background:var(--bg-tertiary);border:1px solid var(--border);color:var(--text-primary);font-weight:500}
    .guide-modal-body td{padding:4px 8px;border:1px solid var(--border);color:var(--text-secondary)}
    .guide-modal-body blockquote{padding:6px 12px;background:var(--accent-bg);border-left:3px solid var(--accent);border-radius:0 4px 4px 0;margin:6px 0;font-size:12px;color:var(--text-secondary)}
    .guide-modal-body hr{border:none;border-top:1px solid var(--border);margin:10px 0}
    .guide-modal-loading{display:flex;align-items:center;justify-content:center;padding:40px;color:var(--text-muted);font-size:12px;gap:8px}
    .guide-modal-loading .spinner{width:14px;height:14px}

    /* ═══ SITEMAP EDITOR ═══ */
    .sme-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(26,35,50,.4);z-index:600;align-items:center;justify-content:center}
    .sme-overlay.open{display:flex}
    .sme-modal{background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;width:min(900px,94vw);height:min(600px,85vh);display:flex;flex-direction:column;box-shadow:0 16px 48px rgba(0,0,0,.12)}
    .sme-header{display:flex;align-items:center;justify-content:space-between;padding:8px 14px;border-bottom:1px solid var(--border);flex-shrink:0}
    .sme-header-left{display:flex;align-items:center;gap:10px}
    .sme-title{font-size:13px;font-weight:600;color:var(--text-primary)}
    .sme-header-actions{display:flex;gap:6px}
    .sme-btn{padding:4px 10px;border-radius:3px;font-size:11px;font-family:inherit;cursor:pointer;border:1px solid var(--border);background:var(--bg-primary);color:var(--text-secondary);transition:all .1s}
    .sme-btn:hover{background:var(--bg-tertiary);color:var(--text-primary)}
    .sme-btn--accent{background:var(--accent);color:#fff;border-color:var(--accent)}
    .sme-btn--accent:hover{background:#3a7bc8;color:#fff}
    .sme-btn--danger{color:var(--danger);border-color:rgba(232,93,93,.3)}
    .sme-btn--danger:hover{background:rgba(232,93,93,.06)}
    .sme-btn--success{color:#22c55e;border-color:rgba(34,197,94,.3)}
    .sme-btn--success:hover{background:rgba(34,197,94,.06)}
    .sme-close{width:24px;height:24px;border:none;background:none;color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:3px;transition:all .1s}
    .sme-close:hover{background:var(--bg-tertiary);color:var(--text-primary)}

    .sme-body{flex:1;display:grid;grid-template-columns:260px 1fr;overflow:hidden}
    .sme-tree-panel{border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
    .sme-tree-toolbar{padding:6px 8px;border-bottom:1px solid var(--border-subtle);display:flex;gap:4px;flex-shrink:0;flex-wrap:wrap}
    .sme-tree-toolbar .sme-btn{font-size:10px;padding:3px 7px}
    .sme-tab-bar{padding:4px 8px;border-bottom:1px solid var(--border-subtle);display:flex;gap:2px;flex-shrink:0;flex-wrap:wrap}
    .sme-tab{padding:3px 8px;border-radius:3px;font-size:11px;color:var(--text-muted);cursor:pointer;transition:all .1s}
    .sme-tab:hover{color:var(--text-secondary);background:var(--bg-tertiary)}
    .sme-tab.active{color:var(--accent);background:var(--accent-dim);font-weight:500}
    .sme-tree-list{flex:1;overflow-y:auto;padding:4px}
    .sme-tree-list::-webkit-scrollbar{width:3px}
    .sme-tree-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

    .sme-node{padding:1px 0}
    .sme-node-row{display:flex;align-items:center;gap:2px;padding:3px 6px;border-radius:3px;cursor:pointer;font-size:12px;color:var(--text-secondary);transition:all .08s;border:1px solid transparent}
    .sme-node-row:hover{background:var(--bg-hover);color:var(--text-primary)}
    .sme-node-row.selected{background:var(--accent-bg);color:var(--accent);border-color:var(--accent-border)}
    .sme-node-toggle{width:14px;height:14px;flex-shrink:0;display:flex;align-items:center;justify-content:center;color:var(--text-muted);cursor:pointer}
    .sme-node-toggle.hidden{visibility:hidden}
    .sme-node-toggle.expanded svg{transform:rotate(90deg)}
    .sme-node-icon{font-size:10px;width:16px;text-align:center;flex-shrink:0;color:var(--text-muted)}
    .sme-node-label{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sme-node-actions{display:none;gap:2px;flex-shrink:0}
    .sme-node-row:hover .sme-node-actions{display:flex}
    .sme-node-act{width:18px;height:18px;border:none;background:none;color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:2px;font-size:11px;transition:all .1s}
    .sme-node-act:hover{background:var(--bg-active);color:var(--text-primary)}
    .sme-node-children{padding-left:14px}

    .sme-edit-panel{display:flex;flex-direction:column;overflow:hidden}
    .sme-edit-header{padding:8px 14px;border-bottom:1px solid var(--border-subtle);font-size:11px;font-weight:600;color:var(--text-muted);letter-spacing:.5px;text-transform:uppercase;flex-shrink:0}
    .sme-edit-body{flex:1;overflow-y:auto;padding:12px 14px}
    .sme-edit-body::-webkit-scrollbar{width:3px}
    .sme-edit-body::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
    .sme-edit-empty{display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-muted);font-size:12px}
    .sme-field{margin-bottom:10px}
    .sme-field label{display:block;font-size:11px;color:var(--text-muted);margin-bottom:3px;font-weight:500}
    .sme-field input,.sme-field select{width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:3px;font-size:12px;font-family:inherit;color:var(--text-primary);background:var(--bg-primary);outline:none;transition:border-color .1s}
    .sme-field input:focus,.sme-field select:focus{border-color:var(--accent)}
    .sme-field-hint{font-size:10px;color:var(--text-muted);margin-top:2px}
    .sme-field-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}

    .sme-footer{padding:8px 14px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
    .sme-footer-left{font-size:11px;color:var(--text-muted)}
    .sme-footer-right{display:flex;gap:6px}
    .sme-copy-feedback{font-size:11px;color:#22c55e;opacity:0;transition:opacity .3s}
    .sme-copy-feedback.show{opacity:1}

    /* Admin gear button in GNB */
    .gnb-admin-btn{width:24px;height:24px;border:none;background:none;color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:4px;transition:all .1s}
    .gnb-admin-btn:hover{background:var(--bg-tertiary);color:var(--text-primary)}

    @media (max-width: 768px) {
      .sme-modal { width:98vw; height:90vh }
      .sme-body { grid-template-columns:1fr; grid-template-rows:200px 1fr }
      .sme-tree-panel { border-right:none; border-bottom:1px solid var(--border) }
    }

    /* ═══ MOBILE RESPONSIVE ═══ */
    @media (max-width: 768px) {
      :root { --gnb-h: 44px; }

      /* GNB: show hamburger, hide tabs/sep/search-kbd, shrink search */
      .gnb-hamburger { display:flex }
      .gnb-sep, .gnb-tabs, .search-kbd { display:none }
      .gnb-left { gap:8px }
      .gnb-brand { font-size:11px; letter-spacing:1.5px }
      .search-box { width:140px }
      .search-input { padding:5px 8px 5px 28px; font-size:11px }
      .search-icon { left:7px; width:13px; height:13px }
      .gnb-username { display:none }
      .gnb-right { gap:8px }
      .gnb { padding:0 8px }

      /* Search results on mobile - full width */
      .search-results { left:-60px; right:-40px; min-width:280px }

      /* Main layout: single column, no LNB grid col */
      .main-layout.active { grid-template-columns:1fr }

      /* LNB: off-canvas drawer */
      .lnb {
        position:fixed; top:var(--gnb-h); left:0; bottom:0;
        width:260px; z-index:160;
        transform:translateX(-100%);
        transition:transform .2s ease;
        box-shadow:none;
      }
      .lnb.mobile-open {
        transform:translateX(0);
        box-shadow:4px 0 16px rgba(0,0,0,.08);
      }
      /* Show mobile tabs inside LNB */
      .lnb-mobile-tabs { display:flex }
      /* Larger touch targets for tree items */
      .tree-row { padding:6px 8px; font-size:13px }

      /* Content area: full width, less padding */
      .content-area { padding:10px 12px 16px }

      /* Hide breadcrumb on mobile */
      .breadcrumb { display:none }

      /* Doc title smaller */
      .doc-title { font-size:17px }
      .doc-meta { margin-bottom:8px; padding-bottom:6px }

      /* Child page cards: 2 columns */
      .child-pages { grid-template-columns:repeat(auto-fill, minmax(140px,1fr)); gap:4px }
      .child-page-card { padding:8px 10px }
      .child-page-card-title { font-size:11px }
      .child-page-card-desc { font-size:10px }

      /* Guide modal: nearly full screen */
      .guide-modal { width:95vw; max-height:85vh; border-radius:4px }
      .guide-modal-body { padding:12px 14px }
    }
  </style>
</head>
<body>
  <div class="loading" id="loading"><div class="spinner"></div></div>

  <div class="login-screen" id="loginScreen" style="display:none">
    <div class="login-card">
      <div class="login-logo">Vendys</div>
      <div class="login-title">Internal Documentation</div>
      <button class="login-btn" onclick="signIn()">
        <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.27-4.74 3.27-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Google 계정으로 로그인
      </button>
      <div class="login-notice">@vendys.co.kr 계정만 접근 가능합니다</div>
      <div class="login-error" id="loginError"></div>
    </div>
  </div>

  <header class="gnb" id="gnb">
    <div class="gnb-left">
      <button class="gnb-hamburger" id="hamburgerBtn" onclick="toggleMobileLnb()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <line x1="3" y1="6" x2="21" y2="6"/>
          <line x1="3" y1="12" x2="21" y2="12"/>
          <line x1="3" y1="18" x2="21" y2="18"/>
        </svg>
      </button>
      <div class="gnb-brand">Vendys Docs</div>
      <div class="gnb-sep"></div>
      <div class="gnb-tabs" id="gnbTabs"></div>
    </div>
    <div class="gnb-right">
      <button class="gnb-admin-btn" id="gnbAdminBtn" onclick="openSitemapEditor()" title="사이트맵 관리" style="display:none">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      </button>
      <div class="search-box">
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input class="search-input" id="searchInput" type="text" placeholder="검색..." autocomplete="off">
        <span class="search-kbd">/</span>
        <div class="search-results" id="searchResults"></div>
      </div>
      <div class="gnb-user" id="gnbUser" onclick="toggleUserMenu()">
        <div class="gnb-avatar" id="gnbAvatar"></div>
        <span class="gnb-username" id="gnbUsername"></span>
        <div class="user-menu" id="userMenu">
          <div class="user-menu-item" id="userEmail" style="pointer-events:none;color:var(--text-muted);font-size:11px"></div>
          <div class="user-menu-item danger" onclick="signOut()">로그아웃</div>
        </div>
      </div>
    </div>
  </header>

  <!-- LNB backdrop for mobile -->
  <div class="lnb-backdrop" id="lnbBackdrop" onclick="closeMobileLnb()"></div>

  <div class="main-layout" id="mainLayout">
    <aside class="lnb" id="lnbAside">
      <div class="lnb-header"><div class="lnb-section-title" id="lnbTitle">문서</div></div>
      <div class="lnb-mobile-tabs" id="lnbMobileTabs"></div>
      <div class="lnb-tree" id="lnbTree"></div>
    </aside>
    <main class="content-area" id="contentArea"></main>
  </div>

  <!-- Guide Modal -->
  <div class="guide-overlay" id="guideOverlay" onclick="if(event.target===this)closeGuide()">
    <div class="guide-modal">
      <div class="guide-modal-header">
        <span class="guide-modal-title" id="guideModalTitle">페이지 가이드</span>
        <button class="guide-modal-close" onclick="closeGuide()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="guide-modal-body" id="guideModalBody"></div>
    </div>
  </div>

  <!-- Sitemap Editor Modal -->
  <div class="sme-overlay" id="smeOverlay" onclick="if(event.target===this)closeSitemapEditor()">
    <div class="sme-modal">
      <div class="sme-header">
        <div class="sme-header-left">
          <span class="sme-title">사이트맵 관리</span>
        </div>
        <div class="sme-header-actions">
          <button class="sme-close" onclick="closeSitemapEditor()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
      </div>
      <div class="sme-body">
        <div class="sme-tree-panel">
          <div class="sme-tab-bar" id="smeTabBar"></div>
          <div class="sme-tree-toolbar">
            <button class="sme-btn" onclick="smeAddPage()">+ 페이지</button>
            <button class="sme-btn" onclick="smeAddFolder()">+ 폴더</button>
            <button class="sme-btn" onclick="smeAddTab()">+ 탭</button>
          </div>
          <div class="sme-tree-list" id="smeTreeList"></div>
        </div>
        <div class="sme-edit-panel">
          <div class="sme-edit-header" id="smeEditHeader">속성</div>
          <div class="sme-edit-body" id="smeEditBody">
            <div class="sme-edit-empty">항목을 선택하세요</div>
          </div>
        </div>
      </div>
      <div class="sme-footer">
        <div class="sme-footer-left">
          <span class="sme-copy-feedback" id="smeCopyFeedback">복사 완료</span>
        </div>
        <div class="sme-footer-right">
          <button class="sme-btn" onclick="smePreviewJson()">JSON 미리보기</button>
          <button class="sme-btn sme-btn--success" onclick="smeCopyJson()">JSON 복사</button>
          <button class="sme-btn sme-btn--accent" onclick="smeApplyLive()">실시간 적용</button>
        </div>
      </div>
    </div>
  </div>

<script>
// ═══ FIREBASE ═══
const firebaseConfig = {
  apiKey: "AIzaSyAQE9oQRDUmeX6ZPO2KOcfd1ctBqt6v34w",
  authDomain: "vendys-b1fea.firebaseapp.com",
  projectId: "vendys-b1fea",
  databaseURL: "https://vendys-b1fea-default-rtdb.firebaseio.com",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const ALLOWED_DOMAIN = "vendys.co.kr";

// ═══ STATE ═══
let SECTIONS = [];
let currentTab = 0, currentPageId = null;
const expandedNodes = new Set();
const pageCache = {};
const guideCache = {};
const searchIndex = [];
let mobileLnbOpen = false;

// ═══ MOBILE LNB ═══
function isMobile() { return window.innerWidth <= 768; }

function toggleMobileLnb() {
  mobileLnbOpen ? closeMobileLnb() : openMobileLnb();
}
function openMobileLnb() {
  mobileLnbOpen = true;
  document.getElementById('lnbAside').classList.add('mobile-open');
  document.getElementById('lnbBackdrop').classList.add('open');
}
function closeMobileLnb() {
  mobileLnbOpen = false;
  document.getElementById('lnbAside').classList.remove('mobile-open');
  document.getElementById('lnbBackdrop').classList.remove('open');
}

// ═══ AUTH ═══
function signIn() {
  const p = new firebase.auth.GoogleAuthProvider();
  p.setCustomParameters({ hd: ALLOWED_DOMAIN });
  auth.signInWithPopup(p).catch(e => {
    const el = document.getElementById("loginError");
    el.textContent = "로그인 실패: " + e.message; el.style.display = "block";
  });
}
function signOut() { auth.signOut(); }

auth.onAuthStateChanged(user => {
  document.getElementById("loading").style.display = "none";
  if (user) {
    if (user.email.split("@")[1] !== ALLOWED_DOMAIN) {
      auth.signOut();
      document.getElementById("loginScreen").style.display = "flex";
      const el = document.getElementById("loginError");
      el.textContent = "@vendys.co.kr 계정만 접근 가능합니다."; el.style.display = "block";
      return;
    }
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("gnb").classList.add("active");
    document.getElementById("mainLayout").classList.add("active");
    document.getElementById("gnbUsername").textContent = user.displayName || user.email.split("@")[0];
    document.getElementById("userEmail").textContent = user.email;
    if (user.photoURL) document.getElementById("gnbAvatar").innerHTML = '<img src="' + user.photoURL + '">';
    checkAdmin(user.email);
    loadSitemap();
  } else {
    document.getElementById("loginScreen").style.display = "flex";
    document.getElementById("gnb").classList.remove("active");
    document.getElementById("mainLayout").classList.remove("active");
  }
});

// ═══ MARKDOWN PARSER ═══
function parseMd(md) {
  var lines = md.split('\n');
  var html = [];
  var inCode = false, codeLang = '', codeLines = [];
  var inList = false, listType = '';
  var inTable = false, tableRows = [];

  function flushList() {
    if (!inList) return;
    html.push('</' + listType + '>');
    inList = false;
  }
  function flushTable() {
    if (!inTable) return;
    var hdr = tableRows[0];
    var body = tableRows.slice(2);
    var out = '<table><thead><tr>';
    hdr.forEach(function(c) { out += '<th>' + inlineMd(c.trim()) + '</th>'; });
    out += '</tr></thead><tbody>';
    body.forEach(function(row) {
      out += '<tr>';
      row.forEach(function(c) { out += '<td>' + inlineMd(c.trim()) + '</td>'; });
      out += '</tr>';
    });
    out += '</tbody></table>';
    html.push(out);
    inTable = false;
    tableRows = [];
  }

  function inlineMd(s) {
    s = s.replace(/`([^`]+)`/g, '<code>$1</code>');
    s = s.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
    s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');
    s = s.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color:var(--accent)">$1</a>');
    return s;
  }

  for (var i = 0; i < lines.length; i++) {
    var line = lines[i];
    if (line.match(/^```/)) {
      if (!inCode) {
        flushList(); flushTable();
        codeLang = line.replace(/^```/, '').trim();
        inCode = true; codeLines = [];
      } else {
        html.push('<pre><code>' + codeLines.join('\n').replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</code></pre>');
        inCode = false;
      }
      continue;
    }
    if (inCode) { codeLines.push(line); continue; }
    if (line.match(/^\|(.+)\|$/)) {
      flushList();
      var cells = line.slice(1, -1).split('|');
      if (!inTable) { inTable = true; tableRows = []; }
      tableRows.push(cells);
      continue;
    } else if (inTable) {
      flushTable();
    }
    if (line.trim() === '') { flushList(); continue; }
    var hm = line.match(/^(#{1,3})\s+(.+)/);
    if (hm) { flushList(); html.push('<h' + hm[1].length + '>' + inlineMd(hm[2]) + '</h' + hm[1].length + '>'); continue; }
    if (line.match(/^---+$/)) { flushList(); html.push('<hr>'); continue; }
    if (line.match(/^>\s?/)) { flushList(); html.push('<blockquote>' + inlineMd(line.replace(/^>\s?/, '')) + '</blockquote>'); continue; }
    var ulm = line.match(/^[\s]*[-*]\s+(.+)/);
    if (ulm) {
      if (!inList || listType !== 'ul') { flushList(); html.push('<ul>'); inList = true; listType = 'ul'; }
      html.push('<li>' + inlineMd(ulm[1]) + '</li>');
      continue;
    }
    var olm = line.match(/^[\s]*\d+\.\s+(.+)/);
    if (olm) {
      if (!inList || listType !== 'ol') { flushList(); html.push('<ol>'); inList = true; listType = 'ol'; }
      html.push('<li>' + inlineMd(olm[1]) + '</li>');
      continue;
    }
    flushList();
    html.push('<p>' + inlineMd(line) + '</p>');
  }
  if (inCode) html.push('<pre><code>' + codeLines.join('\n').replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</code></pre>');
  flushList();
  flushTable();
  return html.join('\n');
}

// ═══ GUIDE MODAL ═══
async function openGuide(guideFile, title) {
  var overlay = document.getElementById('guideOverlay');
  var body = document.getElementById('guideModalBody');
  document.getElementById('guideModalTitle').textContent = title + ' 가이드';
  overlay.classList.add('open');
  body.innerHTML = '<div class="guide-modal-loading"><div class="spinner"></div> 로딩 중...</div>';
  try {
    var md;
    if (guideCache[guideFile]) {
      md = guideCache[guideFile];
    } else {
      var res = await fetch(guideFile + '?t=' + Date.now());
      if (!res.ok) throw new Error(res.status);
      md = await res.text();
      guideCache[guideFile] = md;
    }
    body.innerHTML = parseMd(md);
  } catch (e) {
    body.innerHTML = '<p style="color:var(--danger);font-size:12px">가이드 문서를 불러올 수 없습니다: ' + guideFile + '</p>';
  }
}
function closeGuide() {
  document.getElementById('guideOverlay').classList.remove('open');
}

// ═══ SITEMAP LOADER ═══
async function loadSitemap() {
  try {
    const res = await fetch('sitemap.json?t=' + Date.now());
    const data = await res.json();
    SECTIONS = data.sections;
    buildSearchIndex(SECTIONS);
    renderGnbTabs();
    renderMobileTabs();

    var hash = window.location.hash.replace('#', '');
    if (hash) {
      var parts = hash.split('/');
      var tabIdx = parseInt(parts[0]) || 0;
      var pageId = parts[1] || null;
      if (tabIdx >= 0 && tabIdx < SECTIONS.length) {
        currentTab = tabIdx;
        renderGnbTabs();
        renderMobileTabs();
        document.getElementById("lnbTitle").textContent = SECTIONS[tabIdx].tab;
        renderTree();
        if (pageId && findInAll(pageId)) {
          navigateTo(pageId);
        } else {
          var first = SECTIONS[tabIdx].pages[0];
          if (first) navigateTo(first.id);
        }
      } else {
        switchTab(0);
      }
    } else {
      switchTab(0);
    }
  } catch (e) {
    document.getElementById("contentArea").innerHTML =
      '<div class="content-loading">sitemap.json을 불러올 수 없습니다.</div>';
  }
}

// ═══ PAGE LOADER ═══
async function loadPageContent(page) {
  if (!page.file) return page.body || "";
  if (pageCache[page.id]) return pageCache[page.id];
  try {
    const res = await fetch(page.file + '?t=' + Date.now());
    if (!res.ok) throw new Error(res.status);
    let html = await res.text();
    const metaMatch = html.match(/<!--\s*([\s\S]*?)-->/);
    if (metaMatch) {
      const metaBlock = metaMatch[1];
      const metaLine = metaBlock.match(/meta:\s*(.+)/);
      if (metaLine) page._meta = metaLine[1].trim();
      html = html.replace(metaMatch[0], '').trim();
    }
    pageCache[page.id] = html;
    return html;
  } catch (e) {
    return '<p style="color:var(--danger)">문서를 불러올 수 없습니다: ' + page.file + '</p>';
  }
}

// ═══ SCRIPT EXECUTOR ═══
function executeScripts(container) {
  var scripts = container.querySelectorAll('script');
  for (var i = 0; i < scripts.length; i++) {
    var oldScript = scripts[i];
    var newScript = document.createElement('script');
    if (oldScript.src) {
      newScript.src = oldScript.src;
    } else {
      newScript.textContent = oldScript.textContent;
    }
    oldScript.parentNode.replaceChild(newScript, oldScript);
  }
}

// ═══ SEARCH INDEX ═══
function buildSearchIndex(sections) {
  searchIndex.length = 0;
  for (const s of sections) {
    indexPages(s.pages, []);
  }
}
function indexPages(pages, trail) {
  for (const p of pages) {
    searchIndex.push({
      id: p.id, title: p.title, desc: p.desc || "",
      path: [...trail, p.title].join(" > "),
    });
    if (p.children) indexPages(p.children, [...trail, p.title]);
  }
}

// ═══ GNB TABS ═══
function renderGnbTabs() {
  document.getElementById("gnbTabs").innerHTML = SECTIONS.map((s, i) =>
    '<div class="gnb-tab' + (i===currentTab?' active':'') + '" onclick="switchTab(' + i + ')">' + s.tab + '</div>'
  ).join("");
}

// ═══ MOBILE TABS (inside LNB) ═══
function renderMobileTabs() {
  document.getElementById("lnbMobileTabs").innerHTML = SECTIONS.map((s, i) =>
    '<div class="lnb-mobile-tab' + (i===currentTab?' active':'') + '" onclick="switchTab(' + i + ')">' + s.tab + '</div>'
  ).join("");
}

function switchTab(idx) {
  currentTab = idx;
  renderGnbTabs();
  renderMobileTabs();
  document.getElementById("lnbTitle").textContent = SECTIONS[idx].tab;
  renderTree();
  const first = SECTIONS[idx].pages[0];
  if (first) navigateTo(first.id);
}

// ═══ TREE ═══
const ICONS = {
  folder:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>',
  doc:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
  api:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>',
  db:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>',
};

function renderTree() {
  document.getElementById("lnbTree").innerHTML = SECTIONS[currentTab].pages.map(p => treeNode(p)).join("");
}
function treeNode(page) {
  const has = page.children && page.children.length > 0;
  const exp = expandedNodes.has(page.id);
  const act = currentPageId === page.id;
  return '<div>' +
    '<div class="tree-row' + (act?' active':'') + '" onclick="onTreeClick(\'' + page.id + '\')">' +
      '<span class="tree-toggle ' + (has?(exp?'expanded':''):'hidden') + '" onclick="event.stopPropagation();toggleNode(\'' + page.id + '\')">' +
        '<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5l10 7-10 7z"/></svg>' +
      '</span>' +
      '<span class="tree-icon">' + (ICONS[page.icon]||ICONS.doc) + '</span>' +
      '<span class="tree-label">' + page.title + '</span>' +
    '</div>' +
    (has ? '<div class="tree-children' + (exp?' open':'') + '">' + page.children.map(c => treeNode(c)).join("") + '</div>' : '') +
  '</div>';
}
function toggleNode(id){expandedNodes.has(id)?expandedNodes.delete(id):expandedNodes.add(id);renderTree()}

// Tree click: navigate + close LNB on mobile
function onTreeClick(id) {
  navigateTo(id);
  if (isMobile()) closeMobileLnb();
}

// ═══ FIND / PATH ═══
function findPage(id,pages){for(const p of pages){if(p.id===id)return p;if(p.children){const f=findPage(id,p.children);if(f)return f}}return null}
function findInAll(id){for(const s of SECTIONS){const f=findPage(id,s.pages);if(f)return f}return null}
function getPath(id,pages,trail){trail=trail||[];for(const p of pages){if(p.id===id)return trail.concat([p]);if(p.children){const r=getPath(id,p.children,trail.concat([p]));if(r)return r}}return null}
function getFullPath(id){for(const s of SECTIONS){const p=getPath(id,s.pages);if(p)return p}return[]}

// ═══ NAVIGATE ═══
async function navigateTo(id) {
  currentPageId = id;
  const page = findInAll(id);
  if (!page) return;
  const path = getFullPath(id);
  path.forEach(p => expandedNodes.add(p.id));
  renderTree();

  window.location.hash = currentTab + '/' + id;

  const el = document.getElementById("contentArea");
  el.innerHTML = '<div class="content-loading"><div class="spinner"></div> 로딩 중...</div>';

  const body = await loadPageContent(page);
  const meta = page._meta || page.meta || "";

  const bc = path.map((p,i) => i===path.length-1
    ? '<span class="breadcrumb-item current">' + p.title + '</span>'
    : '<span class="breadcrumb-item" onclick="navigateTo(\'' + p.id + '\')">' + p.title + '</span><span class="breadcrumb-sep">/</span>'
  ).join("");

  let childHtml = "";
  if (page.children && page.children.length) {
    childHtml = '<div class="child-pages">' + page.children.map(c =>
      '<div class="child-page-card" onclick="navigateTo(\'' + c.id + '\')">' +
        '<div class="child-page-card-title">' + c.title + '</div>' +
        (c.desc ? '<div class="child-page-card-desc">' + c.desc + '</div>' : "") +
      '</div>'
    ).join("") + '</div>';
  }

  var guideBtn = '';
  if (page.guide) {
    guideBtn = ' <button class="guide-btn" onclick="openGuide(\'' + page.guide + '\',\'' + page.title.replace(/'/g,"\\'") + '\')" title="페이지 가이드">?</button>';
  }

  el.innerHTML = '<div class="breadcrumb" style="margin-bottom:6px">' + bc + guideBtn + '</div>' +
    '<div class="doc-body">' + body + childHtml + '</div>';
  el.scrollTop = 0;

  executeScripts(el);

  const idx = searchIndex.find(x => x.id === id);
  if (idx && !idx.text) idx.text = body.replace(/<[^>]*>/g, " ");
}

// ═══ SEARCH ═══
const searchInput = document.getElementById("searchInput");
const searchResults = document.getElementById("searchResults");

searchInput.addEventListener("input", () => {
  const q = searchInput.value.trim().toLowerCase();
  if (!q) { searchResults.classList.remove("open"); return; }
  const matches = searchIndex.filter(p =>
    p.title.toLowerCase().includes(q) ||
    (p.text||"").toLowerCase().includes(q) ||
    p.desc.toLowerCase().includes(q)
  ).slice(0, 8);

  if (!matches.length) {
    searchResults.innerHTML = '<div class="search-empty">검색 결과가 없습니다</div>';
  } else {
    searchResults.innerHTML = matches.map(m => {
      let snippet = "";
      const text = m.text || "";
      const idx = text.toLowerCase().indexOf(q);
      if (idx >= 0) {
        const raw = text.slice(Math.max(0,idx-20), idx+q.length+40).trim();
        snippet = raw.replace(new RegExp('(' + q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + ')','gi'), '<mark>$1</mark>');
      }
      return '<div class="search-result-item" onclick="searchGo(\'' + m.id + '\')">' +
        '<div class="search-result-title">' + m.title + '</div>' +
        '<div class="search-result-path">' + m.path + '</div>' +
        (snippet ? '<div class="search-result-snippet">' + snippet + '</div>' : "") +
      '</div>';
    }).join("");
  }
  searchResults.classList.add("open");
});

function searchGo(id) {
  searchInput.value = ""; searchResults.classList.remove("open");
  for (let i=0;i<SECTIONS.length;i++){if(findPage(id,SECTIONS[i].pages)){currentTab=i;renderGnbTabs();renderMobileTabs();document.getElementById("lnbTitle").textContent=SECTIONS[i].tab;renderTree();break}}
  navigateTo(id);
  if (isMobile()) closeMobileLnb();
}

document.addEventListener("click", e => {
  if(!e.target.closest(".search-box")) searchResults.classList.remove("open");
  if(!e.target.closest(".gnb-user")) document.getElementById("userMenu").classList.remove("open");
});
document.addEventListener("keydown", e => {
  if(e.key==="/"&&document.activeElement!==searchInput){e.preventDefault();searchInput.focus()}
  if(e.key==="Escape"){
    searchInput.blur();searchResults.classList.remove("open");
    closeGuide();
    closeSitemapEditor();
    if (mobileLnbOpen) closeMobileLnb();
  }
});
function toggleUserMenu(){document.getElementById("userMenu").classList.toggle("open")}

// ═══ ADMIN CHECK ═══
const ADMIN_EMAIL = 'bogeun@vendys.co.kr';
function checkAdmin(email) {
  var btn = document.getElementById('gnbAdminBtn');
  if (btn) btn.style.display = (email === ADMIN_EMAIL) ? 'flex' : 'none';
}

// ═══ SITEMAP EDITOR ═══
var SME = {
  data: null,        // deep copy of SECTIONS for editing
  selTab: 0,         // selected tab index
  selPath: null,     // path to selected node: [tabIdx, pageIdx, childIdx, ...]
  expanded: new Set() // expanded node ids in editor
};

function openSitemapEditor() {
  SME.data = JSON.parse(JSON.stringify(SECTIONS));
  SME.selTab = 0;
  SME.selPath = null;
  SME.expanded = new Set();
  document.getElementById('smeOverlay').classList.add('open');
  smeRenderTabs();
  smeRenderTree();
  smeRenderEdit();
}
function closeSitemapEditor() {
  document.getElementById('smeOverlay').classList.remove('open');
}

// Tab bar
function smeRenderTabs() {
  var html = SME.data.map(function(s, i) {
    return '<div class="sme-tab' + (i===SME.selTab?' active':'') + '" onclick="smeSelectTab(' + i + ')">' + s.tab + '</div>';
  }).join('');
  document.getElementById('smeTabBar').innerHTML = html;
}
function smeSelectTab(i) {
  SME.selTab = i;
  SME.selPath = null;
  smeRenderTabs();
  smeRenderTree();
  smeRenderEdit();
}

// Tree rendering
function smeRenderTree() {
  var section = SME.data[SME.selTab];
  if (!section) { document.getElementById('smeTreeList').innerHTML = ''; return; }
  var html = section.pages.map(function(p, i) {
    return smeTreeNode(p, [i], 0);
  }).join('');
  document.getElementById('smeTreeList').innerHTML = html;
}

function smeTreeNode(page, path, depth) {
  var pathStr = JSON.stringify(path);
  var has = page.children && page.children.length > 0;
  var isFolder = page.icon === 'folder' || has;
  var exp = SME.expanded.has(page.id);
  var sel = SME.selPath && JSON.stringify(SME.selPath) === pathStr;
  var idx = path[path.length - 1];
  var parentLen = smeGetSiblings(path).length;

  var toggleCls = has ? (exp ? 'sme-node-toggle expanded' : 'sme-node-toggle') : 'sme-node-toggle hidden';
  var iconTxt = isFolder ? 'D' : 'F';

  var actions = '';
  // move up
  if (idx > 0) actions += '<button class="sme-node-act" onclick="event.stopPropagation();smeMove(' + pathStr + ',-1)" title="위로">&#8593;</button>';
  // move down
  if (idx < parentLen - 1) actions += '<button class="sme-node-act" onclick="event.stopPropagation();smeMove(' + pathStr + ',1)" title="아래로">&#8595;</button>';
  // delete
  actions += '<button class="sme-node-act" onclick="event.stopPropagation();smeDelete(' + pathStr + ')" title="삭제" style="color:var(--danger)">&#10005;</button>';

  var html = '<div class="sme-node" style="padding-left:' + (depth * 0) + 'px">' +
    '<div class="sme-node-row' + (sel?' selected':'') + '" onclick="smeSelect(' + pathStr + ')">' +
      '<span class="' + toggleCls + '" onclick="event.stopPropagation();smeToggleExp(\'' + page.id + '\')">' +
        '<svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5l10 7-10 7z"/></svg>' +
      '</span>' +
      '<span class="sme-node-icon">' + iconTxt + '</span>' +
      '<span class="sme-node-label">' + (page.title || page.id) + '</span>' +
      '<span class="sme-node-actions">' + actions + '</span>' +
    '</div>';

  if (has && exp) {
    html += '<div class="sme-node-children">';
    html += page.children.map(function(c, ci) {
      return smeTreeNode(c, path.concat([ci]), depth + 1);
    }).join('');
    html += '</div>';
  }
  html += '</div>';
  return html;
}

function smeToggleExp(id) {
  SME.expanded.has(id) ? SME.expanded.delete(id) : SME.expanded.add(id);
  smeRenderTree();
}

function smeGetNode(path) {
  var pages = SME.data[SME.selTab].pages;
  var node = pages[path[0]];
  for (var i = 1; i < path.length; i++) {
    if (!node.children) return null;
    node = node.children[path[i]];
  }
  return node;
}

function smeGetSiblings(path) {
  if (path.length === 1) return SME.data[SME.selTab].pages;
  var parentPath = path.slice(0, -1);
  var parent = smeGetNode(parentPath);
  return parent.children || [];
}

function smeGetSiblingsArray(path) {
  if (path.length === 1) return SME.data[SME.selTab].pages;
  var parentPath = path.slice(0, -1);
  var parent = smeGetNode(parentPath);
  return parent.children;
}

// Select node
function smeSelect(path) {
  SME.selPath = path;
  smeRenderTree();
  smeRenderEdit();
}

// Edit panel
function smeRenderEdit() {
  var body = document.getElementById('smeEditBody');
  var header = document.getElementById('smeEditHeader');

  if (!SME.selPath) {
    header.textContent = '속성';
    body.innerHTML = '<div class="sme-edit-empty">항목을 선택하세요</div>';
    return;
  }

  var node = smeGetNode(SME.selPath);
  if (!node) { body.innerHTML = '<div class="sme-edit-empty">노드를 찾을 수 없습니다</div>'; return; }

  header.textContent = node.title || node.id;

  var isFolder = node.icon === 'folder' || (node.children && node.children.length > 0);

  body.innerHTML =
    '<div class="sme-field-row">' +
      '<div class="sme-field"><label>ID</label><input id="smeFieldId" value="' + esc(node.id||'') + '" onchange="smeUpdateField(\'id\',this.value)"><div class="sme-field-hint">고유 식별자 (영문, 하이픈)</div></div>' +
      '<div class="sme-field"><label>아이콘</label><select id="smeFieldIcon" onchange="smeUpdateField(\'icon\',this.value)">' +
        '<option value="doc"' + (node.icon==='doc'?' selected':'') + '>doc</option>' +
        '<option value="folder"' + (node.icon==='folder'?' selected':'') + '>folder</option>' +
        '<option value="api"' + (node.icon==='api'?' selected':'') + '>api</option>' +
        '<option value="db"' + (node.icon==='db'?' selected':'') + '>db</option>' +
      '</select></div>' +
    '</div>' +
    '<div class="sme-field"><label>제목</label><input id="smeFieldTitle" value="' + esc(node.title||'') + '" onchange="smeUpdateField(\'title\',this.value)"></div>' +
    '<div class="sme-field"><label>설명</label><input id="smeFieldDesc" value="' + esc(node.desc||'') + '" onchange="smeUpdateField(\'desc\',this.value)"></div>' +
    '<div class="sme-field"><label>파일 경로</label><input id="smeFieldFile" value="' + esc(node.file||'') + '" onchange="smeUpdateField(\'file\',this.value)">' +
      '<div class="sme-field-hint">docs/ops/example.html</div></div>' +
    '<div class="sme-field"><label>가이드 파일</label><input id="smeFieldGuide" value="' + esc(node.guide||'') + '" onchange="smeUpdateField(\'guide\',this.value)">' +
      '<div class="sme-field-hint">docs/guides/example.md (선택사항)</div></div>' +
    (isFolder ? '<div style="margin-top:12px;padding-top:8px;border-top:1px solid var(--border-subtle)">' +
      '<button class="sme-btn" onclick="smeAddChild()">+ 하위 페이지 추가</button></div>' : '');
}

function esc(s) { return s.replace(/"/g, '&quot;').replace(/</g, '&lt;'); }

function smeUpdateField(field, val) {
  var node = smeGetNode(SME.selPath);
  if (!node) return;
  if (val.trim() === '' && (field === 'file' || field === 'guide' || field === 'desc')) {
    delete node[field];
  } else {
    node[field] = val;
  }
  smeRenderTree();
  // keep header in sync
  document.getElementById('smeEditHeader').textContent = node.title || node.id;
}

// Add page (at root level of current tab)
function smeAddPage() {
  var id = 'new-page-' + Date.now().toString(36);
  SME.data[SME.selTab].pages.push({
    id: id, title: '새 페이지', icon: 'doc', desc: '', file: ''
  });
  var idx = SME.data[SME.selTab].pages.length - 1;
  SME.selPath = [idx];
  smeRenderTree();
  smeRenderEdit();
}

// Add folder (at root level)
function smeAddFolder() {
  var id = 'new-folder-' + Date.now().toString(36);
  SME.data[SME.selTab].pages.push({
    id: id, title: '새 폴더', icon: 'folder', desc: '', children: []
  });
  var idx = SME.data[SME.selTab].pages.length - 1;
  SME.selPath = [idx];
  SME.expanded.add(id);
  smeRenderTree();
  smeRenderEdit();
}

// Add child to selected folder
function smeAddChild() {
  var node = smeGetNode(SME.selPath);
  if (!node) return;
  if (!node.children) node.children = [];
  var id = 'new-child-' + Date.now().toString(36);
  node.children.push({ id: id, title: '새 페이지', icon: 'doc', desc: '', file: '' });
  SME.expanded.add(node.id);
  var ci = node.children.length - 1;
  SME.selPath = SME.selPath.concat([ci]);
  smeRenderTree();
  smeRenderEdit();
}

// Add tab
function smeAddTab() {
  var name = prompt('새 탭 이름:');
  if (!name || !name.trim()) return;
  SME.data.push({ tab: name.trim(), pages: [] });
  SME.selTab = SME.data.length - 1;
  SME.selPath = null;
  smeRenderTabs();
  smeRenderTree();
  smeRenderEdit();
}

// Move node up/down
function smeMove(path, dir) {
  var arr = smeGetSiblingsArray(path);
  var idx = path[path.length - 1];
  var newIdx = idx + dir;
  if (newIdx < 0 || newIdx >= arr.length) return;
  var tmp = arr[idx];
  arr[idx] = arr[newIdx];
  arr[newIdx] = tmp;
  // update selPath
  var newPath = path.slice();
  newPath[newPath.length - 1] = newIdx;
  SME.selPath = newPath;
  smeRenderTree();
  smeRenderEdit();
}

// Delete node
function smeDelete(path) {
  var node = smeGetNode(path);
  var label = node ? node.title : '';
  if (!confirm('"' + label + '" 항목을 삭제하시겠습니까?' + (node && node.children && node.children.length ? '\n(하위 ' + node.children.length + '개 항목도 함께 삭제됩니다)' : ''))) return;
  var arr = smeGetSiblingsArray(path);
  var idx = path[path.length - 1];
  arr.splice(idx, 1);
  SME.selPath = null;
  smeRenderTree();
  smeRenderEdit();
}

// Generate JSON
function smeGenerateJson() {
  // Clean up: remove empty fields, _meta etc
  var clean = JSON.parse(JSON.stringify(SME.data));
  function cleanNode(n) {
    var obj = { id: n.id, title: n.title, icon: n.icon || 'doc' };
    if (n.desc) obj.desc = n.desc;
    if (n.file) obj.file = n.file;
    if (n.guide) obj.guide = n.guide;
    if (n.children && n.children.length) {
      obj.children = n.children.map(cleanNode);
    }
    return obj;
  }
  var output = {
    sections: clean.map(function(s) {
      return { tab: s.tab, pages: s.pages.map(cleanNode) };
    })
  };
  return JSON.stringify(output, null, 2);
}

function smePreviewJson() {
  var json = smeGenerateJson();
  var w = window.open('', '_blank', 'width=600,height=500');
  w.document.write('<pre style="font-family:JetBrains Mono,monospace;font-size:12px;padding:16px;white-space:pre-wrap;word-break:break-all">' + json.replace(/</g,'&lt;') + '</pre>');
}

function smeCopyJson() {
  var json = smeGenerateJson();
  navigator.clipboard.writeText(json).then(function() {
    var el = document.getElementById('smeCopyFeedback');
    el.classList.add('show');
    setTimeout(function() { el.classList.remove('show'); }, 1500);
  });
}

// Apply live: update SECTIONS in memory (no persistence)
function smeApplyLive() {
  var json = smeGenerateJson();
  var data = JSON.parse(json);
  SECTIONS = data.sections;
  buildSearchIndex(SECTIONS);
  renderGnbTabs();
  renderMobileTabs();
  renderTree();
  closeSitemapEditor();
  // navigate to first page of current tab
  if (SECTIONS[currentTab] && SECTIONS[currentTab].pages[0]) {
    navigateTo(SECTIONS[currentTab].pages[0].id);
  }
}
</script>
</body>
</html>
