<!--
title: 매출통계 대시보드
meta: 최종 수정: 2026.02.17
-->

<style>
.sl{font-family:'Noto Sans KR',sans-serif;font-size:12px;color:#1a2332;position:relative;min-height:400px}
.sl *{box-sizing:border-box}
.sl-ctrl{display:flex;align-items:center;gap:6px;padding:8px 0;border-bottom:1px solid #e2e8f0;flex-wrap:wrap}
.sl-ctrl label{font-size:11px;color:#94a3b8}
.sl-ctrl select{height:28px;border:1px solid #d1d5db;border-radius:3px;font-size:12px;padding:0 6px;font-family:'JetBrains Mono',monospace;min-width:72px}
.sl-btn{height:28px;padding:0 10px;border:1px solid #d1d5db;border-radius:3px;background:#fff;font-size:11px;cursor:pointer;color:#4a5568;white-space:nowrap}
.sl-btn:hover{background:#f0f4f9}
.sl-btn--hot{border-color:#4a90d9;color:#4a90d9}
.sl-btn--hot.active{background:#4a90d9;color:#fff}
.sl-btn--go{background:#4a90d9;color:#fff;border-color:#4a90d9;font-weight:600}
.sl-btn--go:hover{background:#3a7bc8}
.sl-status{margin-left:auto;font-size:11px;color:#94a3b8}
.sl-sep{width:1px;height:20px;background:#e2e8f0;margin:0 2px}
.sl-load{position:absolute;inset:0;background:rgba(255,255,255,.92);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100}
.sl-load.hide{display:none}
.sl-load__bar{width:200px;height:4px;background:#e2e8f0;border-radius:2px;overflow:hidden}
.sl-load__fill{height:100%;background:#4a90d9;border-radius:2px;transition:width .3s}
.sl-load__txt{font-size:11px;color:#94a3b8;margin-top:6px}
.sl-tabs{display:flex;gap:0;border-bottom:2px solid #e2e8f0;margin-top:8px}
.sl-tab{padding:6px 14px;font-size:12px;color:#94a3b8;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;font-weight:500;white-space:nowrap}
.sl-tab:hover{color:#4a5568}
.sl-tab.active{color:#4a90d9;border-bottom-color:#4a90d9;font-weight:600}
.sl-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;margin:10px 0}
.sl-card{background:#f8fafd;border:1px solid #e2e8f0;border-radius:4px;padding:8px 10px}
.sl-card__lbl{font-size:10px;color:#94a3b8;margin-bottom:2px}
.sl-card__val{font-size:15px;font-weight:700;font-family:'JetBrains Mono',monospace;color:#1a2332}
.sl-card__chg{font-size:10px;font-family:'JetBrains Mono',monospace;margin-top:1px}
.up{color:#22c55e}.down{color:#e85d5d}.flat{color:#94a3b8}
.sl-cw{background:#f8fafd;border:1px solid #e2e8f0;border-radius:4px;padding:10px;margin:8px 0}
.sl-cw__t{font-size:11px;font-weight:600;color:#4a5568;margin-bottom:6px}
.sl-chart{width:100%;height:160px;display:flex;align-items:flex-end;gap:1px}
.sl-chart--tall{height:220px}
.sl-chart-col{flex:1;display:flex;gap:1px;align-items:flex-end;height:100%}
.sl-chart-bar{flex:1;border-radius:2px 2px 0 0;position:relative;cursor:pointer;transition:opacity .15s;min-height:2px}
.sl-chart-bar:hover{opacity:.75}
.sl-chart-tip{position:absolute;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%);background:#1a2332;color:#fff;padding:2px 6px;border-radius:3px;font-size:10px;white-space:nowrap;display:none;z-index:10;font-family:'JetBrains Mono',monospace}
.sl-chart-bar:hover .sl-chart-tip{display:block}
.sl-chart-labels{display:flex;gap:1px;margin-top:3px}
.sl-chart-labels span{flex:1;text-align:center;font-size:9px;color:#94a3b8}
.sl-legend{display:flex;gap:12px;margin-top:4px;font-size:10px;color:#94a3b8;flex-wrap:wrap}
.sl-legend i{display:inline-block;width:8px;height:8px;border-radius:1px;margin-right:3px;vertical-align:middle}
.sl-grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:8px 0}
.sl-grid4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin:8px 0}
.sl-panel{border:1px solid #e2e8f0;border-radius:4px;overflow:hidden;display:flex;flex-direction:column}
.sl-panel__head{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;background:#f8fafd;border-bottom:1px solid #e2e8f0;gap:4px}
.sl-panel__title{font-size:11px;font-weight:600;color:#4a5568;white-space:nowrap}
.sl-search{height:24px;border:1px solid #d1d5db;border-radius:3px;font-size:11px;padding:0 6px;width:140px}
.sl-copy-btn{height:24px;padding:0 8px;border:1px solid #d1d5db;border-radius:3px;background:#fff;font-size:10px;cursor:pointer;color:#4a5568}
.sl-copy-btn:hover{background:#f0f4f9}
.sl-copy-btn.copied{background:#22c55e;color:#fff;border-color:#22c55e}
.sl-tw{overflow:auto;flex:1;max-height:420px}
.sl-t{width:100%;border-collapse:collapse;font-size:11px}
.sl-t thead{position:sticky;top:0;z-index:5}
.sl-t th{background:#f0f4f9;padding:4px 6px;text-align:left;font-weight:600;color:#4a5568;border-bottom:1px solid #d1d5db;cursor:pointer;white-space:nowrap;font-size:10px;user-select:none}
.sl-t th:hover{background:#e2e8f0}
.sl-t th.r,.sl-t td.r{text-align:right;font-family:'JetBrains Mono',monospace}
.sl-t th .a{font-size:8px;margin-left:2px;color:#94a3b8}
.sl-t th.s .a{color:#4a90d9}
.sl-t td{padding:4px 6px;border-bottom:1px solid #f0f4f9;white-space:nowrap}
.sl-t td.id{font-size:9px;color:#94a3b8;font-family:'JetBrains Mono',monospace;max-width:80px;overflow:hidden;text-overflow:ellipsis}
.sl-t tr:hover{background:#f8fafd}
.sl-t tr.sel{background:#eef4fb}
.sl-t tr{cursor:pointer}
.sl-t--s th{cursor:default}.sl-t--s th:hover{background:#f0f4f9}
.sl-det{padding:8px;font-size:11px;overflow:auto;max-height:420px}
.sl-det__empty{color:#94a3b8;text-align:center;padding:40px 0}
.sl-det__name{font-size:14px;font-weight:700;margin-bottom:1px}
.sl-det__meta{font-size:10px;color:#94a3b8;margin-bottom:8px;word-break:break-all}
.sl-det__grid{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:8px}
.sl-det__item{background:#f8fafd;padding:4px 8px;border-radius:3px}
.sl-det__il{font-size:9px;color:#94a3b8}
.sl-det__iv{font-size:13px;font-weight:600;font-family:'JetBrains Mono',monospace}
.sl-det__sec{font-size:11px;font-weight:600;color:#4a5568;margin:6px 0 4px;padding-bottom:2px;border-bottom:1px solid #e2e8f0}
.sl-mt{width:100%;border-collapse:collapse;font-size:10px}
.sl-mt th{background:#f0f4f9;padding:3px 6px;text-align:left;font-weight:600;color:#4a5568;border-bottom:1px solid #d1d5db}
.sl-mt th.r,.sl-mt td.r{text-align:right;font-family:'JetBrains Mono',monospace}
.sl-mt td{padding:3px 6px;border-bottom:1px solid #f0f4f9}
.sl-pivot-wrap{overflow:auto;margin:8px 0}
.sl-pivot{border-collapse:collapse;font-size:11px;width:100%}
.sl-pivot th,.sl-pivot td{padding:4px 8px;border:1px solid #e2e8f0;white-space:nowrap}
.sl-pivot th{background:#f0f4f9;font-weight:600;color:#4a5568;font-size:10px;position:sticky;top:0;z-index:2}
.sl-pivot td.r{text-align:right;font-family:'JetBrains Mono',monospace}
.sl-pivot tr:hover{background:#f8fafd}
.sl-pivot .yh{background:#eef4fb;font-weight:600}
.sl-pivot .st{background:#f0f4f9;font-weight:600}
.sl-pane{display:none}.sl-pane.active{display:block}
@media(max-width:1200px){.sl-grid4{grid-template-columns:1fr 1fr}}
@media(max-width:900px){.sl-grid2{grid-template-columns:1fr}.sl-grid4{grid-template-columns:1fr}}
</style>

<div class="sl" id="slRoot">
  <div class="sl-load hide" id="slLoad"><div class="sl-load__bar"><div class="sl-load__fill" id="slFill" style="width:0%"></div></div><div class="sl-load__txt" id="slTxt">로딩 중...</div></div>
  <div class="sl-ctrl">
    <label>기간</label>
    <select id="slMode" onchange="slMC()"><option value="month">월별</option><option value="year">연간</option></select>
    <select id="slYear"></select><select id="slMonth"></select>
    <button class="sl-btn sl-btn--go" onclick="slFetch()">조회</button><div class="sl-sep"></div>
    <button class="sl-btn sl-btn--hot" onclick="slHot('tm',this)">이번달</button>
    <button class="sl-btn sl-btn--hot" onclick="slHot('lm',this)">지난달</button>
    <button class="sl-btn sl-btn--hot" onclick="slHot('2m',this)">지지난달</button>
    <button class="sl-btn sl-btn--hot" onclick="slHot('ty',this)">올해</button>
    <button class="sl-btn sl-btn--hot" onclick="slHot('ly',this)">작년</button>
    <div class="sl-status" id="slStat"></div>
  </div>
  <div class="sl-tabs">
    <div class="sl-tab active" onclick="slTab('svc',this)">서비스 통계</div>
    <div class="sl-tab" onclick="slTab('com',this)">고객사 통계</div>
    <div class="sl-tab" onclick="slTab('shop',this)">제휴점 통계</div>
    <div class="sl-tab" onclick="slTab('fee',this)">수수료 통계</div>
    <div class="sl-tab" onclick="slTab('tx',this)">거래액 통계</div>
    <div class="sl-tab" onclick="slTab('area',this)">지역별 통계</div>
    <div class="sl-tab" onclick="slTab('y5',this)">최근5년 흐름도</div>
  </div>
  <div id="slBody" style="display:none">
    <div class="sl-pane active" id="pSvc"></div><div class="sl-pane" id="pCom"></div>
    <div class="sl-pane" id="pShop"></div><div class="sl-pane" id="pFee"></div>
    <div class="sl-pane" id="pTx"></div><div class="sl-pane" id="pArea"></div><div class="sl-pane" id="pY5"></div>
  </div>
  <div id="slEmpty" style="display:none;text-align:center;padding:60px 0;color:#94a3b8">조회 버튼을 눌러주세요</div>
</div>

<script>
var SL={BASE:'/planvendys/data/stats-',cache:{},raw:[],prevRaw:[],lastRaw:[],mode:'month',qY:2025,qM:0,curTab:'svc',comSort:'txAmt',comDir:'desc',comSel:null,shopSort:'tx',shopDir:'desc',shopSel:null,areaSel:null,_y5:false};
var SLC=['#4a90d9','#22c55e','#d49a2a','#e85d5d','#8b5cf6','#06b6d4','#f59e0b','#ec4899','#10b981','#6366f1'];

/* 컬럼명 매핑 (새 구조) */
var F={
    date:'날짜',comId:'고객사 ID',comName:'고객사명',comGroup:'고객사 그룹',
    shopId:'제휴점 ID',shopName:'제휴점명',shopGroup:'제휴점 그룹',shopType:'제휴점 유형',
    settleUnit:'정산단위',feeRate:'수수료율',
    solo:'혼자결제',together:'함께결제',normal:'정상거래',cancel:'취소거래',admin:'관리자입력',
    txTotal:'거래 통계 합계',orderCnt:'주문 수',userCnt:'고유 사용자 수',
    salePrice:'판매가격',sales:'판매가격',mealPt:'식대/복지 포인트',ptUnit:'포인트 단위',
    daejangPt:'대장포인트',daejangCp:'대장쿠폰',easyPay:'간편결제',ptSum:'포인트 사용 합계',
    bill:'고객사 청구 금액',settle:'제휴점 정산 금액',shopFee:'제휴점 수수료 금액',
    txAmt:'거래액',delivery:'배송비',
    comSido:'고객사 시/도',comSigungu:'고객사 시/군/구',comDong:'고객사 동/면',
    shopSido:'제휴점 시/도',shopSigungu:'제휴점 시/군/구',shopDong:'제휴점 동/면'
};

function slN(v){v=Number(v)||0;if(!v)return'0';return(v<0?'-':'')+Math.abs(v).toLocaleString()}
function slS(v){v=Number(v)||0;var p=v<0?'-':'',a=Math.abs(v);if(a>=1e8)return p+(a/1e8).toFixed(1)+'억';if(a>=1e4)return p+Math.round(a/1e4)+'만';return p+a.toLocaleString()}
function slD(v){v=Number(v)||0;if(!v)return'-';return(v>0?'+':'')+slN(v)}
function slPct(c,p){c=Number(c)||0;p=Number(p)||0;if(!p)return c?'NEW':'-';var r=((c-p)/Math.abs(p)*100).toFixed(1);return(c-p>0?'+':'')+r+'%'}
function slNum(v){if(v==null||v==='')return 0;return Number(String(v).replace(/,/g,''))||0}
function $(id){return document.getElementById(id)}
function R(r,f){return r[F[f]]||r[f]||''}
function RN(r,f){return slNum(R(r,f))}

function slYM(s){if(!s)return'';s=String(s).trim();
    var m=s.match(/^(\d{4})-(\d{2})/);if(m)return m[1]+'-'+m[2];
    var m2=s.match(/^(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})$/);if(m2)return m2[1]+'-'+('0'+m2[2]).slice(-2);
    return''}

async function slInit(){
    var now=new Date(),y=now.getFullYear(),m=now.getMonth();
    var sy=$('slYear'),sm=$('slMonth');
    for(var i=2020;i<=y;i++){var o=document.createElement('option');o.value=i;o.textContent=i+'년';sy.appendChild(o)}
    for(var j=0;j<12;j++){var o2=document.createElement('option');o2.value=j;o2.textContent=(j+1)+'월';sm.appendChild(o2)}
    var iy=y;try{var t=await fetch(SL.BASE+y+'.csv',{method:'HEAD'});if(!t.ok)iy=y-1}catch(e){iy=y-1}
    /* 기본: 지난달 */
    var defM=m-1,defY=iy;
    if(defM<0){defM=11;defY=iy-1}
    sy.value=defY;sm.value=defM;slFetch();
}
slInit();

function slMC(){SL.mode=$('slMode').value;$('slMonth').style.display=SL.mode==='year'?'none':''}

function slHot(k,el){
    var now=new Date(),y=now.getFullYear(),m=now.getMonth();
    document.querySelectorAll('.sl-btn--hot').forEach(function(b){b.classList.remove('active')});
    if(el)el.classList.add('active');var md='month';
    switch(k){
        case'tm':SL.qY=y;SL.qM=m;break;case'lm':var d=new Date(y,m-1,1);SL.qY=d.getFullYear();SL.qM=d.getMonth();break;
        case'2m':var d2=new Date(y,m-2,1);SL.qY=d2.getFullYear();SL.qM=d2.getMonth();break;
        case'ty':SL.qY=y;md='year';break;case'ly':SL.qY=y-1;md='year';break;
    }
    SL.mode=md;$('slMode').value=md;$('slYear').value=SL.qY;
    if(md==='month')$('slMonth').value=SL.qM;slMC();slFetch();
}

function slSh(p,t){$('slLoad').classList.remove('hide');$('slFill').style.width=p+'%';$('slTxt').textContent=t}
function slHd(){$('slLoad').classList.add('hide')}

async function slCSV(year){
    if(SL.cache[year])return SL.cache[year];
    var r=await fetch(SL.BASE+year+'.csv');if(!r.ok)return[];
    var txt=await r.text();var lines=txt.split('\n');if(lines.length<2)return[];
    var sep=lines[0].indexOf('\t')>=0?'\t':',';
    var hdr=lines[0].split(sep).map(function(h){return h.trim().replace(/\r|"/g,'')});var res=[];
    for(var i=1;i<lines.length;i++){var ln=lines[i].trim();if(!ln)continue;var v=ln.split(sep).map(function(x){return x.trim().replace(/\r|"/g,'')});var row={};hdr.forEach(function(h,j){row[h]=v[j]||''});res.push(row)}
    SL.cache[year]=res;return res;
}

async function slFetch(){
    SL.qY=parseInt($('slYear').value)||2025;SL.qM=parseInt($('slMonth').value)||0;SL.mode=$('slMode').value;
    slSh(10,'데이터 로딩 중...');
    try{
        var rows=await slCSV(SL.qY);slSh(30,'전년 데이터...');var prev=await slCSV(SL.qY-1);
        /* 전월 데이터 로드 */
        slSh(50,'전월 데이터...');
        if(SL.mode==='month'){
            var ym=SL.qY+'-'+('0'+(SL.qM+1)).slice(-2);SL.raw=rows.filter(function(r){return slYM(R(r,'date'))===ym});
            var pym=(SL.qY-1)+'-'+('0'+(SL.qM+1)).slice(-2);SL.prevRaw=prev.filter(function(r){return slYM(R(r,'date'))===pym});
            var lastMD=new Date(SL.qY,SL.qM-1,1);var lastY=lastMD.getFullYear(),lastM=lastMD.getMonth();
            var lastRows=lastY===SL.qY?rows:await slCSV(lastY);
            var lym=lastY+'-'+('0'+(lastM+1)).slice(-2);SL.lastRaw=lastRows.filter(function(r){return slYM(R(r,'date'))===lym});
        }else{SL.raw=rows;SL.prevRaw=prev;SL.lastRaw=[]}
        slSh(80,'렌더링...');slRender();slHd();
        $('slStat').textContent=(SL.mode==='year'?SL.qY+'년':SL.qY+'.'+(SL.qM+1)+'월')+' / '+SL.raw.length.toLocaleString()+'건';
        $('slBody').style.display='block';$('slEmpty').style.display='none';
    }catch(ex){slHd();$('slStat').textContent='오류: '+ex.message}
}

function slTab(id,el){
    SL.curTab=id;document.querySelectorAll('.sl-tab').forEach(function(t){t.classList.remove('active')});if(el)el.classList.add('active');
    document.querySelectorAll('.sl-pane').forEach(function(p){p.classList.remove('active')});
    $({svc:'pSvc',com:'pCom',shop:'pShop',fee:'pFee',tx:'pTx',area:'pArea',y5:'pY5'}[id]).classList.add('active');
    if(id==='y5'&&!SL._y5){slY5();SL._y5=true}
}
function slRender(){SL._y5=false;slSvc();slCom();slShop();slFee();slTx();slArea();if(SL.curTab==='y5')slY5()}

function slBar(data,title,tall){
    var av=[];data.forEach(function(d){d.values.forEach(function(v){av.push(v.value)})});var mx=Math.max.apply(null,av)||1;
    var h='<div class="sl-cw"><div class="sl-cw__t">'+title+'</div><div class="sl-chart'+(tall?' sl-chart--tall':'')+'">';
    data.forEach(function(d){h+='<div class="sl-chart-col">';d.values.forEach(function(v){var ht=Math.max(v.value/mx*100,1);h+='<div class="sl-chart-bar" style="height:'+ht+'%;background:'+v.color+'"><div class="sl-chart-tip">'+v.name+': '+slS(v.value)+'</div></div>'});h+='</div>'});
    h+='</div><div class="sl-chart-labels">';data.forEach(function(d){h+='<span>'+d.label+'</span>'});h+='</div>';
    if(data.length>0&&data[0].values.length>1){h+='<div class="sl-legend">';data[0].values.forEach(function(v){h+='<span><i style="background:'+v.color+'"></i>'+v.name+'</span>'});h+='</div>'}
    return h+'</div>';
}

/* SVG 선그래프 */
function slLine(series,labels,title,tall){
    var W=800,H=tall?200:140,PL=50,PR=10,PT=10,PB=30;
    var cw=W-PL-PR,ch=H-PT-PB;
    var allV=[];series.forEach(function(s){s.data.forEach(function(v){allV.push(v)})});
    var mx=Math.max.apply(null,allV)||1,mn=Math.min.apply(null,allV.filter(function(v){return v>0}))||0;
    mn=Math.max(0,mn*0.8);
    var n=labels.length;if(n<2)n=2;
    function x(i){return PL+i/(n-1)*cw}
    function y(v){return PT+ch-(v-mn)/(mx-mn)*ch}
    var svg='<svg viewBox="0 0 '+W+' '+H+'" style="width:100%;height:auto;font-family:JetBrains Mono,monospace">';
    // Y축 그리드
    for(var gi=0;gi<=4;gi++){var gv=mn+(mx-mn)*gi/4;var gy=y(gv);
        svg+='<line x1="'+PL+'" y1="'+gy+'" x2="'+(W-PR)+'" y2="'+gy+'" stroke="#e2e8f0" stroke-width="0.5"/>';
        svg+='<text x="'+(PL-4)+'" y="'+(gy+3)+'" text-anchor="end" fill="#94a3b8" font-size="8">'+slS(gv)+'</text>';
    }
    // X축 라벨
    labels.forEach(function(l,i){svg+='<text x="'+x(i)+'" y="'+(H-6)+'" text-anchor="middle" fill="#94a3b8" font-size="8">'+l+'</text>'});
    // 선 + 점
    series.forEach(function(s){
        var pts=[];s.data.forEach(function(v,i){pts.push(x(i)+','+y(v))});
        svg+='<polyline points="'+pts.join(' ')+'" fill="none" stroke="'+s.color+'" stroke-width="2" stroke-linejoin="round"/>';
        s.data.forEach(function(v,i){
            svg+='<circle cx="'+x(i)+'" cy="'+y(v)+'" r="3" fill="'+s.color+'" stroke="#fff" stroke-width="1.5">';
            svg+='<title>'+s.name+' '+labels[i]+': '+slS(v)+'</title></circle>';
        });
    });
    svg+='</svg>';
    var h='<div class="sl-cw"><div class="sl-cw__t">'+title+'</div>'+svg;
    if(series.length>1){h+='<div class="sl-legend">';series.forEach(function(s){h+='<span><i style="background:'+s.color+'"></i>'+s.name+'</span>'});h+='</div>'}
    return h+'</div>';
}
function slCd(l,c,p,m){var d=c-(p||0),cls=d>0?'up':d<0?'down':'flat';return'<div class="sl-card"><div class="sl-card__lbl">'+l+'</div><div class="sl-card__val">'+(m?slS(c):slN(c))+'</div><div class="sl-card__chg '+cls+'">전년 '+(m?slS(p||0):slN(p||0))+' / '+slPct(c,p)+'</div></div>'}

/* SVG 원형 차트 */
function slPie(items,title){
    var total=0;items.forEach(function(d){total+=d.value});if(!total)return'';
    var R=60,CX=70,CY=70,W=140,H=140;
    var svg='<svg viewBox="0 0 '+(W+160)+' '+H+'" style="width:100%;max-width:360px;height:auto;font-family:Noto Sans KR,sans-serif">';
    var angle=0;
    items.forEach(function(d){
        var pct=d.value/total;var a1=angle;var a2=angle+pct*Math.PI*2;angle=a2;
        var la=pct>0.5?1:0;
        var x1=CX+R*Math.sin(a1),y1=CY-R*Math.cos(a1);
        var x2=CX+R*Math.sin(a2),y2=CY-R*Math.cos(a2);
        if(pct>0.999){svg+='<circle cx="'+CX+'" cy="'+CY+'" r="'+R+'" fill="'+d.color+'"><title>'+d.name+': '+slS(d.value)+' ('+(pct*100).toFixed(1)+'%)</title></circle>'}
        else{svg+='<path d="M'+CX+','+CY+' L'+x1+','+y1+' A'+R+','+R+' 0 '+la+',1 '+x2+','+y2+' Z" fill="'+d.color+'"><title>'+d.name+': '+slS(d.value)+' ('+(pct*100).toFixed(1)+'%)</title></path>'}
    });
    // 범례
    var ly=8;items.forEach(function(d,i){
        var pct=(d.value/total*100).toFixed(1);
        svg+='<rect x="'+(W+10)+'" y="'+ly+'" width="8" height="8" rx="1" fill="'+d.color+'"/>';
        svg+='<text x="'+(W+22)+'" y="'+(ly+8)+'" fill="#4a5568" font-size="10">'+d.name+'</text>';
        svg+='<text x="'+(W+140)+'" y="'+(ly+8)+'" fill="#1a2332" font-size="10" text-anchor="end" font-family="JetBrains Mono,monospace">'+pct+'%</text>';
        ly+=16;
    });
    svg+='</svg>';
    return'<div class="sl-cw"><div class="sl-cw__t">'+title+'</div>'+svg+'</div>';
}

/* 대분류 매핑 */
function slCat(type){
    if(!type)return'기타';
    if(type==='방문 제휴식당'||type==='방문/전화배달 제휴식당'||type==='전화배달 제휴식당')return'오프라인';
    if(type==='구내식당'||type==='GS 편의점'||/^POS\(/i.test(type))return'바코드';
    if(type==='배달식사'||type==='식품관'||type==='로봇배달')return'온라인';
    if(type==='복지포인트 전환'||type==='복지대장몰')return'복지대장';
    return'기타';
}
var SL_CAT_ORDER=['오프라인','바코드','온라인','복지대장','기타'];
var SL_CAT_COLOR={'오프라인':'#4a90d9','바코드':'#22c55e','온라인':'#d49a2a','복지대장':'#8b5cf6','기타':'#94a3b8'};
function slSvc(){
    var cs={},ps={};
    var keys=['txAmt','sales','orderCnt','userCnt','solo','together','cancel','normal','admin','easyPay','mealPt','daejangPt','daejangCp','ptSum','delivery','shopFee','bill','settle','salePrice'];
    keys.forEach(function(k){cs[k]=0;ps[k]=0});
    /* 식대/복지포인트 분리 집계 */
    cs.sikPt=0;cs.bokPt=0;ps.sikPt=0;ps.bokPt=0;
    function ag(rows,s){rows.forEach(function(r){
        keys.forEach(function(k){s[k]+=RN(r,k)});
        var cat=slCat(String(R(r,'shopType')));
        if(cat==='복지대장')s.bokPt+=RN(r,'txAmt');else s.sikPt+=RN(r,'txAmt');
    })}
    ag(SL.raw,cs);ag(SL.prevRaw,ps);
    var feeRate=cs.txAmt?(cs.shopFee/cs.txAmt*100):0;
    var pFeeRate=ps.txAmt?(ps.shopFee/ps.txAmt*100):0;

    /* 서머리 카드 */
    var h='<div class="sl-cards">';
    h+=slCd('거래액',cs.txAmt,ps.txAmt,1);
    h+=slCd('수수료',cs.shopFee,ps.shopFee,1);
    h+=slCd('주문 수',cs.orderCnt,ps.orderCnt,0);
    h+=slCd('고유 사용자',cs.userCnt,ps.userCnt,0);
    h+=slCd('포인트 사용 합계',cs.ptSum,ps.ptSum,1);
    h+='<div class="sl-card"><div class="sl-card__lbl">수수료율 (수수료/거래액)</div><div class="sl-card__val">'+feeRate.toFixed(2)+'%</div><div class="sl-card__chg '+(feeRate>pFeeRate?'up':'down')+'">전년 '+pFeeRate.toFixed(2)+'%</div></div>';
    h+='</div>';

    /* 4단: 결제바 + 결제원형 + 포인트원형 + 포인트바 */
    var payBar=[
        {label:'혼자결제',values:[{name:'전년',value:ps.solo,color:'#d1d5db'},{name:'당기',value:cs.solo,color:'#4a90d9'}]},
        {label:'함께결제',values:[{name:'전년',value:ps.together,color:'#d1d5db'},{name:'당기',value:cs.together,color:'#4a90d9'}]},
        {label:'정상거래',values:[{name:'전년',value:ps.normal,color:'#d1d5db'},{name:'당기',value:cs.normal,color:'#4a90d9'}]},
        {label:'취소거래',values:[{name:'전년',value:ps.cancel,color:'#d1d5db'},{name:'당기',value:cs.cancel,color:'#e85d5d'}]},
        {label:'관리자입력',values:[{name:'전년',value:ps.admin,color:'#d1d5db'},{name:'당기',value:cs.admin,color:'#d49a2a'}]}];
    var payPie=[
        {name:'혼자결제',value:cs.solo,color:'#4a90d9'},
        {name:'함께결제',value:cs.together,color:'#06b6d4'},
        {name:'취소거래',value:cs.cancel,color:'#e85d5d'},
        {name:'관리자입력',value:cs.admin,color:'#d49a2a'}];
    var ptPie=[
        {name:'식대포인트',value:cs.sikPt,color:'#4a90d9'},
        {name:'복지포인트',value:cs.bokPt,color:'#8b5cf6'},
        {name:'대장포인트',value:cs.daejangPt,color:'#22c55e'},
        {name:'간편결제',value:cs.easyPay,color:'#06b6d4'},
        {name:'대장쿠폰',value:cs.daejangCp,color:'#f59e0b'}];
    var ptBar=[
        {label:'식대포인트',values:[{name:'전년',value:ps.sikPt,color:'#d1d5db'},{name:'당기',value:cs.sikPt,color:'#4a90d9'}]},
        {label:'복지포인트',values:[{name:'전년',value:ps.bokPt,color:'#d1d5db'},{name:'당기',value:cs.bokPt,color:'#8b5cf6'}]},
        {label:'대장포인트',values:[{name:'전년',value:ps.daejangPt,color:'#d1d5db'},{name:'당기',value:cs.daejangPt,color:'#22c55e'}]},
        {label:'간편결제',values:[{name:'전년',value:ps.easyPay,color:'#d1d5db'},{name:'당기',value:cs.easyPay,color:'#06b6d4'}]},
        {label:'대장쿠폰',values:[{name:'전년',value:ps.daejangCp,color:'#d1d5db'},{name:'당기',value:cs.daejangCp,color:'#f59e0b'}]}];
    h+='<div class="sl-grid4">'+slBar(payBar,'결제방식 건수 (전년 비교)')+slPie(payPie,'결제방식 비율')+slPie(ptPie,'포인트 구성 비율')+slBar(ptBar,'포인트 전년 비교')+'</div>';

    /* 거래액 대비 수수료율 분석 */
    h+='<div class="sl-cw"><div class="sl-cw__t">거래액 대비 수수료 분석</div>';
    h+='<table class="sl-t sl-t--s"><thead><tr><th>구분</th><th class="r">당기</th><th class="r">전년</th><th class="r">증감</th><th class="r">증감률</th></tr></thead><tbody>';
    function dr(l,c,p){var d=c-p,cls=d>0?'up':d<0?'down':'flat';return'<tr><td>'+l+'</td><td class="r">'+slN(c)+'</td><td class="r">'+slN(p)+'</td><td class="r '+cls+'">'+slD(d)+'</td><td class="r '+cls+'">'+slPct(c,p)+'</td></tr>'}
    h+=dr('거래액',cs.txAmt,ps.txAmt);
    h+=dr('고객사 청구 금액',cs.bill,ps.bill);
    h+=dr('제휴점 정산 금액',cs.settle,ps.settle);
    h+=dr('제휴점 수수료',cs.shopFee,ps.shopFee);
    h+='<tr style="font-weight:600"><td>수수료율 (수수료/거래액)</td><td class="r">'+feeRate.toFixed(2)+'%</td><td class="r">'+pFeeRate.toFixed(2)+'%</td>';
    var rateDiff=feeRate-pFeeRate,rcls=rateDiff>0?'up':rateDiff<0?'down':'flat';
    h+='<td class="r '+rcls+'">'+(rateDiff>0?'+':'')+rateDiff.toFixed(2)+'%p</td><td class="r"></td></tr>';
    h+='<tr><td colspan="5" style="height:4px;border:none"></td></tr>';
    h+=dr('배송비',cs.delivery,ps.delivery);
    h+='</tbody></table></div>';

    /* 상세 비교 테이블 */
    h+='<div class="sl-cw"><div class="sl-cw__t">결제/포인트 상세</div>';
    h+='<table class="sl-t sl-t--s"><thead><tr><th>구분</th><th class="r">당기</th><th class="r">전년</th><th class="r">증감</th><th class="r">증감률</th></tr></thead><tbody>';
    h+=dr('혼자결제',cs.solo,ps.solo)+dr('함께결제',cs.together,ps.together)+dr('정상거래',cs.normal,ps.normal)+dr('취소거래',cs.cancel,ps.cancel)+dr('관리자입력',cs.admin,ps.admin);
    h+='<tr><td colspan="5" style="height:4px;border:none"></td></tr>';
    h+=dr('식대포인트',cs.sikPt,ps.sikPt)+dr('복지포인트',cs.bokPt,ps.bokPt)+dr('대장포인트',cs.daejangPt,ps.daejangPt)+dr('간편결제',cs.easyPay,ps.easyPay)+dr('대장쿠폰',cs.daejangCp,ps.daejangCp)+dr('포인트 사용 합계',cs.ptSum,ps.ptSum);
    h+='</tbody></table></div>';
    $('pSvc').innerHTML=h;
}

    $('pSvc').innerHTML=h;
}

/* === 2. 고객사 통계 === */
function slGC(rows){
    var map={};rows.forEach(function(r){
        var id=String(R(r,'comId'));if(!id)return;
        if(!map[id])map[id]={id:id,name:R(r,'comName'),group:R(r,'comGroup'),sido:R(r,'comSido'),sigungu:R(r,'comSigungu'),
            txAmt:0,sikTx:0,bokTx:0,bill:0,settle:0,shopFee:0,orderCnt:0,userCnt:0,txCnt:0,cancelCnt:0,soloCnt:0,tgCnt:0,adminCnt:0,ptSum:0,mealPt:0,djPt:0,djCp:0,easyPay:0,dlv:0};
        var g=map[id];var cat=slCat(String(R(r,'shopType')));
        var tx=RN(r,'txAmt');g.txAmt+=tx;
        if(cat==='복지대장')g.bokTx+=tx;else g.sikTx+=tx;
        g.bill+=RN(r,'bill');g.settle+=RN(r,'settle');g.shopFee+=RN(r,'shopFee');
        g.orderCnt+=RN(r,'orderCnt');g.userCnt+=RN(r,'userCnt');g.txCnt+=RN(r,'normal');g.cancelCnt+=RN(r,'cancel');
        g.soloCnt+=RN(r,'solo');g.tgCnt+=RN(r,'together');g.adminCnt+=RN(r,'admin');
        g.ptSum+=RN(r,'ptSum');g.mealPt+=RN(r,'mealPt');g.djPt+=RN(r,'daejangPt');g.djCp+=RN(r,'daejangCp');g.easyPay+=RN(r,'easyPay');g.dlv+=RN(r,'delivery');
    });return Object.values(map);
}

function slCom(){
    SL._cc=slGC(SL.raw);SL._cp=slGC(SL.prevRaw);SL._cl=slGC(SL.lastRaw);SL.comSel=null;
    var ct=0,co=0,cu=0,cSik=0,cBok=0,cc=SL._cc.length;
    SL._cc.forEach(function(g){ct+=g.txAmt;co+=g.orderCnt;cu+=g.userCnt;cSik+=g.sikTx;cBok+=g.bokTx});
    var pt=0,po=0,pu=0,pSik=0,pBok=0,pc=SL._cp.length;
    SL._cp.forEach(function(g){pt+=g.txAmt;po+=g.orderCnt;pu+=g.userCnt;pSik+=g.sikTx;pBok+=g.bokTx});
    var h='<div class="sl-cards">'+slCd('거래액',ct,pt,1)+slCd('식권대장 거래액',cSik,pSik,1)+slCd('복지대장 거래액',cBok,pBok,1)+slCd('주문 수',co,po,0)+slCd('고유 사용자',cu,pu,0)+slCd('고객사 수',cc,pc,0)+'</div>';
    h+='<div class="sl-panel"><div class="sl-panel__head"><span class="sl-panel__title" id="slCTT">고객사 ('+cc+')</span><div style="display:flex;align-items:center;gap:4px"><input class="sl-search" id="slCSch" placeholder="고객사/그룹/ID 검색..." oninput="slCT()"><button class="sl-copy-btn" id="slCCp" onclick="slCC()">복사</button></div></div><div class="sl-tw" id="slCTW"></div></div>';
    h+='<div class="sl-panel" style="margin-top:8px"><div class="sl-panel__head"><span class="sl-panel__title" id="slCDT">고객사 상세</span></div><div class="sl-det" id="slCD" style="max-height:none"><div class="sl-det__empty">위 테이블에서 고객사를 선택하세요</div></div></div>';
    $('pCom').innerHTML=h;slCT();
}

function slCSrt(c){if(SL.comSort===c)SL.comDir=SL.comDir==='desc'?'asc':'desc';else{SL.comSort=c;SL.comDir='desc'}slCT()}

function slCT(){
    var sch=($('slCSch')?$('slCSch').value:'').toLowerCase();
    var data=SL._cc.slice();if(sch)data=data.filter(function(g){return g.name.toLowerCase().indexOf(sch)!==-1||g.group.toLowerCase().indexOf(sch)!==-1||g.id.toLowerCase().indexOf(sch)!==-1});
    var c=SL.comSort,d=SL.comDir==='asc'?1:-1;
    data.sort(function(a,b){var va=a[c],vb=b[c];if(typeof va==='string')return va.localeCompare(vb)*d;return((va||0)-(vb||0))*d});
    /* 전년/전월 맵 빌드 */
    var pMap={},lMap={};SL._cp.forEach(function(g){pMap[g.id]=g});SL._cl.forEach(function(g){lMap[g.id]=g});
    var cols=[{k:'id',l:'고객사 ID',n:0},{k:'name',l:'고객사명',n:0},{k:'group',l:'그룹',n:0},{k:'sido',l:'지역',n:0},{k:'txAmt',l:'거래액(원)',n:1},{k:'sikTx',l:'식권대장(원)',n:1},{k:'bokTx',l:'복지대장(원)',n:1},{k:'orderCnt',l:'주문 수',n:1},{k:'userCnt',l:'사용자 수',n:1},{k:'shopFee',l:'수수료(원)',n:1}];
    var h='<table class="sl-t"><thead><tr>';
    cols.forEach(function(c2){var s=SL.comSort===c2.k,ar=s?(SL.comDir==='asc'?'&#9650;':'&#9660;'):'&#9650;';h+='<th class="'+(c2.n?'r ':'')+(s?'s ':'')+'" onclick="slCSrt(\''+c2.k+'\')">'+c2.l+'<span class="a">'+ar+'</span></th>'});
    h+='<th class="r" style="font-size:9px">전월대비</th><th class="r" style="font-size:9px">전년대비</th>';
    h+='</tr></thead><tbody>';
    data.forEach(function(g){
        var pg=pMap[g.id],lg=lMap[g.id];
        var lPct=slPct(g.shopFee,lg?lg.shopFee:0),pPct=slPct(g.shopFee,pg?pg.shopFee:0);
        var lCls=(g.shopFee-(lg?lg.shopFee:0))>0?'up':(g.shopFee-(lg?lg.shopFee:0))<0?'down':'flat';
        var pCls=(g.shopFee-(pg?pg.shopFee:0))>0?'up':(g.shopFee-(pg?pg.shopFee:0))<0?'down':'flat';
        h+='<tr class="'+(SL.comSel===g.id?'sel':'')+'" onclick="slCSel(\''+g.id+'\')"><td class="id" title="'+g.id+'">'+g.id.substring(0,8)+'...</td><td>'+g.name+'</td><td>'+g.group+'</td><td>'+g.sido+'</td><td class="r">'+slN(g.txAmt)+'</td><td class="r">'+slN(g.sikTx)+'</td><td class="r">'+slN(g.bokTx)+'</td><td class="r">'+slN(g.orderCnt)+'</td><td class="r">'+slN(g.userCnt)+'</td><td class="r">'+slN(g.shopFee)+'</td><td class="r '+lCls+'" style="font-size:10px">'+lPct+'</td><td class="r '+pCls+'" style="font-size:10px">'+pPct+'</td></tr>';
    });
    h+='</tbody></table>';
    if($('slCTW'))$('slCTW').innerHTML=h;
    if($('slCTT'))$('slCTT').textContent='고객사 ('+data.length+')';
}

function slCSel(id){SL.comSel=id;slCT();slCDet()}

function slCDet(){
    var el=$('slCD');if(!el)return;
    if(!SL.comSel){el.innerHTML='<div class="sl-det__empty">위 테이블에서 고객사를 선택하세요</div>';return}
    var g=SL._cc.find(function(x){return x.id===SL.comSel});
    if(!g){el.innerHTML='<div class="sl-det__empty">데이터 없음</div>';return}
    var pg=SL._cp.find(function(x){return x.id===g.id});
    var lg=SL._cl.find(function(x){return x.id===g.id});
    if($('slCDT'))$('slCDT').textContent=g.name+' 상세';
    var h='<div class="sl-det__name">'+g.name+'</div><div class="sl-det__meta">'+g.id+' | '+g.group+' | '+g.sido+' '+g.sigungu+'</div>';
    h+='<table class="sl-t sl-t--s" style="margin:8px 0"><thead><tr><th>구분</th><th class="r">당기</th><th class="r">전월</th><th class="r">전월대비</th><th class="r">전년 동기</th><th class="r">전년대비</th></tr></thead><tbody>';
    function dr3(label,cur,last,prev){
        var dL=cur-(last||0),dP=cur-(prev||0);
        var clsL=dL>0?'up':dL<0?'down':'flat',clsP=dP>0?'up':dP<0?'down':'flat';
        return'<tr><td>'+label+'</td><td class="r">'+slN(cur)+'</td><td class="r">'+slN(last||0)+'</td><td class="r '+clsL+'">'+slPct(cur,last||0)+'</td><td class="r">'+slN(prev||0)+'</td><td class="r '+clsP+'">'+slPct(cur,prev||0)+'</td></tr>';
    }
    h+=dr3('거래액',g.txAmt,lg?lg.txAmt:0,pg?pg.txAmt:0);
    h+=dr3('식권대장 거래액',g.sikTx,lg?lg.sikTx:0,pg?pg.sikTx:0);
    h+=dr3('복지대장 거래액',g.bokTx,lg?lg.bokTx:0,pg?pg.bokTx:0);
    h+=dr3('수수료',g.shopFee,lg?lg.shopFee:0,pg?pg.shopFee:0);
    h+=dr3('고객사 청구 금액',g.bill,lg?lg.bill:0,pg?pg.bill:0);
    h+=dr3('제휴점 정산 금액',g.settle,lg?lg.settle:0,pg?pg.settle:0);
    h+=dr3('주문 수',g.orderCnt,lg?lg.orderCnt:0,pg?pg.orderCnt:0);
    h+=dr3('고유 사용자 수',g.userCnt,lg?lg.userCnt:0,pg?pg.userCnt:0);
    h+=dr3('배송비',g.dlv,lg?lg.dlv:0,pg?pg.dlv:0);
    h+='</tbody></table>';
    h+='<div class="sl-grid2">';
    h+='<div><div class="sl-det__sec">결제 방식</div><table class="sl-mt"><thead><tr><th>구분</th><th class="r">당기</th><th class="r">전월</th><th class="r">전년</th></tr></thead><tbody>';
    function dr3s(l,c,lv,p){return'<tr><td>'+l+'</td><td class="r">'+slN(c)+'</td><td class="r">'+slN(lv)+'</td><td class="r">'+slN(p)+'</td></tr>'}
    h+=dr3s('혼자결제',g.soloCnt,lg?lg.soloCnt:0,pg?pg.soloCnt:0);
    h+=dr3s('함께결제',g.tgCnt,lg?lg.tgCnt:0,pg?pg.tgCnt:0);
    h+=dr3s('관리자입력',g.adminCnt,lg?lg.adminCnt:0,pg?pg.adminCnt:0);
    h+=dr3s('정상거래',g.txCnt,lg?lg.txCnt:0,pg?pg.txCnt:0);
    h+=dr3s('취소거래',g.cancelCnt,lg?lg.cancelCnt:0,pg?pg.cancelCnt:0);
    h+='</tbody></table></div>';
    h+='<div><div class="sl-det__sec">포인트 사용</div><table class="sl-mt"><thead><tr><th>구분</th><th class="r">당기</th><th class="r">전월</th><th class="r">전년</th></tr></thead><tbody>';
    h+=dr3s('식대/복지 포인트',g.mealPt,lg?lg.mealPt:0,pg?pg.mealPt:0);
    h+=dr3s('대장포인트',g.djPt,lg?lg.djPt:0,pg?pg.djPt:0);
    h+=dr3s('대장쿠폰',g.djCp,lg?lg.djCp:0,pg?pg.djCp:0);
    h+=dr3s('간편결제',g.easyPay,lg?lg.easyPay:0,pg?pg.easyPay:0);
    h+='<tr style="font-weight:600">'+dr3s('포인트 합계',g.ptSum,lg?lg.ptSum:0,pg?pg.ptSum:0).replace('<tr>','');
    h+='</tbody></table></div></div>';
    el.innerHTML=h;
}

function slCC(){
    var data=SL._cc.slice().sort(function(a,b){var c=SL.comSort,d=SL.comDir==='asc'?1:-1;var va=a[c],vb=b[c];if(typeof va==='string')return va.localeCompare(vb)*d;return((va||0)-(vb||0))*d});
    var lines=['고객사ID\t고객사명\t그룹\t지역\t거래액\t식권대장\t복지대장\t주문 수\t사용자 수\t수수료'];
    data.forEach(function(g){lines.push(g.id+'\t'+g.name+'\t'+g.group+'\t'+g.sido+'\t'+g.txAmt+'\t'+g.sikTx+'\t'+g.bokTx+'\t'+g.orderCnt+'\t'+g.userCnt+'\t'+g.shopFee)});
    navigator.clipboard.writeText(lines.join('\n')).then(function(){var b=$('slCCp');b.classList.add('copied');b.textContent='완료';setTimeout(function(){b.classList.remove('copied');b.textContent='복사'},1500)});
}

/* === 3. 제휴점 통계 === */
function slShop(){
    // 소분류별 집계
    var cM={},pM={};
    function ag(rows,map){rows.forEach(function(r){
        var t=String(R(r,'shopType'))||'기타';
        if(!map[t])map[t]={type:t,cat:slCat(t),tx:0,sales:0,fee:0,order:0,user:0,txCnt:0,cancel:0,cids:{},sids:{}};
        var g=map[t];g.tx+=RN(r,'txAmt');g.sales+=RN(r,'sales');g.fee+=RN(r,'shopFee');g.order+=RN(r,'orderCnt');g.user+=RN(r,'userCnt');g.txCnt+=RN(r,'normal');g.cancel+=RN(r,'cancel');
        g.cids[String(R(r,'comId'))]=1;var sid=String(R(r,'shopId'));if(sid)g.sids[sid]=1;
    })}
    ag(SL.raw,cM);ag(SL.prevRaw,pM);
    var cur=Object.values(cM);var prev=Object.values(pM);
    var total=0;cur.forEach(function(g){total+=g.tx});

    // 대분류별 집계
    var catAgg={},pCatAgg={};
    cur.forEach(function(g){if(!catAgg[g.cat])catAgg[g.cat]={cat:g.cat,tx:0,sales:0,fee:0,order:0,user:0,cids:{},sids:{}};var c=catAgg[g.cat];c.tx+=g.tx;c.sales+=g.sales;c.fee+=g.fee;c.order+=g.order;c.user+=g.user;Object.keys(g.cids).forEach(function(k){c.cids[k]=1});Object.keys(g.sids).forEach(function(k){c.sids[k]=1})});
    prev.forEach(function(g){if(!pCatAgg[g.cat])pCatAgg[g.cat]={cat:g.cat,tx:0};pCatAgg[g.cat].tx+=g.tx});

    // 대분류 차트
    var catArr=SL_CAT_ORDER.filter(function(c){return catAgg[c]});
    var catChartData=catArr.map(function(c,i){return{label:c,values:[{name:'전년',value:(pCatAgg[c]||{}).tx||0,color:'#d1d5db'},{name:'당기',value:catAgg[c].tx,color:SL_CAT_COLOR[c]||'#4a90d9'}]}});
    var h=slBar(catChartData,'대분류별 거래액 (전년 비교)',0);

    // 대분류 서머리 카드
    h+='<div class="sl-cards">';
    catArr.forEach(function(c){var ca=catAgg[c],pa=pCatAgg[c];h+=slCd(c,ca.tx,(pa||{}).tx||0,1)});
    h+='</div>';

    // 대분류 > 소분류 테이블
    h+='<div class="sl-cw"><div class="sl-cw__t">대분류 / 제휴점유형별 상세</div>';
    h+='<table class="sl-t sl-t--s"><thead><tr><th>대분류</th><th>제휴점유형</th><th class="r">거래액</th><th class="r">비중</th><th class="r">매출액</th><th class="r">수수료</th><th class="r">주문</th><th class="r">고객사</th><th class="r">제휴점</th><th class="r">전년</th><th class="r">증감률</th></tr></thead><tbody>';

    SL_CAT_ORDER.forEach(function(cat){
        if(!catAgg[cat])return;
        var ca=catAgg[cat],pca=pCatAgg[cat]||{tx:0};
        var cls1=(ca.tx-pca.tx)>0?'up':(ca.tx-pca.tx)<0?'down':'flat';

        // 대분류 소계행
        h+='<tr style="background:#eef4fb;font-weight:600"><td style="color:'+(SL_CAT_COLOR[cat]||'#4a5568')+'">'+cat+'</td><td></td><td class="r">'+slN(ca.tx)+'</td><td class="r">'+(total?(ca.tx/total*100).toFixed(1):'0')+'%</td><td class="r">'+slN(ca.sales)+'</td><td class="r">'+slN(ca.fee)+'</td><td class="r">'+slN(ca.order)+'</td><td class="r">'+Object.keys(ca.cids).length+'</td><td class="r">'+Object.keys(ca.sids).length+'</td><td class="r">'+slN(pca.tx)+'</td><td class="r '+cls1+'">'+slPct(ca.tx,pca.tx)+'</td></tr>';

        // 소분류
        var items=cur.filter(function(g){return g.cat===cat});
        var posItems=items.filter(function(g){return/^POS\(/i.test(g.type)});
        var nonPos=items.filter(function(g){return!/^POS\(/i.test(g.type)}).sort(function(a,b){return b.tx-a.tx});

        nonPos.forEach(function(g){
            var pg=prev.find(function(x){return x.type===g.type});var pv=pg?pg.tx:0;var cls=(g.tx-pv)>0?'up':(g.tx-pv)<0?'down':'flat';
            h+='<tr><td></td><td style="padding-left:16px">'+g.type+'</td><td class="r">'+slN(g.tx)+'</td><td class="r">'+(total?(g.tx/total*100).toFixed(1):'0')+'%</td><td class="r">'+slN(g.sales)+'</td><td class="r">'+slN(g.fee)+'</td><td class="r">'+slN(g.order)+'</td><td class="r">'+Object.keys(g.cids).length+'</td><td class="r">'+Object.keys(g.sids).length+'</td><td class="r">'+slN(pv)+'</td><td class="r '+cls+'">'+slPct(g.tx,pv)+'</td></tr>';
        });

        // POS 통합 + 하위
        if(posItems.length>0){
            posItems.sort(function(a,b){return b.tx-a.tx});
            var posTx=0,posSales=0,posFee=0,posOrder=0,posCids={},posSids={},pPosTx=0;
            posItems.forEach(function(g){posTx+=g.tx;posSales+=g.sales;posFee+=g.fee;posOrder+=g.order;Object.keys(g.cids).forEach(function(k){posCids[k]=1});Object.keys(g.sids).forEach(function(k){posSids[k]=1})});
            prev.filter(function(x){return/^POS\(/i.test(x.type)}).forEach(function(x){pPosTx+=x.tx});
            var clsP=(posTx-pPosTx)>0?'up':(posTx-pPosTx)<0?'down':'flat';
            h+='<tr style="background:#f8fafd;font-weight:500"><td></td><td style="padding-left:16px">POS ('+posItems.length+'개)</td><td class="r">'+slN(posTx)+'</td><td class="r">'+(total?(posTx/total*100).toFixed(1):'0')+'%</td><td class="r">'+slN(posSales)+'</td><td class="r">'+slN(posFee)+'</td><td class="r">'+slN(posOrder)+'</td><td class="r">'+Object.keys(posCids).length+'</td><td class="r">'+Object.keys(posSids).length+'</td><td class="r">'+slN(pPosTx)+'</td><td class="r '+clsP+'">'+slPct(posTx,pPosTx)+'</td></tr>';
            posItems.forEach(function(g){
                var pg=prev.find(function(x){return x.type===g.type});var pv=pg?pg.tx:0;var cls=(g.tx-pv)>0?'up':(g.tx-pv)<0?'down':'flat';
                h+='<tr><td></td><td style="padding-left:32px;font-size:10px;color:#94a3b8">'+g.type+'</td><td class="r" style="font-size:10px">'+slN(g.tx)+'</td><td class="r" style="font-size:10px">'+(total?(g.tx/total*100).toFixed(1):'0')+'%</td><td class="r" style="font-size:10px">'+slN(g.sales)+'</td><td class="r" style="font-size:10px">'+slN(g.fee)+'</td><td class="r" style="font-size:10px">'+slN(g.order)+'</td><td class="r" style="font-size:10px">'+Object.keys(g.cids).length+'</td><td class="r" style="font-size:10px">'+Object.keys(g.sids).length+'</td><td class="r" style="font-size:10px">'+slN(pv)+'</td><td class="r '+cls+'" style="font-size:10px">'+slPct(g.tx,pv)+'</td></tr>';
            });
        }
    });
    h+='</tbody></table></div>';$('pShop').innerHTML=h;
}

/* === 4. 수수료 통계 === */
function slFee(){
    var cS=0,cT=0,cB=0,cSt=0,cF=0,pS=0,pT=0,pB=0,pSt=0,pF=0;
    SL.raw.forEach(function(r){cS+=RN(r,'sales');cT+=RN(r,'txAmt');cB+=RN(r,'bill');cSt+=RN(r,'settle');cF+=RN(r,'shopFee')});
    SL.prevRaw.forEach(function(r){pS+=RN(r,'sales');pT+=RN(r,'txAmt');pB+=RN(r,'bill');pSt+=RN(r,'settle');pF+=RN(r,'shopFee')});
    var cR=cT?(cF/cT*100):0,pR=pT?(pF/pT*100):0;
    var h='<div class="sl-cards">'+slCd('수수료',cF,pF,1)+slCd('매출액',cS,pS,1)+slCd('거래액',cT,pT,1)+slCd('청구',cB,pB,1)+slCd('정산',cSt,pSt,1);
    h+='<div class="sl-card"><div class="sl-card__lbl">수수료/거래 비율</div><div class="sl-card__val">'+cR.toFixed(2)+'%</div><div class="sl-card__chg '+(cR>pR?'up':'down')+'">전년 '+pR.toFixed(2)+'%</div></div></div>';
    // 월별 선그래프 (연간)
    if(SL.mode==='year'){
        var cByM={},pByM={};
        SL.raw.forEach(function(r){var ym=slYM(R(r,'date'));cByM[ym]=(cByM[ym]||0)+RN(r,'shopFee')});
        SL.prevRaw.forEach(function(r){var ym=slYM(R(r,'date'));pByM[ym]=(pByM[ym]||0)+RN(r,'shopFee')});
        var ms=[];for(var i=1;i<=12;i++)ms.push(('0'+i).slice(-2));
        var lbls=ms.map(function(mm){return parseInt(mm)+'월'});
        var s1=ms.map(function(mm){return cByM[SL.qY+'-'+mm]||0});
        var s2=ms.map(function(mm){return pByM[(SL.qY-1)+'-'+mm]||0});
        h+=slLine([{name:SL.qY+'',data:s1,color:'#4a90d9'},{name:(SL.qY-1)+'',data:s2,color:'#d1d5db'}],lbls,'월별 수수료 추이',1);
    }
    // 대분류별 수수료 테이블
    var catFee={},pCatFee={};
    SL.raw.forEach(function(r){var t=String(R(r,'shopType'))||'기타';var cat=slCat(t);if(!catFee[cat])catFee[cat]={};if(!catFee[cat][t])catFee[cat][t]={type:t,fee:0,tx:0};catFee[cat][t].fee+=RN(r,'shopFee');catFee[cat][t].tx+=RN(r,'txAmt')});
    SL.prevRaw.forEach(function(r){var t=String(R(r,'shopType'))||'기타';var cat=slCat(t);if(!pCatFee[cat])pCatFee[cat]={};if(!pCatFee[cat][t])pCatFee[cat][t]={type:t,fee:0};pCatFee[cat][t].fee+=RN(r,'shopFee')});
    h+='<div class="sl-cw"><div class="sl-cw__t">대분류 / 유형별 수수료</div><table class="sl-t sl-t--s"><thead><tr><th>대분류</th><th>제휴점유형</th><th class="r">수수료</th><th class="r">거래액</th><th class="r">수수료율</th><th class="r">비중</th><th class="r">전년수수료</th><th class="r">증감률</th></tr></thead><tbody>';
    SL_CAT_ORDER.forEach(function(cat){
        if(!catFee[cat])return;
        var items=Object.values(catFee[cat]);
        var catF=0,catTx=0,pCatF=0;items.forEach(function(x){catF+=x.fee;catTx+=x.tx});
        if(pCatFee[cat])Object.values(pCatFee[cat]).forEach(function(x){pCatF+=x.fee});
        var cr=catTx?(catF/catTx*100):0;var cls1=(catF-pCatF)>0?'up':(catF-pCatF)<0?'down':'flat';
        h+='<tr style="background:#eef4fb;font-weight:600"><td style="color:'+(SL_CAT_COLOR[cat]||'#4a5568')+'">'+cat+'</td><td></td><td class="r">'+slN(catF)+'</td><td class="r">'+slN(catTx)+'</td><td class="r">'+cr.toFixed(2)+'%</td><td class="r">'+(cF?(catF/cF*100).toFixed(1):'0')+'%</td><td class="r">'+slN(pCatF)+'</td><td class="r '+cls1+'">'+slPct(catF,pCatF)+'</td></tr>';
        var posItems=items.filter(function(x){return/^POS\(/i.test(x.type)});
        var nonPos=items.filter(function(x){return!/^POS\(/i.test(x.type)}).sort(function(a,b){return b.fee-a.fee});
        nonPos.forEach(function(item){
            var pv=0;if(pCatFee[cat]&&pCatFee[cat][item.type])pv=pCatFee[cat][item.type].fee;
            var r2=item.tx?(item.fee/item.tx*100):0;var cls=(item.fee-pv)>0?'up':(item.fee-pv)<0?'down':'flat';
            h+='<tr><td></td><td style="padding-left:16px">'+item.type+'</td><td class="r">'+slN(item.fee)+'</td><td class="r">'+slN(item.tx)+'</td><td class="r">'+r2.toFixed(2)+'%</td><td class="r">'+(cF?(item.fee/cF*100).toFixed(1):'0')+'%</td><td class="r">'+slN(pv)+'</td><td class="r '+cls+'">'+slPct(item.fee,pv)+'</td></tr>';
        });
        if(posItems.length>0){
            posItems.sort(function(a,b){return b.fee-a.fee});
            var pf=0,pt2=0,ppf=0;posItems.forEach(function(x){pf+=x.fee;pt2+=x.tx});
            if(pCatFee[cat])Object.keys(pCatFee[cat]).forEach(function(k){if(/^POS\(/i.test(k))ppf+=pCatFee[cat][k].fee});
            var pr2=pt2?(pf/pt2*100):0;var clsP=(pf-ppf)>0?'up':(pf-ppf)<0?'down':'flat';
            h+='<tr style="background:#f8fafd;font-weight:500"><td></td><td style="padding-left:16px">POS ('+posItems.length+'개)</td><td class="r">'+slN(pf)+'</td><td class="r">'+slN(pt2)+'</td><td class="r">'+pr2.toFixed(2)+'%</td><td class="r">'+(cF?(pf/cF*100).toFixed(1):'0')+'%</td><td class="r">'+slN(ppf)+'</td><td class="r '+clsP+'">'+slPct(pf,ppf)+'</td></tr>';
            posItems.forEach(function(item){
                var pv=0;if(pCatFee[cat]&&pCatFee[cat][item.type])pv=pCatFee[cat][item.type].fee;
                var r3=item.tx?(item.fee/item.tx*100):0;var cls=(item.fee-pv)>0?'up':(item.fee-pv)<0?'down':'flat';
                h+='<tr><td></td><td style="padding-left:32px;font-size:10px;color:#94a3b8">'+item.type+'</td><td class="r" style="font-size:10px">'+slN(item.fee)+'</td><td class="r" style="font-size:10px">'+slN(item.tx)+'</td><td class="r" style="font-size:10px">'+r3.toFixed(2)+'%</td><td class="r" style="font-size:10px">'+(cF?(item.fee/cF*100).toFixed(1):'0')+'%</td><td class="r" style="font-size:10px">'+slN(pv)+'</td><td class="r '+cls+'" style="font-size:10px">'+slPct(item.fee,pv)+'</td></tr>';
            });
        }
    });
    h+='</tbody></table></div>';$('pFee').innerHTML=h;
}

/* === 5. 거래액 통계 === */
function slTx(){
    var cT=0,pT=0;SL.raw.forEach(function(r){cT+=RN(r,'txAmt')});SL.prevRaw.forEach(function(r){pT+=RN(r,'txAmt')});
    var h='<div class="sl-cards">'+slCd('거래액',cT,pT,1)+slCd('전년 거래액',pT,0,1)+slCd('증감',cT-pT,0,1);
    // 대분류별 카드
    var catSum={};SL_CAT_ORDER.forEach(function(c){catSum[c]=0});
    SL.raw.forEach(function(r){var c=slCat(String(R(r,'shopType')));catSum[c]=(catSum[c]||0)+RN(r,'txAmt')});
    var pCatSum={};SL_CAT_ORDER.forEach(function(c){pCatSum[c]=0});
    SL.prevRaw.forEach(function(r){var c=slCat(String(R(r,'shopType')));pCatSum[c]=(pCatSum[c]||0)+RN(r,'txAmt')});
    SL_CAT_ORDER.forEach(function(c){if(catSum[c]||pCatSum[c])h+=slCd(c,catSum[c]||0,pCatSum[c]||0,1)});
    h+='</div>';

    // 월별 추이
    if(SL.mode==='year'){
        var cByM={},pByM={};
        SL.raw.forEach(function(r){var ym=slYM(R(r,'date'));cByM[ym]=(cByM[ym]||0)+RN(r,'txAmt')});
        SL.prevRaw.forEach(function(r){var ym=slYM(R(r,'date'));pByM[ym]=(pByM[ym]||0)+RN(r,'txAmt')});
        var ms=[];for(var i=1;i<=12;i++)ms.push(('0'+i).slice(-2));
        var data=ms.map(function(mm){return{label:parseInt(mm)+'월',values:[{name:(SL.qY-1)+'',value:pByM[(SL.qY-1)+'-'+mm]||0,color:'#d1d5db'},{name:SL.qY+'',value:cByM[SL.qY+'-'+mm]||0,color:'#4a90d9'}]}});
        h+=slBar(data,'월별 거래액 추이 (전년 비교)',1);
    }

    // 대분류별 차트
    var catChartData=SL_CAT_ORDER.filter(function(c){return catSum[c]}).map(function(c){
        return{label:c,values:[{name:(SL.qY-1)+'',value:pCatSum[c]||0,color:'#d1d5db'},{name:SL.qY+'',value:catSum[c]||0,color:SL_CAT_COLOR[c]||'#4a90d9'}]};
    });
    h+=slBar(catChartData,'대분류별 거래액 (전년 비교)',0);

    // 대분류 > 소분류 테이블
    h+='<div class="sl-cw"><div class="sl-cw__t">대분류 / 제휴점유형별 거래액</div>';
    // 집계
    var catDetail={};
    SL.raw.forEach(function(r){
        var t=String(R(r,'shopType'))||'기타';var cat=slCat(t);
        if(!catDetail[cat])catDetail[cat]={};
        // POS는 'POS' 통합 + 개별 브랜드 별도
        var key=t;
        if(!catDetail[cat][key])catDetail[cat][key]={type:key,tx:0};
        catDetail[cat][key].tx+=RN(r,'txAmt');
    });
    var pCatDetail={};
    SL.prevRaw.forEach(function(r){
        var t=String(R(r,'shopType'))||'기타';var cat=slCat(t);
        if(!pCatDetail[cat])pCatDetail[cat]={};
        if(!pCatDetail[cat][t])pCatDetail[cat][t]={type:t,tx:0};
        pCatDetail[cat][t].tx+=RN(r,'txAmt');
    });

    h+='<table class="sl-t sl-t--s"><thead><tr><th>대분류</th><th>제휴점유형</th><th class="r">거래액</th><th class="r">비중</th><th class="r">전년</th><th class="r">증감률</th></tr></thead><tbody>';
    SL_CAT_ORDER.forEach(function(cat){
        if(!catDetail[cat])return;
        var items=Object.values(catDetail[cat]).sort(function(a,b){return b.tx-a.tx});
        var catTx=catSum[cat]||0;
        // POS 통합행
        var posItems=items.filter(function(x){return/^POS\(/i.test(x.type)});
        var nonPosItems=items.filter(function(x){return!/^POS\(/i.test(x.type)});
        var posTx=0;posItems.forEach(function(x){posTx+=x.tx});
        var pPosTx=0;if(pCatDetail[cat]){Object.values(pCatDetail[cat]).forEach(function(x){if(/^POS\(/i.test(x.type))pPosTx+=x.tx})}

        // 대분류 소계행
        var pCatTx=pCatSum[cat]||0;var cls1=(catTx-pCatTx)>0?'up':(catTx-pCatTx)<0?'down':'flat';
        h+='<tr style="background:#eef4fb;font-weight:600"><td style="color:'+( SL_CAT_COLOR[cat]||'#4a5568')+'">'+cat+'</td><td></td><td class="r">'+slN(catTx)+'</td><td class="r">'+(cT?(catTx/cT*100).toFixed(1):'0')+'%</td><td class="r">'+slN(pCatTx)+'</td><td class="r '+cls1+'">'+slPct(catTx,pCatTx)+'</td></tr>';

        // 비POS 항목
        nonPosItems.forEach(function(item){
            var pv=0;if(pCatDetail[cat]&&pCatDetail[cat][item.type])pv=pCatDetail[cat][item.type].tx;
            var cls=(item.tx-pv)>0?'up':(item.tx-pv)<0?'down':'flat';
            h+='<tr><td></td><td style="padding-left:16px">'+item.type+'</td><td class="r">'+slN(item.tx)+'</td><td class="r">'+(cT?(item.tx/cT*100).toFixed(1):'0')+'%</td><td class="r">'+slN(pv)+'</td><td class="r '+cls+'">'+slPct(item.tx,pv)+'</td></tr>';
        });

        // POS 통합행 + 하위
        if(posItems.length>0){
            var clsP=(posTx-pPosTx)>0?'up':(posTx-pPosTx)<0?'down':'flat';
            h+='<tr style="background:#f8fafd;font-weight:500"><td></td><td style="padding-left:16px">POS ('+posItems.length+'개 브랜드)</td><td class="r">'+slN(posTx)+'</td><td class="r">'+(cT?(posTx/cT*100).toFixed(1):'0')+'%</td><td class="r">'+slN(pPosTx)+'</td><td class="r '+clsP+'">'+slPct(posTx,pPosTx)+'</td></tr>';
            posItems.forEach(function(item){
                var pv=0;if(pCatDetail[cat]&&pCatDetail[cat][item.type])pv=pCatDetail[cat][item.type].tx;
                var cls=(item.tx-pv)>0?'up':(item.tx-pv)<0?'down':'flat';
                h+='<tr><td></td><td style="padding-left:32px;font-size:10px;color:#94a3b8">'+item.type+'</td><td class="r" style="font-size:10px">'+slN(item.tx)+'</td><td class="r" style="font-size:10px">'+(cT?(item.tx/cT*100).toFixed(1):'0')+'%</td><td class="r" style="font-size:10px">'+slN(pv)+'</td><td class="r '+cls+'" style="font-size:10px">'+slPct(item.tx,pv)+'</td></tr>';
            });
        }
    });
    h+='</tbody></table></div>';

    // 연간 모드: 대분류 x 월 피벗
    if(SL.mode==='year'){
        var catPivot={};
        SL.raw.forEach(function(r){var ym=slYM(R(r,'date')),cat=slCat(String(R(r,'shopType')));if(!catPivot[ym])catPivot[ym]={};catPivot[ym][cat]=(catPivot[ym][cat]||0)+RN(r,'txAmt')});
        var ms2=[];for(var j=1;j<=12;j++)ms2.push(SL.qY+'-'+('0'+j).slice(-2));
        var cats=SL_CAT_ORDER.filter(function(c){return catSum[c]});
        h+='<div class="sl-cw"><div class="sl-cw__t">대분류별 월별 거래액 피벗</div><div class="sl-pivot-wrap"><table class="sl-pivot"><thead><tr><th>월</th>';
        cats.forEach(function(c){h+='<th class="r">'+c+'</th>'});h+='<th class="r" style="font-weight:700">합계</th></tr></thead><tbody>';
        var gT=0;ms2.forEach(function(ym){var row=catPivot[ym]||{},rT=0;h+='<tr><td>'+ym+'</td>';cats.forEach(function(c){var v=row[c]||0;rT+=v;h+='<td class="r">'+slN(v)+'</td>'});gT+=rT;h+='<td class="r" style="font-weight:600">'+slN(rT)+'</td></tr>'});
        h+='<tr class="st"><td style="font-weight:700">합계</td>';cats.forEach(function(c){h+='<td class="r">'+slN(catSum[c]||0)+'</td>'});h+='<td class="r" style="font-weight:700">'+slN(gT)+'</td></tr></tbody></table></div></div>';
    }

    $('pTx').innerHTML=h;
}

/* === 6. 지역별 통계 === */
function slGroupArea(rows){
    var map={};rows.forEach(function(r){
        var sido=String(R(r,'comSido'))||'미설정';if(!sido||sido==='undefined')sido='미설정';
        var sigungu=String(R(r,'comSigungu'))||'';
        if(!map[sido])map[sido]={sido:sido,tx:0,sales:0,fee:0,order:0,user:0,comIds:{},sub:{}};
        var g=map[sido];g.tx+=RN(r,'txAmt');g.sales+=RN(r,'sales');g.fee+=RN(r,'shopFee');g.order+=RN(r,'orderCnt');g.user+=RN(r,'userCnt');
        g.comIds[String(R(r,'comId'))]=1;
        if(sigungu){
            if(!g.sub[sigungu])g.sub[sigungu]={sigungu:sigungu,tx:0,sales:0,fee:0,order:0,user:0,comIds:{}};
            var s=g.sub[sigungu];s.tx+=RN(r,'txAmt');s.sales+=RN(r,'sales');s.fee+=RN(r,'shopFee');s.order+=RN(r,'orderCnt');s.user+=RN(r,'userCnt');s.comIds[String(R(r,'comId'))]=1;
        }
    });return Object.values(map).sort(function(a,b){return b.tx-a.tx});
}

function slArea(){
    SL._ac=slGroupArea(SL.raw);SL._ap=slGroupArea(SL.prevRaw);
    var totalTx=0;SL._ac.forEach(function(g){totalTx+=g.tx});SL._areaTotalTx=totalTx;
    // 차트
    var cd=SL._ac.slice(0,15).map(function(g,i){return{label:g.sido.replace('특별시','').replace('광역시','').replace('특별자치시','').replace('특별자치도',''),values:[{name:g.sido,value:g.tx,color:SLC[i%SLC.length]}]}});
    var h=slBar(cd,'시/도별 거래액 (상위 15)',1);
    // 2단
    h+='<div class="sl-grid2">';
    h+='<div class="sl-panel"><div class="sl-panel__head"><span class="sl-panel__title">시/도별 현황 ('+SL._ac.length+')</span></div><div class="sl-tw" id="slATW"></div></div>';
    h+='<div class="sl-panel"><div class="sl-panel__head"><span class="sl-panel__title" id="slADT">시/군/구 상세</span></div><div class="sl-det" id="slAD"><div class="sl-det__empty">좌측에서 시/도를 선택하세요</div></div></div>';
    h+='</div>';
    $('pArea').innerHTML=h;
    slATbl();
    if(SL.areaSel)slADet();
}

function slATbl(){
    var totalTx=SL._areaTotalTx||0;
    var h='<table class="sl-t"><thead><tr><th>시/도</th><th class="r">거래액</th><th class="r">비중</th><th class="r">매출액</th><th class="r">수수료</th><th class="r">주문</th><th class="r">고객사</th><th class="r">전년</th><th class="r">증감률</th></tr></thead><tbody>';
    SL._ac.forEach(function(g){
        var pg=SL._ap.find(function(x){return x.sido===g.sido});var pv=pg?pg.tx:0;var cls=(g.tx-pv)>0?'up':(g.tx-pv)<0?'down':'flat';
        var sel=SL.areaSel===g.sido?'sel':'';
        h+='<tr class="'+sel+'" onclick="slASel(\''+g.sido.replace(/'/g,"\\'")+'\')">';
        h+='<td>'+g.sido+'</td><td class="r">'+slN(g.tx)+'</td><td class="r">'+(totalTx?(g.tx/totalTx*100).toFixed(1):'0')+'%</td>';
        h+='<td class="r">'+slN(g.sales)+'</td><td class="r">'+slN(g.fee)+'</td><td class="r">'+slN(g.order)+'</td>';
        h+='<td class="r">'+Object.keys(g.comIds).length+'</td><td class="r">'+slN(pv)+'</td><td class="r '+cls+'">'+slPct(g.tx,pv)+'</td></tr>';
    });
    h+='</tbody></table>';
    if($('slATW'))$('slATW').innerHTML=h;
}

function slASel(sido){SL.areaSel=sido;slATbl();slADet()}

function slADet(){
    var el=$('slAD');if(!el)return;
    if(!SL.areaSel){el.innerHTML='<div class="sl-det__empty">좌측에서 시/도를 선택하세요</div>';return}
    var g=SL._ac.find(function(x){return x.sido===SL.areaSel});
    if(!g){el.innerHTML='<div class="sl-det__empty">데이터 없음</div>';return}
    var pg=SL._ap.find(function(x){return x.sido===SL.areaSel});
    if($('slADT'))$('slADT').textContent=g.sido+' 상세';
    var h='<div class="sl-det__name">'+g.sido+'</div>';
    h+='<div class="sl-det__grid">';
    function di(l,cv,pv,m){var dv=cv-(pv||0),cls=dv>0?'up':dv<0?'down':'flat';h+='<div class="sl-det__item"><div class="sl-det__il">'+l+'</div><div class="sl-det__iv">'+(m?slS(cv):slN(cv))+'</div>'+(pv!==undefined?'<div class="sl-card__chg '+cls+'" style="font-size:9px">전년 '+(m?slS(pv||0):slN(pv||0))+' / '+slPct(cv,pv||0)+'</div>':'')+'</div>'}
    di('거래액',g.tx,pg?pg.tx:undefined,1);di('매출액',g.sales,pg?pg.sales:undefined,1);
    di('수수료',g.fee,pg?pg.fee:undefined,1);di('고객사',Object.keys(g.comIds).length,pg?Object.keys(pg.comIds).length:undefined,0);
    h+='</div>';
    // 시군구 테이블
    var subs=Object.values(g.sub).sort(function(a,b){return b.tx-a.tx});
    var pSubs=pg?pg.sub:{};
    h+='<div class="sl-det__sec">시/군/구별 현황 ('+subs.length+')</div>';
    h+='<table class="sl-mt"><thead><tr><th>시/군/구</th><th class="r">거래액</th><th class="r">매출액</th><th class="r">주문</th><th class="r">고객사</th><th class="r">전년거래액</th><th class="r">증감률</th></tr></thead><tbody>';
    subs.forEach(function(s){
        var ps=pSubs[s.sigungu];var pv=ps?ps.tx:0;var cls=(s.tx-pv)>0?'up':(s.tx-pv)<0?'down':'flat';
        h+='<tr><td>'+s.sigungu+'</td><td class="r">'+slN(s.tx)+'</td><td class="r">'+slN(s.sales)+'</td><td class="r">'+slN(s.order)+'</td><td class="r">'+Object.keys(s.comIds).length+'</td><td class="r">'+slN(pv)+'</td><td class="r '+cls+'">'+slPct(s.tx,pv)+'</td></tr>';
    });
    h+='</tbody></table>';
    el.innerHTML=h;
}

/* === 6. 최근5년 흐름도 === */
async function slY5(){
    var el=$('pY5');el.innerHTML='<div style="text-align:center;padding:20px;color:#94a3b8">5년 데이터 로딩 중...</div>';
    var now=new Date().getFullYear(),years=[];
    for(var y=now;y>=now-5&&y>=2020;y--)years.push(y);years.reverse();
    var allD={};for(var i=0;i<years.length;i++){try{allD[years[i]]=await slCSV(years[i])}catch(e){allD[years[i]]=[]}}
    var pivot={};years.forEach(function(yr){pivot[yr]={};for(var m=1;m<=12;m++)pivot[yr][('0'+m).slice(-2)]=0;(allD[yr]||[]).forEach(function(r){var ym=slYM(R(r,'date')),mm=ym.split('-')[1];if(mm)pivot[yr][mm]+=RN(r,'txAmt')})});
    var ms=[];for(var k=1;k<=12;k++)ms.push(('0'+k).slice(-2));
    // 월별 바 차트
    var cd=ms.map(function(mm){return{label:parseInt(mm)+'월',values:years.map(function(yr,idx){return{name:yr+'년',value:pivot[yr][mm],color:SLC[idx%SLC.length]}})}});
    var h=slBar(cd,'월별 거래액 추이 (최근 '+years.length+'년)',1);
    // 피벗 테이블
    h+='<div class="sl-pivot-wrap"><table class="sl-pivot"><thead><tr><th>연도</th>';
    ms.forEach(function(mm){h+='<th class="r">'+parseInt(mm)+'월</th>'});h+='<th class="r" style="font-weight:700">합계</th></tr></thead><tbody>';
    years.forEach(function(yr){var total=0;h+='<tr class="yh"><td style="font-weight:700">'+yr+'</td>';ms.forEach(function(mm){var v=pivot[yr][mm];total+=v;h+='<td class="r">'+slS(v)+'</td>'});h+='<td class="r" style="font-weight:700">'+slS(total)+'</td></tr>'});
    h+='</tbody></table></div>';
    // 연간 합계 선그래프
    var yLabels=years.map(function(yr){return yr+''});
    var yData=years.map(function(yr){var t=0;ms.forEach(function(mm){t+=pivot[yr][mm]});return t});
    h+=slLine([{name:'연간 거래액',data:yData,color:'#4a90d9'}],yLabels,'연간 거래액 합계 추이',0);
    // 대분류별 연도 피벗
    var catYr={};years.forEach(function(yr){(allD[yr]||[]).forEach(function(r){
        var cat=slCat(String(R(r,'shopType')));if(!catYr[cat])catYr[cat]={};catYr[cat][yr]=(catYr[cat][yr]||0)+RN(r,'txAmt');
    })});
    var cats=SL_CAT_ORDER.filter(function(c){return catYr[c]});
    // 대분류별 선그래프
    var catSeries=cats.map(function(c,i){return{name:c,data:years.map(function(yr){return(catYr[c]||{})[yr]||0}),color:SL_CAT_COLOR[c]||SLC[i%SLC.length]}});
    h+=slLine(catSeries,yLabels,'대분류별 연간 거래액 추이',1);
    // 대분류 피벗 테이블
    h+='<div class="sl-pivot-wrap"><table class="sl-pivot"><thead><tr><th>대분류</th>';
    years.forEach(function(yr){h+='<th class="r">'+yr+'</th>'});h+='</tr></thead><tbody>';
    cats.forEach(function(c){h+='<tr><td style="color:'+(SL_CAT_COLOR[c]||'#4a5568')+'">'+c+'</td>';years.forEach(function(yr){h+='<td class="r">'+slS((catYr[c]||{})[yr]||0)+'</td>'});h+='</tr>'});
    h+='<tr class="st"><td style="font-weight:700">합계</td>';years.forEach(function(yr){var tot=0;cats.forEach(function(c){tot+=((catYr[c]||{})[yr]||0)});h+='<td class="r" style="font-weight:700">'+slS(tot)+'</td>'});h+='</tr></tbody></table></div>';
    // 소분류별 피벗 (대분류 내 그룹핑)
    var typeYr={};years.forEach(function(yr){(allD[yr]||[]).forEach(function(r){var t=String(R(r,'shopType'))||'기타';if(!typeYr[t])typeYr[t]={cat:slCat(t)};typeYr[t][yr]=(typeYr[t][yr]||0)+RN(r,'txAmt')})});
    h+='<div class="sl-pivot-wrap"><table class="sl-pivot"><thead><tr><th>대분류</th><th>제휴점유형</th>';
    years.forEach(function(yr){h+='<th class="r">'+yr+'</th>'});h+='</tr></thead><tbody>';
    SL_CAT_ORDER.forEach(function(cat){
        if(!catYr[cat])return;
        h+='<tr style="background:#eef4fb;font-weight:600"><td style="color:'+(SL_CAT_COLOR[cat]||'#4a5568')+'">'+cat+'</td><td></td>';
        years.forEach(function(yr){h+='<td class="r">'+slS((catYr[cat]||{})[yr]||0)+'</td>'});h+='</tr>';
        var items=Object.keys(typeYr).filter(function(t){return typeYr[t].cat===cat});
        var posItems=items.filter(function(t){return/^POS\(/i.test(t)});
        var nonPos=items.filter(function(t){return!/^POS\(/i.test(t)}).sort(function(a,b){return(typeYr[b][years[years.length-1]]||0)-(typeYr[a][years[years.length-1]]||0)});
        nonPos.forEach(function(t){h+='<tr><td></td><td style="padding-left:12px">'+t+'</td>';years.forEach(function(yr){h+='<td class="r">'+slS(typeYr[t][yr]||0)+'</td>'});h+='</tr>'});
        if(posItems.length>0){
            h+='<tr style="background:#f8fafd"><td></td><td style="padding-left:12px;font-weight:500">POS ('+posItems.length+'개)</td>';
            years.forEach(function(yr){var pt=0;posItems.forEach(function(t){pt+=(typeYr[t][yr]||0)});h+='<td class="r">'+slS(pt)+'</td>'});h+='</tr>';
        }
    });
    h+='</tbody></table></div>';
    // 고객사 수 선그래프
    var ccData=years.map(function(yr){var ids={};(allD[yr]||[]).forEach(function(r){ids[String(R(r,'comId'))]=1});return Object.keys(ids).length});
    h+=slLine([{name:'고객사 수',data:ccData,color:'#22c55e'}],yLabels,'연간 고객사 수 추이',0);
    el.innerHTML=h;
}
</script>
