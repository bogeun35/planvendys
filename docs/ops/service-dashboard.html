<!--
title: 매출통계 대시보드
meta: 최종 수정: 2026.02.17
-->

<style>
.sl{font-family:'Noto Sans KR',sans-serif;font-size:12px;color:#1a2332;position:relative;min-height:400px}
.sl *{box-sizing:border-box}
.sl-ctrl{display:flex;align-items:center;gap:6px;padding:8px 0;border-bottom:1px solid #e2e8f0;flex-wrap:wrap}
.sl-ctrl label{font-size:11px;color:#94a3b8}
.sl-ctrl select{height:28px;border:1px solid #d1d5db;border-radius:3px;font-size:12px;padding:0 6px;font-family:'JetBrains Mono',monospace;min-width:72px}
.sl-btn{height:28px;padding:0 10px;border:1px solid #d1d5db;border-radius:3px;background:#fff;font-size:11px;cursor:pointer;color:#4a5568;white-space:nowrap}
.sl-btn:hover{background:#f0f4f9}
.sl-btn--hot{border-color:#4a90d9;color:#4a90d9}
.sl-btn--hot.active{background:#4a90d9;color:#fff}
.sl-btn--go{background:#4a90d9;color:#fff;border-color:#4a90d9;font-weight:600}
.sl-btn--go:hover{background:#3a7bc8}
.sl-status{margin-left:auto;font-size:11px;color:#94a3b8}
.sl-sep{width:1px;height:20px;background:#e2e8f0;margin:0 2px}
.sl-load{position:absolute;inset:0;background:rgba(255,255,255,.92);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100}
.sl-load.hide{display:none}
.sl-load__bar{width:200px;height:4px;background:#e2e8f0;border-radius:2px;overflow:hidden}
.sl-load__fill{height:100%;background:#4a90d9;border-radius:2px;transition:width .3s}
.sl-load__txt{font-size:11px;color:#94a3b8;margin-top:6px}
.sl-tabs{display:flex;gap:0;border-bottom:2px solid #e2e8f0;margin-top:8px}
.sl-tab{padding:6px 14px;font-size:12px;color:#94a3b8;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;font-weight:500;white-space:nowrap}
.sl-tab:hover{color:#4a5568}
.sl-tab.active{color:#4a90d9;border-bottom-color:#4a90d9;font-weight:600}
.sl-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;margin:10px 0}
.sl-card{background:#f8fafd;border:1px solid #e2e8f0;border-radius:4px;padding:8px 10px}
.sl-card__lbl{font-size:10px;color:#94a3b8;margin-bottom:2px}
.sl-card__val{font-size:15px;font-weight:700;font-family:'JetBrains Mono',monospace;color:#1a2332}
.sl-card__chg{font-size:10px;font-family:'JetBrains Mono',monospace;margin-top:1px}
.up{color:#22c55e}.down{color:#e85d5d}.flat{color:#94a3b8}
.sl-cw{background:#f8fafd;border:1px solid #e2e8f0;border-radius:4px;padding:10px;margin:8px 0}
.sl-cw__t{font-size:11px;font-weight:600;color:#4a5568;margin-bottom:6px}
.sl-chart{width:100%;height:160px;display:flex;align-items:flex-end;gap:1px}
.sl-chart--tall{height:220px}
.sl-chart-col{flex:1;display:flex;gap:1px;align-items:flex-end;height:100%}
.sl-chart-bar{flex:1;border-radius:2px 2px 0 0;position:relative;cursor:pointer;transition:opacity .15s;min-height:2px}
.sl-chart-bar:hover{opacity:.75}
.sl-chart-tip{position:absolute;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%);background:#1a2332;color:#fff;padding:2px 6px;border-radius:3px;font-size:10px;white-space:nowrap;display:none;z-index:10;font-family:'JetBrains Mono',monospace}
.sl-chart-bar:hover .sl-chart-tip{display:block}
.sl-chart-labels{display:flex;gap:1px;margin-top:3px}
.sl-chart-labels span{flex:1;text-align:center;font-size:9px;color:#94a3b8}
.sl-legend{display:flex;gap:12px;margin-top:4px;font-size:10px;color:#94a3b8;flex-wrap:wrap}
.sl-legend i{display:inline-block;width:8px;height:8px;border-radius:1px;margin-right:3px;vertical-align:middle}
.sl-grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:8px 0}
.sl-panel{border:1px solid #e2e8f0;border-radius:4px;overflow:hidden;display:flex;flex-direction:column}
.sl-panel__head{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;background:#f8fafd;border-bottom:1px solid #e2e8f0;gap:4px}
.sl-panel__title{font-size:11px;font-weight:600;color:#4a5568;white-space:nowrap}
.sl-search{height:24px;border:1px solid #d1d5db;border-radius:3px;font-size:11px;padding:0 6px;width:140px}
.sl-copy-btn{height:24px;padding:0 8px;border:1px solid #d1d5db;border-radius:3px;background:#fff;font-size:10px;cursor:pointer;color:#4a5568}
.sl-copy-btn:hover{background:#f0f4f9}
.sl-copy-btn.copied{background:#22c55e;color:#fff;border-color:#22c55e}
.sl-tw{overflow:auto;flex:1;max-height:420px}
.sl-t{width:100%;border-collapse:collapse;font-size:11px}
.sl-t thead{position:sticky;top:0;z-index:5}
.sl-t th{background:#f0f4f9;padding:4px 6px;text-align:left;font-weight:600;color:#4a5568;border-bottom:1px solid #d1d5db;cursor:pointer;white-space:nowrap;font-size:10px;user-select:none}
.sl-t th:hover{background:#e2e8f0}
.sl-t th.r,.sl-t td.r{text-align:right;font-family:'JetBrains Mono',monospace}
.sl-t th .a{font-size:8px;margin-left:2px;color:#94a3b8}
.sl-t th.s .a{color:#4a90d9}
.sl-t td{padding:4px 6px;border-bottom:1px solid #f0f4f9;white-space:nowrap}
.sl-t td.id{font-size:9px;color:#94a3b8;font-family:'JetBrains Mono',monospace;max-width:80px;overflow:hidden;text-overflow:ellipsis}
.sl-t tr:hover{background:#f8fafd}
.sl-t tr.sel{background:#eef4fb}
.sl-t tr{cursor:pointer}
.sl-t--s th{cursor:default}.sl-t--s th:hover{background:#f0f4f9}
.sl-det{padding:8px;font-size:11px;overflow:auto;max-height:420px}
.sl-det__empty{color:#94a3b8;text-align:center;padding:40px 0}
.sl-det__name{font-size:14px;font-weight:700;margin-bottom:1px}
.sl-det__meta{font-size:10px;color:#94a3b8;margin-bottom:8px;word-break:break-all}
.sl-det__grid{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:8px}
.sl-det__item{background:#f8fafd;padding:4px 8px;border-radius:3px}
.sl-det__il{font-size:9px;color:#94a3b8}
.sl-det__iv{font-size:13px;font-weight:600;font-family:'JetBrains Mono',monospace}
.sl-det__sec{font-size:11px;font-weight:600;color:#4a5568;margin:6px 0 4px;padding-bottom:2px;border-bottom:1px solid #e2e8f0}
.sl-mt{width:100%;border-collapse:collapse;font-size:10px}
.sl-mt th{background:#f0f4f9;padding:3px 6px;text-align:left;font-weight:600;color:#4a5568;border-bottom:1px solid #d1d5db}
.sl-mt th.r,.sl-mt td.r{text-align:right;font-family:'JetBrains Mono',monospace}
.sl-mt td{padding:3px 6px;border-bottom:1px solid #f0f4f9}
.sl-pivot-wrap{overflow:auto;margin:8px 0}
.sl-pivot{border-collapse:collapse;font-size:11px;width:100%}
.sl-pivot th,.sl-pivot td{padding:4px 8px;border:1px solid #e2e8f0;white-space:nowrap}
.sl-pivot th{background:#f0f4f9;font-weight:600;color:#4a5568;font-size:10px;position:sticky;top:0;z-index:2}
.sl-pivot td.r{text-align:right;font-family:'JetBrains Mono',monospace}
.sl-pivot tr:hover{background:#f8fafd}
.sl-pivot .yh{background:#eef4fb;font-weight:600}
.sl-pivot .st{background:#f0f4f9;font-weight:600}
.sl-pane{display:none}.sl-pane.active{display:block}
@media(max-width:900px){.sl-grid2{grid-template-columns:1fr}}
</style>

<div class="sl" id="slRoot">
  <div class="sl-load hide" id="slLoad"><div class="sl-load__bar"><div class="sl-load__fill" id="slFill" style="width:0%"></div></div><div class="sl-load__txt" id="slTxt">로딩 중...</div></div>
  <div class="sl-ctrl">
    <label>기간</label>
    <select id="slMode" onchange="slMC()"><option value="month">월별</option><option value="year">연간</option></select>
    <select id="slYear"></select><select id="slMonth"></select>
    <button class="sl-btn sl-btn--go" onclick="slFetch()">조회</button><div class="sl-sep"></div>
    <button class="sl-btn sl-btn--hot" onclick="slHot('tm',this)">이번달</button>
    <button class="sl-btn sl-btn--hot" onclick="slHot('lm',this)">지난달</button>
    <button class="sl-btn sl-btn--hot" onclick="slHot('2m',this)">지지난달</button>
    <button class="sl-btn sl-btn--hot" onclick="slHot('ty',this)">올해</button>
    <button class="sl-btn sl-btn--hot" onclick="slHot('ly',this)">작년</button>
    <div class="sl-status" id="slStat"></div>
  </div>
  <div class="sl-tabs">
    <div class="sl-tab active" onclick="slTab('svc',this)">서비스 통계</div>
    <div class="sl-tab" onclick="slTab('com',this)">고객사 통계</div>
    <div class="sl-tab" onclick="slTab('shop',this)">제휴점 통계</div>
    <div class="sl-tab" onclick="slTab('fee',this)">수수료 통계</div>
    <div class="sl-tab" onclick="slTab('tx',this)">거래액 통계</div>
    <div class="sl-tab" onclick="slTab('y5',this)">최근5년 흐름도</div>
  </div>
  <div id="slBody" style="display:none">
    <div class="sl-pane active" id="pSvc"></div>
    <div class="sl-pane" id="pCom"></div>
    <div class="sl-pane" id="pShop"></div>
    <div class="sl-pane" id="pFee"></div>
    <div class="sl-pane" id="pTx"></div>
    <div class="sl-pane" id="pY5"></div>
  </div>
  <div id="slEmpty" style="display:none;text-align:center;padding:60px 0;color:#94a3b8">조회 버튼을 눌러주세요</div>
</div>

<script>
var SL={BASE:'/planvendys/data/stats-',cache:{},raw:[],prevRaw:[],mode:'month',qY:2025,qM:0,curTab:'svc',comSort:'txAmount',comDir:'desc',comSel:null,_y5:false};
var SLC=['#4a90d9','#22c55e','#d49a2a','#e85d5d','#8b5cf6','#06b6d4','#f59e0b','#ec4899','#10b981','#6366f1'];

function slN(v){v=Number(v)||0;if(!v)return'0';return(v<0?'-':'')+Math.abs(v).toLocaleString()}
function slS(v){v=Number(v)||0;var p=v<0?'-':'',a=Math.abs(v);if(a>=1e8)return p+(a/1e8).toFixed(1)+'억';if(a>=1e4)return p+Math.round(a/1e4)+'만';return p+a.toLocaleString()}
function slD(v){v=Number(v)||0;if(!v)return'-';return(v>0?'+':'')+slN(v)}
function slPct(c,p){c=Number(c)||0;p=Number(p)||0;if(!p)return c?'NEW':'-';var r=((c-p)/Math.abs(p)*100).toFixed(1);return(c-p>0?'+':'')+r+'%'}
function slNum(v){if(v==null||v==='')return 0;return Number(String(v).replace(/,/g,''))||0}
function slYM(s){if(!s)return'';s=String(s).trim();var m=s.match(/^(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})$/);if(m)return m[1]+'-'+('0'+m[2]).slice(-2);var m2=s.match(/^(\d{4})-(\d{2})/);if(m2)return m2[1]+'-'+m2[2];return''}

/* 초기화 */
(async function(){
    var now=new Date(),y=now.getFullYear(),m=now.getMonth();
    var sy=document.getElementById('slYear'),sm=document.getElementById('slMonth');
    for(var i=2020;i<=y;i++){var o=document.createElement('option');o.value=i;o.textContent=i+'년';sy.appendChild(o)}
    for(var j=0;j<12;j++){var o2=document.createElement('option');o2.value=j;o2.textContent=(j+1)+'월';sm.appendChild(o2)}
    var iy=y;try{var t=await fetch(SL.BASE+y+'.csv',{method:'HEAD'});if(!t.ok)iy=y-1}catch(e){iy=y-1}
    sy.value=iy;sm.value=iy<y?11:m;slFetch();
})();

function slMC(){SL.mode=document.getElementById('slMode').value;document.getElementById('slMonth').style.display=SL.mode==='year'?'none':''}

function slHot(k,el){
    var now=new Date(),y=now.getFullYear(),m=now.getMonth();
    document.querySelectorAll('.sl-btn--hot').forEach(function(b){b.classList.remove('active')});
    if(el)el.classList.add('active');var md='month';
    switch(k){
        case'tm':SL.qY=y;SL.qM=m;break;case'lm':var d=new Date(y,m-1,1);SL.qY=d.getFullYear();SL.qM=d.getMonth();break;
        case'2m':var d2=new Date(y,m-2,1);SL.qY=d2.getFullYear();SL.qM=d2.getMonth();break;
        case'ty':SL.qY=y;md='year';break;case'ly':SL.qY=y-1;md='year';break;
    }
    SL.mode=md;document.getElementById('slMode').value=md;document.getElementById('slYear').value=SL.qY;
    if(md==='month')document.getElementById('slMonth').value=SL.qM;slMC();slFetch();
}

function slSh(p,t){document.getElementById('slLoad').classList.remove('hide');document.getElementById('slFill').style.width=p+'%';document.getElementById('slTxt').textContent=t}
function slHd(){document.getElementById('slLoad').classList.add('hide')}

async function slCSV(year){
    if(SL.cache[year])return SL.cache[year];
    var r=await fetch(SL.BASE+year+'.csv');if(!r.ok)return[];
    var txt=await r.text();var lines=txt.split('\n');if(lines.length<2)return[];
    var sep=lines[0].indexOf('\t')>=0?'\t':',';
    var hdr=lines[0].split(sep).map(function(h){return h.trim().replace(/\r|"/g,'')});var res=[];
    for(var i=1;i<lines.length;i++){var ln=lines[i].trim();if(!ln)continue;var v=ln.split(sep).map(function(x){return x.trim().replace(/\r|"/g,'')});var row={};hdr.forEach(function(h,j){row[h]=v[j]||''});res.push(row)}
    SL.cache[year]=res;return res;
}

async function slFetch(){
    SL.qY=parseInt(document.getElementById('slYear').value);SL.qM=parseInt(document.getElementById('slMonth').value);SL.mode=document.getElementById('slMode').value;
    slSh(10,'데이터 로딩 중...');
    try{
        var rows=await slCSV(SL.qY);slSh(40,'전년 데이터...');var prev=await slCSV(SL.qY-1);
        if(SL.mode==='month'){
            var ym=SL.qY+'-'+('0'+(SL.qM+1)).slice(-2);SL.raw=rows.filter(function(r){return slYM(r['날짜'])===ym});
            var pym=(SL.qY-1)+'-'+('0'+(SL.qM+1)).slice(-2);SL.prevRaw=prev.filter(function(r){return slYM(r['날짜'])===pym});
        }else{SL.raw=rows;SL.prevRaw=prev}
        slSh(80,'렌더링...');slRender();slHd();
        document.getElementById('slStat').textContent=(SL.mode==='year'?SL.qY+'년':SL.qY+'.'+(SL.qM+1)+'월')+' / '+SL.raw.length.toLocaleString()+'건';
        document.getElementById('slBody').style.display='block';document.getElementById('slEmpty').style.display='none';
    }catch(ex){slHd();document.getElementById('slStat').textContent='오류: '+ex.message}
}

function slTab(id,el){
    SL.curTab=id;document.querySelectorAll('.sl-tab').forEach(function(t){t.classList.remove('active')});if(el)el.classList.add('active');
    document.querySelectorAll('.sl-pane').forEach(function(p){p.classList.remove('active')});
    document.getElementById({svc:'pSvc',com:'pCom',shop:'pShop',fee:'pFee',tx:'pTx',y5:'pY5'}[id]).classList.add('active');
    if(id==='y5'&&!SL._y5){slY5();SL._y5=true}
}

function slRender(){SL._y5=false;slSvc();slCom();slShop();slFee();slTx();if(SL.curTab==='y5')slY5()}

function slBar(data,title,tall){
    var av=[];data.forEach(function(d){d.values.forEach(function(v){av.push(v.value)})});var mx=Math.max.apply(null,av)||1;
    var h='<div class="sl-cw"><div class="sl-cw__t">'+title+'</div><div class="sl-chart'+(tall?' sl-chart--tall':'')+'">';
    data.forEach(function(d){h+='<div class="sl-chart-col">';d.values.forEach(function(v){var ht=Math.max(v.value/mx*100,1);h+='<div class="sl-chart-bar" style="height:'+ht+'%;background:'+v.color+'"><div class="sl-chart-tip">'+v.name+': '+slS(v.value)+'</div></div>'});h+='</div>'});
    h+='</div><div class="sl-chart-labels">';data.forEach(function(d){h+='<span>'+d.label+'</span>'});h+='</div>';
    if(data.length>0&&data[0].values.length>1){h+='<div class="sl-legend">';data[0].values.forEach(function(v){h+='<span><i style="background:'+v.color+'"></i>'+v.name+'</span>'});h+='</div>'}
    return h+'</div>';
}

function slCd(l,c,p,m){var d=c-(p||0),cls=d>0?'up':d<0?'down':'flat';return'<div class="sl-card"><div class="sl-card__lbl">'+l+'</div><div class="sl-card__val">'+(m?slS(c):slN(c))+'</div><div class="sl-card__chg '+cls+'">전년 '+(m?slS(p||0):slN(p||0))+' / '+slPct(c,p)+'</div></div>'}


/* === 1. 서비스 통계 === */
function slSvc(){
    var cs={tx:0,sales:0,order:0,user:0,solo:0,tg:0,cancel:0,normal:0,admin:0,easy:0,meal:0,dj:0,cp:0,pt:0,dlv:0};
    var ps={tx:0,sales:0,order:0,user:0,solo:0,tg:0,cancel:0,normal:0,admin:0,easy:0,meal:0,dj:0,cp:0,pt:0,dlv:0};
    function ag(rows,s){rows.forEach(function(r){s.tx+=slNum(r['거래액']);s.sales+=slNum(r['매출액']);s.order+=slNum(r['주문 수']);s.user+=slNum(r['고유 사용자 수']);s.solo+=slNum(r['혼자결제']);s.tg+=slNum(r['함께결제']);s.cancel+=slNum(r['취소거래']);s.normal+=slNum(r['정상거래']);s.admin+=slNum(r['관리자입력']);s.easy+=slNum(r['간편결제']);s.meal+=slNum(r['식대/복지 포인트']);s.dj+=slNum(r['대장포인트']);s.cp+=slNum(r['대장쿠폰']);s.pt+=slNum(r['포인트 사용 합계']);s.dlv+=slNum(r['배송비'])})}
    ag(SL.raw,cs);ag(SL.prevRaw,ps);
    var h='<div class="sl-cards">'+slCd('거래액',cs.tx,ps.tx,1)+slCd('매출액',cs.sales,ps.sales,1)+slCd('주문 수',cs.order,ps.order,0)+slCd('고유 사용자',cs.user,ps.user,0)+slCd('포인트 합계',cs.pt,ps.pt,1)+slCd('배송비',cs.dlv,ps.dlv,1)+'</div>';
    var pd=[{label:'혼자',values:[{name:'전년',value:ps.solo,color:'#d1d5db'},{name:'당기',value:cs.solo,color:'#4a90d9'}]},{label:'함께',values:[{name:'전년',value:ps.tg,color:'#d1d5db'},{name:'당기',value:cs.tg,color:'#4a90d9'}]},{label:'정상',values:[{name:'전년',value:ps.normal,color:'#d1d5db'},{name:'당기',value:cs.normal,color:'#4a90d9'}]},{label:'취소',values:[{name:'전년',value:ps.cancel,color:'#d1d5db'},{name:'당기',value:cs.cancel,color:'#e85d5d'}]},{label:'관리자',values:[{name:'전년',value:ps.admin,color:'#d1d5db'},{name:'당기',value:cs.admin,color:'#d49a2a'}]}];
    var pt2=[{label:'식대/복지',values:[{name:'전년',value:ps.meal,color:'#d1d5db'},{name:'당기',value:cs.meal,color:'#22c55e'}]},{label:'대장PT',values:[{name:'전년',value:ps.dj,color:'#d1d5db'},{name:'당기',value:cs.dj,color:'#22c55e'}]},{label:'쿠폰',values:[{name:'전년',value:ps.cp,color:'#d1d5db'},{name:'당기',value:cs.cp,color:'#22c55e'}]},{label:'간편결제',values:[{name:'전년',value:ps.easy,color:'#d1d5db'},{name:'당기',value:cs.easy,color:'#22c55e'}]}];
    h+='<div class="sl-grid2">'+slBar(pd,'결제방식별 건수')+slBar(pt2,'포인트/결제 구성')+'</div>';
    h+='<div class="sl-cw"><div class="sl-cw__t">상세 비교</div><table class="sl-t sl-t--s"><thead><tr><th>구분</th><th class="r">당기</th><th class="r">전년</th><th class="r">증감</th><th class="r">증감률</th></tr></thead><tbody>';
    function dr(l,c,p){var d=c-p,cls=d>0?'up':d<0?'down':'flat';return'<tr><td>'+l+'</td><td class="r">'+slN(c)+'</td><td class="r">'+slN(p)+'</td><td class="r '+cls+'">'+slD(d)+'</td><td class="r '+cls+'">'+slPct(c,p)+'</td></tr>'}
    h+=dr('혼자결제',cs.solo,ps.solo)+dr('함께결제',cs.tg,ps.tg)+dr('정상거래',cs.normal,ps.normal)+dr('취소거래',cs.cancel,ps.cancel)+dr('관리자입력',cs.admin,ps.admin);
    h+='<tr><td colspan="5" style="height:4px;border:none"></td></tr>';
    h+=dr('식대/복지 포인트',cs.meal,ps.meal)+dr('대장포인트',cs.dj,ps.dj)+dr('대장쿠폰',cs.cp,ps.cp)+dr('간편결제',cs.easy,ps.easy)+dr('포인트 합계',cs.pt,ps.pt);
    h+='<tr><td colspan="5" style="height:4px;border:none"></td></tr>';
    h+=dr('거래액',cs.tx,ps.tx)+dr('매출액',cs.sales,ps.sales)+dr('배송비',cs.dlv,ps.dlv);
    h+='</tbody></table></div>';
    document.getElementById('pSvc').innerHTML=h;
}

/* === 2. 고객사 통계 === */
function slGC(rows){
    var map={};rows.forEach(function(r){var id=String(r['고객사ID']||'');if(!id)return;if(!map[id])map[id]={id:id,name:String(r['고객사명']||''),group:String(r['고객사그룹']||''),type:String(r['제휴점유형']||''),txAmount:0,salesAmount:0,billAmount:0,settleAmount:0,orderCount:0,userCount:0,txCount:0,cancelCount:0,soloCount:0,tgCount:0,ptTotal:0,meal:0,dj:0,cp:0,easy:0,dlv:0};
    var g=map[id];g.txAmount+=slNum(r['거래액']);g.salesAmount+=slNum(r['매출액']);g.billAmount+=slNum(r['고객사 청구 금액']);g.settleAmount+=slNum(r['제휴점 정산 금액']);g.orderCount+=slNum(r['주문 수']);g.userCount+=slNum(r['고유 사용자 수']);g.txCount+=slNum(r['정상거래']);g.cancelCount+=slNum(r['취소거래']);g.soloCount+=slNum(r['혼자결제']);g.tgCount+=slNum(r['함께결제']);g.ptTotal+=slNum(r['포인트 사용 합계']);g.meal+=slNum(r['식대/복지 포인트']);g.dj+=slNum(r['대장포인트']);g.cp+=slNum(r['대장쿠폰']);g.easy+=slNum(r['간편결제']);g.dlv+=slNum(r['배송비'])});
    return Object.values(map);
}

function slCom(){
    SL._cc=slGC(SL.raw);SL._cp=slGC(SL.prevRaw);SL.comSel=null;
    var ct=0,cs2=0,co=0,cu=0,cc=SL._cc.length;SL._cc.forEach(function(g){ct+=g.txAmount;cs2+=g.salesAmount;co+=g.orderCount;cu+=g.userCount});
    var pt=0,ps2=0,po=0,pu=0,pc=SL._cp.length;SL._cp.forEach(function(g){pt+=g.txAmount;ps2+=g.salesAmount;po+=g.orderCount;pu+=g.userCount});
    var h='<div class="sl-cards">'+slCd('거래액',ct,pt,1)+slCd('매출액',cs2,ps2,1)+slCd('주문 수',co,po,0)+slCd('고유 사용자',cu,pu,0)+slCd('고객사 수',cc,pc,0)+'</div>';
    var so=SL._cc.slice().sort(function(a,b){return b.txAmount-a.txAmount});var tot=ct||1,t5=0,t10=0,t20=0;
    so.forEach(function(g,i){if(i<5)t5+=g.txAmount;if(i<10)t10+=g.txAmount;if(i<20)t20+=g.txAmount});
    h+='<div class="sl-cw"><div class="sl-cw__t">상위 고객사 집중도</div><table class="sl-t sl-t--s"><thead><tr><th>구분</th><th class="r">거래액</th><th class="r">비중</th></tr></thead><tbody>';
    h+='<tr><td>Top 5</td><td class="r">'+slS(t5)+'</td><td class="r">'+(t5/tot*100).toFixed(1)+'%</td></tr>';
    h+='<tr><td>Top 10</td><td class="r">'+slS(t10)+'</td><td class="r">'+(t10/tot*100).toFixed(1)+'%</td></tr>';
    h+='<tr><td>Top 20</td><td class="r">'+slS(t20)+'</td><td class="r">'+(t20/tot*100).toFixed(1)+'%</td></tr>';
    h+='<tr><td>전체 ('+cc+'사)</td><td class="r">'+slS(ct)+'</td><td class="r">100%</td></tr></tbody></table></div>';
    h+='<div class="sl-grid2"><div class="sl-panel"><div class="sl-panel__head"><span class="sl-panel__title" id="slCTT">고객사 ('+cc+')</span><div style="display:flex;align-items:center;gap:4px"><input class="sl-search" id="slCSch" placeholder="고객사/그룹 검색..." oninput="slCT()"><button class="sl-copy-btn" id="slCCp" onclick="slCC()">복사</button></div></div><div class="sl-tw" id="slCTW"></div></div>';
    h+='<div class="sl-panel"><div class="sl-panel__head"><span class="sl-panel__title">고객사 상세</span></div><div class="sl-det" id="slCD"><div class="sl-det__empty">좌측에서 고객사를 선택하세요</div></div></div></div>';
    document.getElementById('pCom').innerHTML=h;slCT();
}

function slCS(c){if(SL.comSort===c)SL.comDir=SL.comDir==='desc'?'asc':'desc';else{SL.comSort=c;SL.comDir='desc'}slCT()}

function slCT(){
    var sch=(document.getElementById('slCSch')?document.getElementById('slCSch').value:'').toLowerCase();
    var data=SL._cc.slice();if(sch)data=data.filter(function(g){return g.name.toLowerCase().indexOf(sch)!==-1||g.group.toLowerCase().indexOf(sch)!==-1||g.id.toLowerCase().indexOf(sch)!==-1});
    var c=SL.comSort,d=SL.comDir==='asc'?1:-1;data.sort(function(a,b){var va=a[c],vb=b[c];if(typeof va==='string')return va.localeCompare(vb)*d;return((va||0)-(vb||0))*d});
    var cols=[{k:'id',l:'고객사ID',n:0},{k:'name',l:'고객사명',n:0},{k:'group',l:'그룹',n:0},{k:'txAmount',l:'거래액(원)',n:1},{k:'salesAmount',l:'매출액(원)',n:1},{k:'billAmount',l:'청구(원)',n:1},{k:'orderCount',l:'주문',n:1},{k:'userCount',l:'사용자',n:1}];
    var h='<table class="sl-t"><thead><tr>';
    cols.forEach(function(c2){var s=SL.comSort===c2.k,ar=s?(SL.comDir==='asc'?'&#9650;':'&#9660;'):'&#9650;';h+='<th class="'+(c2.n?'r ':'')+(s?'s ':'')+'" onclick="slCS(\''+c2.k+'\')">'+c2.l+'<span class="a">'+ar+'</span></th>'});
    h+='</tr></thead><tbody>';
    data.forEach(function(g){h+='<tr class="'+(SL.comSel===g.id?'sel':'')+'" onclick="slCSel(\''+g.id+'\')"><td class="id" title="'+g.id+'">'+g.id.substring(0,8)+'...</td><td>'+g.name+'</td><td>'+g.group+'</td><td class="r">'+slN(g.txAmount)+'</td><td class="r">'+slN(g.salesAmount)+'</td><td class="r">'+slN(g.billAmount)+'</td><td class="r">'+slN(g.orderCount)+'</td><td class="r">'+slN(g.userCount)+'</td></tr>'});
    h+='</tbody></table>';
    if(document.getElementById('slCTW'))document.getElementById('slCTW').innerHTML=h;
    if(document.getElementById('slCTT'))document.getElementById('slCTT').textContent='고객사 ('+data.length+')';
}

function slCSel(id){SL.comSel=id;slCT();slCDet()}

function slCDet(){
    var el=document.getElementById('slCD');if(!el)return;
    if(!SL.comSel){el.innerHTML='<div class="sl-det__empty">좌측에서 고객사를 선택하세요</div>';return}
    var g=SL._cc.find(function(x){return x.id===SL.comSel});if(!g){el.innerHTML='<div class="sl-det__empty">데이터 없음</div>';return}
    var pg=SL._cp.find(function(x){return x.id===g.id});
    var h='<div class="sl-det__name">'+g.name+'</div><div class="sl-det__meta">'+g.id+'<br>'+g.group+' / '+g.type+'</div><div class="sl-det__grid">';
    function di(l,cv,pv,m){var dv=cv-(pv||0),cls=dv>0?'up':dv<0?'down':'flat';h+='<div class="sl-det__item"><div class="sl-det__il">'+l+'</div><div class="sl-det__iv">'+(m?slS(cv):slN(cv))+'</div>'+(pv!==undefined?'<div class="sl-card__chg '+cls+'" style="font-size:9px">전년 '+(m?slS(pv||0):slN(pv||0))+' / '+slPct(cv,pv||0)+'</div>':'')+'</div>'}
    di('거래액',g.txAmount,pg?pg.txAmount:undefined,1);di('매출액',g.salesAmount,pg?pg.salesAmount:undefined,1);di('청구',g.billAmount,pg?pg.billAmount:undefined,1);di('정산',g.settleAmount,pg?pg.settleAmount:undefined,1);di('주문',g.orderCount,pg?pg.orderCount:undefined,0);di('사용자',g.userCount,pg?pg.userCount:undefined,0);
    h+='</div><div class="sl-det__sec">결제</div><table class="sl-mt"><tr><th>구분</th><th class="r">건수</th></tr><tr><td>혼자</td><td class="r">'+slN(g.soloCount)+'</td></tr><tr><td>함께</td><td class="r">'+slN(g.tgCount)+'</td></tr><tr><td>취소</td><td class="r">'+slN(g.cancelCount)+'</td></tr></table>';
    h+='<div class="sl-det__sec">포인트</div><table class="sl-mt"><tr><th>구분</th><th class="r">금액</th></tr><tr><td>식대/복지</td><td class="r">'+slN(g.meal)+'</td></tr><tr><td>대장PT</td><td class="r">'+slN(g.dj)+'</td></tr><tr><td>쿠폰</td><td class="r">'+slN(g.cp)+'</td></tr><tr><td>간편결제</td><td class="r">'+slN(g.easy)+'</td></tr><tr style="font-weight:600"><td>합계</td><td class="r">'+slN(g.ptTotal)+'</td></tr></table>';
    if(g.dlv)h+='<div class="sl-det__sec">배송비</div><div style="font-family:JetBrains Mono;font-size:13px;font-weight:600">'+slN(g.dlv)+'원</div>';
    el.innerHTML=h;
}

function slCC(){
    var data=SL._cc.slice().sort(function(a,b){var c=SL.comSort,d=SL.comDir==='asc'?1:-1;var va=a[c],vb=b[c];if(typeof va==='string')return va.localeCompare(vb)*d;return((va||0)-(vb||0))*d});
    var lines=['고객사ID\t고객사명\t그룹\t거래액\t매출액\t청구\t주문\t사용자'];
    data.forEach(function(g){lines.push(g.id+'\t'+g.name+'\t'+g.group+'\t'+g.txAmount+'\t'+g.salesAmount+'\t'+g.billAmount+'\t'+g.orderCount+'\t'+g.userCount)});
    navigator.clipboard.writeText(lines.join('\n')).then(function(){var b=document.getElementById('slCCp');b.classList.add('copied');b.textContent='완료';setTimeout(function(){b.classList.remove('copied');b.textContent='복사'},1500)});
}

/* === 3. 제휴점 통계 === */
function slShop(){
    var cM={},pM={};
    function ag(rows,map){rows.forEach(function(r){var t=String(r['제휴점유형']||'기타');if(!map[t])map[t]={type:t,tx:0,sales:0,order:0,user:0,txCnt:0,cancel:0,cids:{}};var g=map[t];g.tx+=slNum(r['거래액']);g.sales+=slNum(r['매출액']);g.order+=slNum(r['주문 수']);g.user+=slNum(r['고유 사용자 수']);g.txCnt+=slNum(r['정상거래']);g.cancel+=slNum(r['취소거래']);g.cids[String(r['고객사ID']||'')]=1})}
    ag(SL.raw,cM);ag(SL.prevRaw,pM);
    var cur=Object.values(cM).sort(function(a,b){return b.tx-a.tx});var prev=Object.values(pM);
    var total=0;cur.forEach(function(g){total+=g.tx});
    var cd=cur.map(function(g,i){return{label:g.type.length>8?g.type.substring(0,8)+'..':g.type,values:[{name:g.type,value:g.tx,color:SLC[i%SLC.length]}]}});
    var h=slBar(cd,'제휴점 유형별 거래액',1);
    h+='<div class="sl-cw"><div class="sl-cw__t">제휴점 유형별 상세</div><table class="sl-t sl-t--s"><thead><tr><th>제휴점유형</th><th class="r">거래액</th><th class="r">비중</th><th class="r">매출액</th><th class="r">주문</th><th class="r">사용자</th><th class="r">고객사</th><th class="r">전년거래액</th><th class="r">증감률</th></tr></thead><tbody>';
    cur.forEach(function(g){var pg=prev.find(function(x){return x.type===g.type});var pv=pg?pg.tx:0;var cls=(g.tx-pv)>0?'up':(g.tx-pv)<0?'down':'flat';
    h+='<tr><td>'+g.type+'</td><td class="r">'+slN(g.tx)+'</td><td class="r">'+(total?(g.tx/total*100).toFixed(1):'0')+'%</td><td class="r">'+slN(g.sales)+'</td><td class="r">'+slN(g.order)+'</td><td class="r">'+slN(g.user)+'</td><td class="r">'+Object.keys(g.cids).length+'</td><td class="r">'+slN(pv)+'</td><td class="r '+cls+'">'+slPct(g.tx,pv)+'</td></tr>'});
    h+='</tbody></table></div>';document.getElementById('pShop').innerHTML=h;
}

/* === 4. 수수료 통계 === */
function slFee(){
    var cS=0,cT=0,cB=0,cSt=0,pS=0,pT=0,pB=0,pSt=0;
    SL.raw.forEach(function(r){cS+=slNum(r['매출액']);cT+=slNum(r['거래액']);cB+=slNum(r['고객사 청구 금액']);cSt+=slNum(r['제휴점 정산 금액'])});
    SL.prevRaw.forEach(function(r){pS+=slNum(r['매출액']);pT+=slNum(r['거래액']);pB+=slNum(r['고객사 청구 금액']);pSt+=slNum(r['제휴점 정산 금액'])});
    var cF=cB-cSt,pF=pB-pSt,cR=cT?(cS/cT*100):0,pR=pT?(pS/pT*100):0;
    var h='<div class="sl-cards">'+slCd('매출액(수수료)',cS,pS,1)+slCd('거래액',cT,pT,1)+slCd('청구',cB,pB,1)+slCd('정산',cSt,pSt,1)+slCd('청구-정산',cF,pF,1);
    h+='<div class="sl-card"><div class="sl-card__lbl">매출/거래 비율</div><div class="sl-card__val">'+cR.toFixed(2)+'%</div><div class="sl-card__chg '+(cR>pR?'up':'down')+'">전년 '+pR.toFixed(2)+'%</div></div></div>';
    if(SL.mode==='year'){
        var cByM={},pByM={};
        SL.raw.forEach(function(r){var ym=slYM(r['날짜']);cByM[ym]=(cByM[ym]||0)+slNum(r['매출액'])});
        SL.prevRaw.forEach(function(r){var ym=slYM(r['날짜']);pByM[ym]=(pByM[ym]||0)+slNum(r['매출액'])});
        var ms=[];for(var i=1;i<=12;i++)ms.push(('0'+i).slice(-2));
        var data=ms.map(function(mm){return{label:parseInt(mm)+'월',values:[{name:(SL.qY-1)+'',value:pByM[(SL.qY-1)+'-'+mm]||0,color:'#d1d5db'},{name:SL.qY+'',value:cByM[SL.qY+'-'+mm]||0,color:'#4a90d9'}]}});
        h+=slBar(data,'월별 매출액 추이',1);
    }
    var sMap={};SL.raw.forEach(function(r){var t=String(r['제휴점유형']||'기타');sMap[t]=(sMap[t]||0)+slNum(r['매출액'])});
    var sArr=Object.keys(sMap).map(function(k){return{type:k,sales:sMap[k]}}).sort(function(a,b){return b.sales-a.sales});
    h+='<div class="sl-cw"><div class="sl-cw__t">제휴점유형별 매출액</div><table class="sl-t sl-t--s"><thead><tr><th>제휴점유형</th><th class="r">매출액</th><th class="r">비중</th></tr></thead><tbody>';
    sArr.forEach(function(s){h+='<tr><td>'+s.type+'</td><td class="r">'+slN(s.sales)+'</td><td class="r">'+(cS?(s.sales/cS*100).toFixed(1):'0')+'%</td></tr>'});
    h+='</tbody></table></div>';document.getElementById('pFee').innerHTML=h;
}

/* === 5. 거래액 통계 === */
function slTx(){
    var cT=0,pT=0;SL.raw.forEach(function(r){cT+=slNum(r['거래액'])});SL.prevRaw.forEach(function(r){pT+=slNum(r['거래액'])});
    var h='<div class="sl-cards">'+slCd('거래액',cT,pT,1)+slCd('전년 거래액',pT,0,1)+slCd('증감',cT-pT,0,1)+'</div>';
    if(SL.mode==='year'){
        var cByM={},pByM={};
        SL.raw.forEach(function(r){var ym=slYM(r['날짜']);cByM[ym]=(cByM[ym]||0)+slNum(r['거래액'])});
        SL.prevRaw.forEach(function(r){var ym=slYM(r['날짜']);pByM[ym]=(pByM[ym]||0)+slNum(r['거래액'])});
        var ms=[];for(var i=1;i<=12;i++)ms.push(('0'+i).slice(-2));
        var data=ms.map(function(mm){return{label:parseInt(mm)+'월',values:[{name:(SL.qY-1)+'',value:pByM[(SL.qY-1)+'-'+mm]||0,color:'#d1d5db'},{name:SL.qY+'',value:cByM[SL.qY+'-'+mm]||0,color:'#4a90d9'}]}});
        h+=slBar(data,'월별 거래액 추이 (전년 비교)',1);
    }
    // 피벗
    var types={};SL.raw.forEach(function(r){types[String(r['제휴점유형']||'기타')]=1});var tArr=Object.keys(types).sort();
    h+='<div class="sl-cw"><div class="sl-cw__t">제휴점유형별 거래액</div>';
    if(SL.mode==='year'){
        var pivot={};SL.raw.forEach(function(r){var ym=slYM(r['날짜']),t=String(r['제휴점유형']||'기타');if(!pivot[ym])pivot[ym]={};pivot[ym][t]=(pivot[ym][t]||0)+slNum(r['거래액'])});
        var ms2=[];for(var j=1;j<=12;j++)ms2.push(SL.qY+'-'+('0'+j).slice(-2));
        h+='<div class="sl-pivot-wrap"><table class="sl-pivot"><thead><tr><th>월</th>';
        tArr.forEach(function(t){h+='<th class="r">'+t+'</th>'});h+='<th class="r" style="font-weight:700">합계</th></tr></thead><tbody>';
        var gT=0;ms2.forEach(function(ym){var row=pivot[ym]||{},rT=0;h+='<tr><td>'+ym+'</td>';tArr.forEach(function(t){var v=row[t]||0;rT+=v;h+='<td class="r">'+slN(v)+'</td>'});gT+=rT;h+='<td class="r" style="font-weight:600">'+slN(rT)+'</td></tr>'});
        h+='<tr class="st"><td style="font-weight:700">합계</td>';tArr.forEach(function(t){var tot=0;ms2.forEach(function(ym){tot+=((pivot[ym]||{})[t]||0)});h+='<td class="r">'+slN(tot)+'</td>'});h+='<td class="r" style="font-weight:700">'+slN(gT)+'</td></tr></tbody></table></div>';
    }else{
        var tMap={};SL.raw.forEach(function(r){var t=String(r['제휴점유형']||'기타');tMap[t]=(tMap[t]||0)+slNum(r['거래액'])});
        h+='<table class="sl-t sl-t--s"><thead><tr><th>제휴점유형</th><th class="r">거래액</th><th class="r">비중</th></tr></thead><tbody>';
        tArr.forEach(function(t){h+='<tr><td>'+t+'</td><td class="r">'+slN(tMap[t]||0)+'</td><td class="r">'+(cT?((tMap[t]||0)/cT*100).toFixed(1):'0')+'%</td></tr>'});
        h+='</tbody></table>';
    }
    h+='</div>';document.getElementById('pTx').innerHTML=h;
}

/* === 6. 최근5년 흐름도 === */
async function slY5(){
    var el=document.getElementById('pY5');
    el.innerHTML='<div style="text-align:center;padding:20px;color:#94a3b8">5년 데이터 로딩 중...</div>';
    var now=new Date().getFullYear(),years=[];
    for(var y=now;y>=now-5&&y>=2020;y--)years.push(y);years.reverse();
    var allD={};for(var i=0;i<years.length;i++){try{allD[years[i]]=await slCSV(years[i])}catch(e){allD[years[i]]=[]}}
    // 연도x월 거래액
    var pivot={};years.forEach(function(yr){pivot[yr]={};for(var m=1;m<=12;m++)pivot[yr][('0'+m).slice(-2)]=0;(allD[yr]||[]).forEach(function(r){var ym=slYM(r['날짜']),mm=ym.split('-')[1];if(mm)pivot[yr][mm]+=slNum(r['거래액'])})});
    var ms=[];for(var k=1;k<=12;k++)ms.push(('0'+k).slice(-2));
    var cd=ms.map(function(mm){return{label:parseInt(mm)+'월',values:years.map(function(yr,idx){return{name:yr+'년',value:pivot[yr][mm],color:SLC[idx%SLC.length]}})}});
    var h=slBar(cd,'월별 거래액 추이 (최근 '+years.length+'년)',1);
    // 피벗 테이블
    h+='<div class="sl-pivot-wrap"><table class="sl-pivot"><thead><tr><th>연도</th>';
    ms.forEach(function(mm){h+='<th class="r">'+parseInt(mm)+'월</th>'});h+='<th class="r" style="font-weight:700">합계</th></tr></thead><tbody>';
    years.forEach(function(yr){var total=0;h+='<tr class="yh"><td style="font-weight:700">'+yr+'</td>';ms.forEach(function(mm){var v=pivot[yr][mm];total+=v;h+='<td class="r">'+slS(v)+'</td>'});h+='<td class="r" style="font-weight:700">'+slS(total)+'</td></tr>'});
    h+='</tbody></table></div>';
    // 연간합계
    var yt=years.map(function(yr){var t=0;ms.forEach(function(mm){t+=pivot[yr][mm]});return{label:yr+'',values:[{name:'거래액',value:t,color:'#4a90d9'}]}});
    h+=slBar(yt,'연간 거래액 합계',0);
    // 제휴점유형x연도
    var tp={};years.forEach(function(yr){(allD[yr]||[]).forEach(function(r){var t=String(r['제휴점유형']||'기타');if(!tp[t])tp[t]={};tp[t][yr]=(tp[t][yr]||0)+slNum(r['거래액'])})});
    var tn=Object.keys(tp).sort();
    h+='<div class="sl-pivot-wrap"><table class="sl-pivot"><thead><tr><th>제휴점유형</th>';
    years.forEach(function(yr){h+='<th class="r">'+yr+'</th>'});h+='</tr></thead><tbody>';
    tn.forEach(function(t){h+='<tr><td>'+t+'</td>';years.forEach(function(yr){h+='<td class="r">'+slS(tp[t][yr]||0)+'</td>'});h+='</tr>'});
    h+='<tr class="st"><td style="font-weight:700">합계</td>';years.forEach(function(yr){var tot=0;tn.forEach(function(t){tot+=(tp[t][yr]||0)});h+='<td class="r" style="font-weight:700">'+slS(tot)+'</td>'});h+='</tr></tbody></table></div>';
    // 고객사수
    var cc2=years.map(function(yr){var ids={};(allD[yr]||[]).forEach(function(r){ids[String(r['고객사ID']||'')]=1});return{label:yr+'',values:[{name:'고객사',value:Object.keys(ids).length,color:'#22c55e'}]}});
    h+=slBar(cc2,'연간 고객사 수',0);
    el.innerHTML=h;
}
</script>
