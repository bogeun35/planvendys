<!--
title: 식권대장 결제내역 보고서
meta: 최종 수정: 2026.02.16
-->

<style>
.sk { font-family: 'Noto Sans KR', sans-serif; font-size: 12px; color: #1a2332; position: relative; }
.sk-ctrl { display: flex; align-items: center; gap: 8px; padding: 8px 0; border-bottom: 1px solid #e2e8f0; flex-wrap: wrap; }
.sk-ctrl label { font-size: 11px; color: #4a5568; }
.sk-ctrl input[type="date"], .sk-ctrl input[type="text"] {
    border: 1px solid #d1d5db; border-radius: 3px; padding: 3px 6px; font-size: 12px;
    font-family: 'JetBrains Mono', monospace; height: 26px; box-sizing: border-box;
}
.sk-ctrl input[type="text"] { width: 300px; }
.sk-btn {
    border: 1px solid #d1d5db; border-radius: 3px; padding: 3px 10px; font-size: 11px;
    background: #fff; cursor: pointer; height: 26px; font-family: 'Noto Sans KR', sans-serif;
    color: #4a5568; transition: all .15s;
}
.sk-btn:hover { border-color: #4a90d9; color: #4a90d9; }
.sk-btn--primary { background: #4a90d9; color: #fff; border-color: #4a90d9; font-weight: 500; }
.sk-btn--primary:hover { background: #3a7bc8; }
.sk-btn--primary:disabled { background: #94a3b8; border-color: #94a3b8; cursor: not-allowed; }
.sk-btn--active { background: #eef4fb; color: #4a90d9; border-color: #4a90d9; }
.sk-btn--green { background: #22c55e; color: #fff; border-color: #22c55e; }
.sk-btn--green:hover { background: #16a34a; }
.sk-btn--green:disabled { background: #94a3b8; border-color: #94a3b8; cursor: not-allowed; }
.sk-sep { width: 1px; height: 20px; background: #e2e8f0; }
.sk-status { margin-left: auto; font-size: 11px; color: #94a3b8; font-family: 'JetBrains Mono', monospace; }

/* 진행 상태 영역 */
.sk-progress { margin: 12px 0; display: none; }
.sk-progress--show { display: block; }
.sk-pbar-wrap { background: #f0f4f9; border-radius: 3px; height: 20px; overflow: hidden; position: relative; }
.sk-pbar { background: #4a90d9; height: 100%; width: 0%; transition: width .3s; border-radius: 3px; }
.sk-pbar-text {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-family: 'JetBrains Mono', monospace; color: #1a2332;
}
.sk-plog { margin-top: 6px; font-size: 11px; color: #4a5568; max-height: 60px; overflow-y: auto; line-height: 1.6; }

/* 서머리 카드 */
.sk-cards { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin: 12px 0; }
.sk-card {
    background: #f8fafd; border: 1px solid #e2e8f0; border-radius: 4px; padding: 8px 12px;
}
.sk-card__label { font-size: 11px; color: #94a3b8; margin-bottom: 2px; }
.sk-card__value { font-size: 16px; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: #1a2332; }

/* 2단 레이아웃 */
.sk-body { display: grid; grid-template-columns: 280px 1fr; gap: 12px; margin-top: 12px; }
.sk-panel { border: 1px solid #e2e8f0; border-radius: 4px; background: #fff; }
.sk-panel__head {
    display: flex; align-items: center; justify-content: space-between;
    padding: 6px 10px; border-bottom: 1px solid #e2e8f0; background: #f8fafd;
    font-size: 12px; font-weight: 600; color: #1a2332;
}

/* 부서 리스트 (좌) */
.sk-dept-list { max-height: calc(100vh - 340px); overflow-y: auto; }
.sk-dept-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 5px 10px; cursor: pointer; border-bottom: 1px solid #f0f4f9;
    font-size: 12px; transition: background .1s;
}
.sk-dept-item:hover { background: #f8fafd; }
.sk-dept-item--active { background: #eef4fb; color: #4a90d9; font-weight: 600; }
.sk-dept-item__count { font-size: 11px; color: #94a3b8; font-family: 'JetBrains Mono', monospace; }
.sk-dept-item__dl {
    border: none; background: none; cursor: pointer; color: #94a3b8; font-size: 11px;
    padding: 2px 4px; border-radius: 2px;
}
.sk-dept-item__dl:hover { color: #4a90d9; background: #eef4fb; }

/* 테이블 (우) */
.sk-tbl-wrap { max-height: calc(100vh - 340px); overflow: auto; }
.sk-tbl { width: 100%; border-collapse: collapse; font-size: 11px; }
.sk-tbl thead { position: sticky; top: 0; z-index: 1; }
.sk-tbl th {
    background: #f8fafd; border-bottom: 2px solid #e2e8f0; padding: 4px 8px;
    text-align: left; font-weight: 600; color: #4a5568; white-space: nowrap; font-size: 11px;
}
.sk-tbl td {
    padding: 3px 8px; border-bottom: 1px solid #f0f4f9; white-space: nowrap;
    font-size: 11px; color: #1a2332;
}
.sk-tbl tr:hover td { background: #f8fafd; }
.sk-tbl .num { text-align: right; font-family: 'JetBrains Mono', monospace; }
.sk-tbl .sm { font-size: 10px; color: #94a3b8; }

/* 복사/다운로드 피드백 */
.sk-fb {
    display: inline-block; padding: 2px 8px; border-radius: 3px; font-size: 11px;
    background: #22c55e; color: #fff; opacity: 0; transition: opacity .3s;
}
.sk-fb--show { opacity: 1; }

/* 빈 상태 */
.sk-empty { padding: 40px; text-align: center; color: #94a3b8; font-size: 13px; }
</style>

<div class="sk" id="skRoot">
    <!-- 컨트롤 바 -->
    <div class="sk-ctrl">
        <label>comid</label>
        <input type="text" id="skComid" value="721C8B3F-1A9E-4B3E-855A-B7B8CE624167">
        <div class="sk-sep"></div>
        <label>시작</label>
        <input type="date" id="skStart">
        <label>종료</label>
        <input type="date" id="skEnd">
        <div class="sk-sep"></div>
        <button class="sk-btn" onclick="skHot('lastMonth',this)">지난달</button>
        <button class="sk-btn" onclick="skHot('twoMonthsAgo',this)">지지난달</button>
        <button class="sk-btn" onclick="skHot('thisMonth',this)">이번달</button>
        <div class="sk-sep"></div>
        <button class="sk-btn sk-btn--primary" id="skFetchBtn" onclick="skFetch()">조회</button>
        <button class="sk-btn" id="skStopBtn" onclick="skStop()" style="display:none;color:#e85d5d;border-color:#e85d5d;">중단</button>
        <button class="sk-btn sk-btn--green" id="skDlAllBtn" onclick="skDownloadAll()" disabled>전체 엑셀 다운로드</button>
        <span class="sk-status" id="skStatus"></span>
    </div>

    <!-- 진행률 -->
    <div class="sk-progress" id="skProgress">
        <div class="sk-pbar-wrap">
            <div class="sk-pbar" id="skPbar"></div>
            <div class="sk-pbar-text" id="skPbarText">0%</div>
        </div>
        <div class="sk-plog" id="skPlog"></div>
    </div>

    <!-- 서머리 카드 -->
    <div class="sk-cards" id="skCards" style="display:none;">
        <div class="sk-card"><div class="sk-card__label">총 건수</div><div class="sk-card__value" id="skC1">-</div></div>
        <div class="sk-card"><div class="sk-card__label">사용자 수</div><div class="sk-card__value" id="skC4">-</div></div>
        <div class="sk-card"><div class="sk-card__label">부서1</div><div class="sk-card__value" id="skC6">-</div></div>
        <div class="sk-card"><div class="sk-card__label">부서2</div><div class="sk-card__value" id="skC5">-</div></div>
        <div class="sk-card"><div class="sk-card__label">선택 정책 사용식대</div><div class="sk-card__value" id="skC7">-</div></div>
        <div class="sk-card"><div class="sk-card__label">총 결제총액</div><div class="sk-card__value" id="skC2">-</div></div>
        <div class="sk-card"><div class="sk-card__label">총 정산금액</div><div class="sk-card__value" id="skC3">-</div></div>
    </div>

    <!-- 2단 레이아웃 -->
    <div class="sk-body" id="skBody" style="display:none;">
        <!-- 좌: 부서 리스트 -->
        <div class="sk-panel">
            <div class="sk-panel__head">
                <span>부서2별 (<span id="skDeptCount">0</span>)</span>
            </div>
            <div class="sk-dept-list" id="skDeptList"></div>
        </div>
        <!-- 우: 테이블 -->
        <div class="sk-panel">
            <div class="sk-panel__head">
                <span id="skTblTitle">전체</span>
                <div>
                    <button class="sk-btn" onclick="skCopyTable()" style="font-size:10px;">클립보드 복사</button>
                    <span class="sk-fb" id="skFb">복사 완료</span>
                </div>
            </div>
            <div class="sk-tbl-wrap" id="skTblWrap">
                <table class="sk-tbl" id="skTbl">
                    <thead>
                        <tr>
                            <th>결제번호</th><th>날짜</th><th>ID</th><th>이름</th><th>사원번호</th>
                            <th>부서1</th><th>부서2</th><th>부서3</th><th>가맹점</th>
                            <th>선택 정책 사용식대</th><th>총 결제총액</th><th>정산금액</th>
                            <th>결제형태</th><th>조식</th><th>중식</th><th>석식</th><th>특식</th>
                        </tr>
                    </thead>
                    <tbody id="skTbody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
/* ── 전역 상태 ── */
var SK = {
    PROXY: 'https://script.google.com/macros/s/AKfycbzyZ3GkPnU_1D_gax47Fa96GGCz-kVJU3QReBIoMzLo54PcfONtFe_h7QS2vRNxTZq3/exec',
    QID: 1353,
    raw: [],
    deptMap: {},
    deptList: [],
    selectedDept: null, // null = 전체
    fetching: false,
    aborted: false
};

/* ── 초기화 ── */
(function skInit() {
    var now = new Date();
    // 지난달 1일 ~ 말일
    var y = now.getFullYear(), m = now.getMonth(); // 이번달
    var lastFirst = new Date(y, m - 1, 1);
    var lastLast = new Date(y, m, 0);
    document.getElementById('skStart').value = skFmtDate(lastFirst);
    document.getElementById('skEnd').value = skFmtDate(lastLast);
})();

/* ── 유틸 ── */
function skFmtDate(d) {
    var mm = String(d.getMonth() + 1).padStart(2, '0');
    var dd = String(d.getDate()).padStart(2, '0');
    return d.getFullYear() + '-' + mm + '-' + dd;
}
function skN(v) {
    if (v === null || v === undefined || v === '') return '';
    v = Number(v);
    if (isNaN(v)) return '';
    if (v === 0) return '0';
    return (v < 0 ? '-' : '') + Math.abs(v).toLocaleString();
}
function skS(v) {
    var p = v < 0 ? '-' : '', a = Math.abs(v);
    if (a >= 1e8) return p + (a / 1e8).toFixed(1) + '억';
    if (a >= 1e4) return p + (a / 1e4).toFixed(0) + '만';
    return p + a.toLocaleString();
}
function skAddDays(dateStr, n) {
    var d = new Date(dateStr);
    d.setDate(d.getDate() + n);
    return skFmtDate(d);
}
function skDaysBetween(s, e) {
    var d1 = new Date(s), d2 = new Date(e);
    return Math.round((d2 - d1) / 86400000) + 1;
}

/* ── API 호출 ── */
function skApi(params) {
    var qs = Object.keys(params).map(function(k) {
        return k + '=' + encodeURIComponent(params[k]);
    }).join('&');
    var url = SK.PROXY + '?' + qs;
    console.log('[skApi] URL:', url);
    return fetch(url, { redirect: 'follow' }).then(function(r) { return r.json(); });
}

/* ── 구간 조회 (startdate~enddate) + 폴링 ── */
async function skFetchChunk(sd, ed, comid) {
    var d = await skApi({
        action: 'post', queryId: SK.QID,
        startdate: sd, enddate: ed, comid: comid
    });
    console.log('[skFetchChunk] ' + sd + '~' + ed, JSON.stringify(d).substring(0, 300));
    if (d.query_result && d.query_result.data) return d.query_result.data.rows || [];
    var jobId = d.job && (d.job.id || d.job.job_id);
    if (!jobId && d.job_id) jobId = d.job_id;
    if (jobId && jobId !== 'undefined') return await skPollJob(jobId);
    console.warn('[skFetchChunk] 알 수 없는 응답:', JSON.stringify(d));
    throw new Error('알 수 없는 응답 구조');
}

async function skPollJob(jobId) {
    console.log('[skPollJob] jobId=' + jobId);
    for (var i = 0; i < 120; i++) {
        if (SK.aborted) throw new Error('중단됨');
        await new Promise(function(r) { setTimeout(r, 1500); });
        var d = await skApi({ action: 'job', jobId: jobId });
        console.log('[skPollJob] #' + i, 'status=' + (d.job && d.job.status));
        if (d.job && d.job.status === 3) {
            var rid = d.job.query_result_id;
            var res = await skApi({ action: 'result', resultId: rid });
            return (res.query_result && res.query_result.data.rows) || [];
        }
        if (d.job && (d.job.status === 4 || d.job.status === 5)) throw new Error('쿼리 실패 (status=' + d.job.status + ')');
    }
    throw new Error('폴링 타임아웃');
}

/* ── 핫키 ── */
function skHot(key, el) {
    var now = new Date(), y = now.getFullYear(), m = now.getMonth();
    var s, e;
    switch(key) {
        case 'thisMonth':
            s = new Date(y, m, 1); e = new Date(y, m + 1, 0); break;
        case 'lastMonth':
            s = new Date(y, m - 1, 1); e = new Date(y, m, 0); break;
        case 'twoMonthsAgo':
            s = new Date(y, m - 2, 1); e = new Date(y, m - 1, 0); break;
    }
    document.getElementById('skStart').value = skFmtDate(s);
    document.getElementById('skEnd').value = skFmtDate(e);
    document.querySelectorAll('.sk-ctrl .sk-btn:not(.sk-btn--primary):not(.sk-btn--green)').forEach(function(b) {
        b.classList.remove('sk-btn--active');
    });
    if (el) el.classList.add('sk-btn--active');
}

/* ── 중단 ── */
function skStop() {
    SK.aborted = true;
    document.getElementById('skStopBtn').style.display = 'none';
}

/* ── 메인 조회 (1일씩 루프) ── */
async function skFetch() {
    if (SK.fetching) return;
    SK.fetching = true;
    SK.aborted = false;
    SK.raw = [];
    SK.selectedDept = null;

    var sd = document.getElementById('skStart').value;
    var ed = document.getElementById('skEnd').value;
    var comid = document.getElementById('skComid').value.trim();
    if (!sd || !ed || !comid) { alert('comid, 시작일, 종료일을 입력하세요.'); SK.fetching = false; return; }
    if (skDaysBetween(sd, ed) > 185) { alert('최대 조회 기간은 185일입니다.'); SK.fetching = false; return; }

    var fetchBtn = document.getElementById('skFetchBtn');
    var stopBtn = document.getElementById('skStopBtn');
    var dlBtn = document.getElementById('skDlAllBtn');
    fetchBtn.disabled = true;
    stopBtn.style.display = '';
    dlBtn.disabled = true;
    document.getElementById('skCards').style.display = 'none';
    document.getElementById('skBody').style.display = 'none';

    var prog = document.getElementById('skProgress');
    var pbar = document.getElementById('skPbar');
    var ptext = document.getElementById('skPbarText');
    var plog = document.getElementById('skPlog');
    prog.classList.add('sk-progress--show');
    pbar.style.width = '0%';
    ptext.textContent = '0%';
    plog.innerHTML = '';

    // 7일 청크 생성
    var chunks = [];
    var cur = sd;
    while (cur <= ed) {
        var chunkEnd = skAddDays(cur, 6); // 7일간
        if (chunkEnd > ed) chunkEnd = ed;
        chunks.push({ s: cur, e: chunkEnd });
        cur = skAddDays(chunkEnd, 1);
    }

    var statusEl = document.getElementById('skStatus');
    var errors = [];

    for (var ci = 0; ci < chunks.length; ci++) {
        if (SK.aborted) {
            plog.innerHTML += '<span style="color:#d49a2a">사용자 중단</span><br>';
            break;
        }
        var chunk = chunks[ci];
        var pct = Math.round(((ci + 1) / chunks.length) * 100);
        pbar.style.width = pct + '%';
        ptext.textContent = chunk.s + ' ~ ' + chunk.e + ' (' + pct + '%)';
        statusEl.textContent = chunk.s + '~' + chunk.e + ' 조회 중... (' + SK.raw.length.toLocaleString() + '건)';

        try {
            var rows = await skFetchChunk(chunk.s, chunk.e, comid);
            if (rows.length > 0) {
                SK.raw = SK.raw.concat(rows);
                plog.innerHTML += chunk.s + '~' + chunk.e + ': ' + rows.length.toLocaleString() + '건<br>';
            }
        } catch(err) {
            errors.push(chunk.s + '~' + chunk.e);
            plog.innerHTML += '<span style="color:#e85d5d">' + chunk.s + '~' + chunk.e + ': 실패 (' + err.message + ')</span><br>';
        }
        plog.scrollTop = plog.scrollHeight;
    }

    pbar.style.width = '100%';
    ptext.textContent = '완료 - ' + SK.raw.length.toLocaleString() + '건' + (SK.aborted ? ' (중단됨)' : '');
    statusEl.textContent = SK.raw.length.toLocaleString() + '건 조회 완료' + (errors.length ? ' (실패 ' + errors.length + '구간)' : '') + (SK.aborted ? ' [중단]' : '');

    if (SK.raw.length > 0) skProcess();
    fetchBtn.disabled = false;
    stopBtn.style.display = 'none';
    dlBtn.disabled = SK.raw.length === 0;
    SK.fetching = false;
}

/* ── 데이터 처리 ── */
function skProcess() {
    if (SK.raw.length === 0) return;

    // 날짜 T 제거 (2026-02-02T06:39:35 → 2026-02-02)
    SK.raw.forEach(function(r) {
        if (r['날짜'] && String(r['날짜']).indexOf('T') >= 0) {
            r['날짜'] = String(r['날짜']).split('T')[0];
        }
    });

    // 그룹핑 + 집계
    SK.deptMap = {};
    var userSet = new Set(), dept1Set = new Set(), dept2Set = new Set();
    var totalPrice = 0, totalSettle = 0, totalCompoint = 0;
    SK.raw.forEach(function(r) {
        var dept2 = String(r['부서2'] || '(미지정)');
        if (!SK.deptMap[dept2]) SK.deptMap[dept2] = [];
        SK.deptMap[dept2].push(r);
        userSet.add(String(r['ID'] || r['사원번호'] || ''));
        if (r['부서1']) dept1Set.add(String(r['부서1']));
        if (r['부서2']) dept2Set.add(String(r['부서2']));
        totalPrice += Number(r['총 결제총액']) || 0;
        totalSettle += Number(r['정산금액']) || 0;
        totalCompoint += Number(r['선택 정책 사용식대']) || 0;
    });
    SK.deptList = Object.keys(SK.deptMap).sort();

    // 서머리
    document.getElementById('skC1').textContent = SK.raw.length.toLocaleString() + '건';
    document.getElementById('skC4').textContent = userSet.size.toLocaleString() + '명';
    document.getElementById('skC6').textContent = dept1Set.size + '개';
    document.getElementById('skC5').textContent = dept2Set.size + '개';
    document.getElementById('skC7').textContent = skS(totalCompoint);
    document.getElementById('skC2').textContent = skS(totalPrice);
    document.getElementById('skC3').textContent = skS(totalSettle);
    document.getElementById('skCards').style.display = 'grid';

    // 부서 리스트 렌더
    skRenderDepts();
    // 테이블 렌더 (전체)
    skRenderTable(null);
    document.getElementById('skBody').style.display = 'grid';
}

/* ── 부서 리스트 렌더 ── */
function skRenderDepts() {
    var html = '<div class="sk-dept-item' + (SK.selectedDept === null ? ' sk-dept-item--active' : '') + '" onclick="skSelectDept(null)">';
    html += '<span>전체</span><span class="sk-dept-item__count">' + SK.raw.length.toLocaleString() + '</span></div>';
    SK.deptList.forEach(function(dept) {
        var cnt = SK.deptMap[dept].length;
        var active = SK.selectedDept === dept ? ' sk-dept-item--active' : '';
        html += '<div class="sk-dept-item' + active + '" onclick="skSelectDept(\'' + dept.replace(/'/g, "\\'") + '\')">';
        html += '<span>' + dept + ' <span class="sk-dept-item__count">' + cnt.toLocaleString() + '</span></span>';
        html += '<button class="sk-dept-item__dl" onclick="event.stopPropagation();skDownloadDept(\'' + dept.replace(/'/g, "\\'") + '\')" title="엑셀 다운로드">DL</button>';
        html += '</div>';
    });
    document.getElementById('skDeptList').innerHTML = html;
    document.getElementById('skDeptCount').textContent = SK.deptList.length;
}

/* ── 부서 선택 ── */
function skSelectDept(dept) {
    SK.selectedDept = dept;
    skRenderDepts();
    skRenderTable(dept);
}

/* ── 테이블 렌더 ── */
function skRenderTable(dept) {
    var data = dept === null ? SK.raw : (SK.deptMap[dept] || []);
    document.getElementById('skTblTitle').textContent = (dept === null ? '전체' : dept) + ' (' + data.length.toLocaleString() + '건)';

    // 성능: 5000건 초과 시 잘라서 표시
    var MAX = 5000;
    var truncated = data.length > MAX;
    var show = truncated ? data.slice(0, MAX) : data;

    var html = '';
    show.forEach(function(r) {
        html += '<tr>';
        html += '<td class="sm">' + (r['결제번호'] || '') + '</td>';
        html += '<td>' + (r['날짜'] || '') + '</td>';
        html += '<td>' + (r['ID'] || '') + '</td>';
        html += '<td>' + (r['이름'] || '') + '</td>';
        html += '<td>' + (r['사원번호'] || '') + '</td>';
        html += '<td>' + (r['부서1'] || '') + '</td>';
        html += '<td>' + (r['부서2'] || '') + '</td>';
        html += '<td>' + (r['부서3'] || '') + '</td>';
        html += '<td>' + (r['가맹점'] || '') + '</td>';
        html += '<td class="num">' + skN(r['선택 정책 사용식대']) + '</td>';
        html += '<td class="num">' + skN(r['총 결제총액']) + '</td>';
        html += '<td class="num">' + skN(r['정산금액']) + '</td>';
        html += '<td>' + (r['결제형태'] || '') + '</td>';
        html += '<td class="num">' + skN(r['조식']) + '</td>';
        html += '<td class="num">' + skN(r['중식']) + '</td>';
        html += '<td class="num">' + skN(r['석식']) + '</td>';
        html += '<td class="num">' + skN(r['특식']) + '</td>';
        html += '</tr>';
    });
    if (truncated) {
        html += '<tr><td colspan="17" style="text-align:center;color:#94a3b8;padding:8px;">... ' + (data.length - MAX).toLocaleString() + '건 추가 (엑셀 다운로드로 전체 확인)</td></tr>';
    }
    document.getElementById('skTbody').innerHTML = html;
}

/* ── 클립보드 복사 ── */
function skCopyTable() {
    var dept = SK.selectedDept;
    var data = dept === null ? SK.raw : (SK.deptMap[dept] || []);
    var cols = ['결제번호','날짜','ID','이름','사원번호','부서1','부서2','부서3','가맹점','선택 정책 사용식대','총 결제총액','정산금액','결제형태','조식','중식','석식','특식'];
    var lines = [cols.join('\t')];
    data.forEach(function(r) {
        var row = cols.map(function(c) {
            var v = r[c];
            if (v === null || v === undefined) return '';
            if (['선택 정책 사용식대','총 결제총액','정산금액','조식','중식','석식','특식'].indexOf(c) >= 0) {
                var n = Number(v);
                return isNaN(n) ? '' : n;
            }
            return v;
        });
        lines.push(row.join('\t'));
    });
    navigator.clipboard.writeText(lines.join('\n')).then(function() {
        var fb = document.getElementById('skFb');
        fb.classList.add('sk-fb--show');
        setTimeout(function() { fb.classList.remove('sk-fb--show'); }, 1500);
    });
}

/* ── 엑셀 다운로드 (SheetJS) ── */
function skEnsureXLSX() {
    if (window.XLSX) return Promise.resolve();
    return new Promise(function(resolve, reject) {
        var s = document.createElement('script');
        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
    });
}

function skBuildSheet(data) {
    var cols = ['결제번호','날짜','ID','이름','사원번호','부서1','부서2','부서3','가맹점','선택 정책 사용식대','총 결제총액','정산금액','결제형태','조식','중식','석식','특식'];
    var numCols = ['선택 정책 사용식대','총 결제총액','정산금액','조식','중식','석식','특식'];
    var aoa = [cols];
    data.forEach(function(r) {
        aoa.push(cols.map(function(c) {
            var v = r[c];
            if (v === null || v === undefined) return '';
            if (numCols.indexOf(c) >= 0) { var n = Number(v); return isNaN(n) ? '' : n; }
            return String(v);
        }));
    });
    var ws = XLSX.utils.aoa_to_sheet(aoa);
    // 컬럼 너비 설정
    ws['!cols'] = cols.map(function(c) {
        if (c === '결제번호') return { wch: 12 };
        if (numCols.indexOf(c) >= 0) return { wch: 14 };
        return { wch: 10 };
    });
    return ws;
}

async function skDownloadAll() {
    await skEnsureXLSX();
    var wb = XLSX.utils.book_new();
    // 전체 시트
    XLSX.utils.book_append_sheet(wb, skBuildSheet(SK.raw), '전체');
    // 부서2별 시트
    SK.deptList.forEach(function(dept) {
        var name = dept.substring(0, 31).replace(/[\[\]\*\?\/\\]/g, '_'); // 시트명 제한
        XLSX.utils.book_append_sheet(wb, skBuildSheet(SK.deptMap[dept]), name);
    });
    var sd = document.getElementById('skStart').value;
    var ed = document.getElementById('skEnd').value;
    XLSX.writeFile(wb, '식권대장_결제내역_' + sd + '_' + ed + '.xlsx');
}

async function skDownloadDept(dept) {
    await skEnsureXLSX();
    var wb = XLSX.utils.book_new();
    var name = dept.substring(0, 31).replace(/[\[\]\*\?\/\\]/g, '_');
    XLSX.utils.book_append_sheet(wb, skBuildSheet(SK.deptMap[dept]), name);
    var sd = document.getElementById('skStart').value;
    var ed = document.getElementById('skEnd').value;
    XLSX.writeFile(wb, '식권대장_' + dept + '_' + sd + '_' + ed + '.xlsx');
}
</script>
