<!--
title: 배너 조회/클릭수
meta: 최종 수정: 2026.02.20
-->

<style>
.bn{font-family:'Noto Sans KR',sans-serif;font-size:12px;color:#1a2332;position:relative;height:calc(100vh - 80px);overflow:hidden;display:flex;flex-direction:column}
.bn *{box-sizing:border-box}

/* Tabs */
.bn-tabs{display:flex;gap:0;border-bottom:2px solid #e2e8f0;flex-shrink:0}
.bn-tab{padding:8px 20px;font-size:12px;font-weight:600;color:#94a3b8;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:color .15s,border-color .15s}
.bn-tab:hover{color:#4a5568}
.bn-tab.bn--active{color:#4a90d9;border-bottom-color:#4a90d9}
.bn-tab-body{display:none;flex:1;min-height:0;flex-direction:column;overflow:hidden}
.bn-tab-body.bn--active{display:flex}

/* Controls */
.bn-ctrl{display:flex;align-items:center;gap:6px;padding:8px 0;border-bottom:1px solid #e2e8f0;flex-shrink:0;flex-wrap:wrap}
.bn-ctrl input[type=text]{width:180px;border:1px solid #d1d5db;border-radius:3px;padding:3px 6px;font-size:11px;font-family:'Noto Sans KR',sans-serif}
.bn-ctrl input[type=date]{border:1px solid #d1d5db;border-radius:3px;padding:3px 6px;font-size:12px;font-family:'Noto Sans KR',sans-serif}
.bn-ctrl label{font-size:11px;color:#94a3b8}
.bn-btn{padding:4px 10px;border:1px solid #d1d5db;border-radius:3px;background:#fff;cursor:pointer;font-size:11px;font-family:'Noto Sans KR',sans-serif;color:#4a5568;white-space:nowrap}
.bn-btn:hover{background:#f0f4f9}
.bn-btn--pri{background:#4a90d9;color:#fff;border-color:#4a90d9}
.bn-btn--pri:hover{background:#3a7bc8}
.bn-btn--on{background:#eef4fb;border-color:#4a90d9;color:#4a90d9}
.bn-btn--danger{background:#fef2f2;border-color:#e85d5d;color:#e85d5d}
.bn-sep{width:1px;height:20px;background:#e2e8f0}
.bn-status{margin-left:auto;font-size:11px;color:#94a3b8}
.bn-cnt{font-size:11px;color:#94a3b8}
.bn-copy-ok{color:#22c55e;font-size:11px;display:none}

/* Position filter buttons */
.bn-pos-wrap{display:flex;gap:4px;flex-wrap:wrap;align-items:center}
.bn-pos-btn{padding:2px 8px;border:1px solid #d1d5db;border-radius:3px;background:#fff;cursor:pointer;font-size:10px;font-family:'Noto Sans KR',sans-serif;color:#4a5568}
.bn-pos-btn:hover{background:#f0f4f9}
.bn-pos-btn.bn--on{background:#eef4fb;border-color:#4a90d9;color:#4a90d9}

/* Summary Cards */
.bn-summary{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;padding:8px 0;flex-shrink:0}
.bn-card{background:#f8fafd;border:1px solid #e2e8f0;border-radius:4px;padding:6px 10px}
.bn-card__label{font-size:10px;color:#94a3b8;margin-bottom:2px}
.bn-card__value{font-size:15px;font-weight:700;font-family:'JetBrains Mono',monospace;color:#1a2332}

/* Table */
.bn-twrap{flex:1;min-height:0;overflow:auto}
.bn-table{width:100%;border-collapse:collapse;table-layout:fixed}
.bn-table th{position:sticky;top:0;background:#f0f4f9;border-bottom:2px solid #d1d5db;padding:4px 8px;font-size:11px;font-weight:600;color:#4a5568;text-align:left;cursor:pointer;white-space:nowrap;z-index:1}
.bn-table th:hover{background:#e2e8f0}
.bn-table th .bn-sort{font-size:9px;margin-left:2px;color:#94a3b8}
.bn-table td{padding:4px 8px;border-bottom:1px solid #f0f4f9;font-size:11px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.bn-table tr{cursor:pointer}
.bn-table tr:hover{background:#f8fafd}
.bn-table tr.bn--sel{background:#eef4fb}
.bn-table tr.bn--chk{background:#fffbeb}
.bn-num{text-align:right;font-family:'JetBrains Mono',monospace}
.bn-mono{font-family:'JetBrains Mono',monospace;font-size:10px}
.bn-center{text-align:center}
.bn-thumb{width:60px;height:32px;border-radius:2px;object-fit:cover;vertical-align:middle}
.bn-thumb-empty{width:60px;height:32px;border-radius:2px;background:#f0f4f9;display:inline-flex;align-items:center;justify-content:center;font-size:9px;color:#94a3b8}
.bn-active-dot{display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:4px}
.bn-active-dot--on{background:#22c55e}
.bn-active-dot--off{background:#d1d5db}
.bn-chk{width:14px;height:14px;cursor:pointer;accent-color:#4a90d9}

/* Daily Tab */
.bn-daily-chart{height:200px;position:relative;flex-shrink:0;margin-bottom:8px}
.bn-daily-twrap{flex:1;min-height:0;overflow:auto}
.bn-daily-table{width:100%;border-collapse:collapse;table-layout:fixed}
.bn-daily-table th{position:sticky;top:0;background:#f0f4f9;border-bottom:2px solid #d1d5db;padding:4px 8px;font-size:11px;font-weight:600;color:#4a5568;text-align:right;cursor:pointer;white-space:nowrap;z-index:1}
.bn-daily-table th:first-child{text-align:left}
.bn-daily-table th:nth-child(2){text-align:left}
.bn-daily-table th:hover{background:#e2e8f0}
.bn-daily-table td{padding:4px 8px;border-bottom:1px solid #f0f4f9;font-size:11px;text-align:right;font-family:'JetBrains Mono',monospace;white-space:nowrap}
.bn-daily-table td:first-child{text-align:left;font-family:'Noto Sans KR',sans-serif}
.bn-daily-table td:nth-child(2){text-align:left;font-family:'Noto Sans KR',sans-serif;font-size:10px;color:#94a3b8}

/* Report Tab */
.bn-rpt-empty{display:flex;align-items:center;justify-content:center;height:100%;color:#94a3b8;font-size:12px;flex-direction:column;gap:8px}
.bn-rpt-chips{display:flex;gap:4px;flex-wrap:wrap;padding:4px 0;align-items:center}
.bn-rpt-chip{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border:1px solid #4a90d9;border-radius:3px;font-size:10px;color:#4a90d9;background:#eef4fb}
.bn-rpt-chip__x{cursor:pointer;font-size:12px;color:#94a3b8}
.bn-rpt-chip__x:hover{color:#e85d5d}
.bn-rpt-content{flex:1;min-height:0;overflow:auto;display:flex;flex-direction:column;gap:12px;padding-bottom:12px}
.bn-rpt-section{border:1px solid #e2e8f0;border-radius:4px;overflow:hidden}
.bn-rpt-section__head{background:#f8fafd;padding:6px 10px;font-size:11px;font-weight:600;color:#1a2332;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:6px}
.bn-rpt-section__body{padding:10px}
.bn-rpt-cards{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:10px}
.bn-rpt-card{background:#f8fafd;border:1px solid #e2e8f0;border-radius:3px;padding:5px 7px}
.bn-rpt-card__label{font-size:10px;color:#94a3b8}
.bn-rpt-card__value{font-size:13px;font-weight:700;font-family:'JetBrains Mono',monospace}
.bn-rpt-chart{height:180px;position:relative;margin-bottom:8px}

/* Side Panel */
.bn-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.15);z-index:100;opacity:0;pointer-events:none;transition:opacity .2s}
.bn-overlay.bn--show{opacity:1;pointer-events:auto}
.bn-panel{position:fixed;top:0;right:0;bottom:0;width:600px;background:#fff;z-index:101;box-shadow:-4px 0 20px rgba(0,0,0,.1);transform:translateX(100%);transition:transform .25s ease;display:flex;flex-direction:column;font-family:'Noto Sans KR',sans-serif}
.bn-panel.bn--show{transform:translateX(0)}
.bn-panel__head{display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid #e2e8f0;background:#f8fafd;gap:8px;flex-shrink:0}
.bn-panel__title{font-size:14px;font-weight:700;color:#1a2332;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.bn-panel__close{width:28px;height:28px;border:1px solid #d1d5db;border-radius:3px;background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;color:#4a5568;flex-shrink:0}
.bn-panel__close:hover{background:#f0f4f9}
.bn-panel__meta{font-size:10px;color:#94a3b8;padding:6px 16px;border-bottom:1px solid #e2e8f0;flex-shrink:0;line-height:1.6}
.bn-panel__ctrl{display:flex;align-items:center;gap:6px;padding:8px 16px;border-bottom:1px solid #e2e8f0;flex-shrink:0;flex-wrap:wrap}
.bn-panel__ctrl label{font-size:11px;color:#94a3b8}
.bn-panel__ctrl input[type=date]{border:1px solid #d1d5db;border-radius:3px;padding:3px 6px;font-size:11px;font-family:'Noto Sans KR',sans-serif}
.bn-panel__ctrl .bn-btn{padding:3px 8px;font-size:10px}
.bn-panel__body{flex:1;overflow:auto;padding:12px 16px}
.bn-pcards{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:12px}
.bn-pcard{background:#f8fafd;border:1px solid #e2e8f0;border-radius:3px;padding:5px 7px}
.bn-pcard__label{font-size:10px;color:#94a3b8}
.bn-pcard__value{font-size:13px;font-weight:700;font-family:'JetBrains Mono',monospace}
.bn-panel__section{font-size:11px;font-weight:600;color:#4a5568;margin:8px 0 4px}
.bn-dtable{width:100%;border-collapse:collapse}
.bn-dtable th{background:#f0f4f9;padding:3px 6px;font-size:10px;font-weight:600;color:#4a5568;text-align:right;border-bottom:1px solid #d1d5db;position:sticky;top:0;z-index:1}
.bn-dtable th:first-child{text-align:left}
.bn-dtable td{padding:3px 6px;font-size:11px;text-align:right;font-family:'JetBrains Mono',monospace;border-bottom:1px solid #f0f4f9}
.bn-dtable td:first-child{text-align:left;font-family:'Noto Sans KR',sans-serif;font-size:11px}
.bn-neg{color:#e85d5d}.bn-pos{color:#22c55e}
.bn-chart-wrap{margin-top:10px;height:180px;position:relative}

/* Loading */
.bn-loading{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.85);display:none;align-items:center;justify-content:center;z-index:10;flex-direction:column;gap:8px}
.bn-loading.bn--show{display:flex}
.bn-loading__bar{width:200px;height:4px;background:#e2e8f0;border-radius:2px;overflow:hidden}
.bn-loading__fill{height:100%;background:#4a90d9;border-radius:2px;width:0%;transition:width .3s}
.bn-loading__text{font-size:11px;color:#4a5568}
</style>

<div class="bn" id="bnRoot">
  <div class="bn-tabs">
    <div class="bn-tab bn--active" onclick="bnTabSwitch('list')">배너 목록</div>
    <div class="bn-tab" onclick="bnTabSwitch('daily')">일자별 현황</div>
    <div class="bn-tab" onclick="bnTabSwitch('report')">광고 리포트 <span id="bnRptBadge" style="font-size:10px;color:#4a90d9"></span></div>
  </div>

  <!-- ═══ Tab 1: 배너 목록 ═══ -->
  <div class="bn-tab-body bn--active" id="bnTabList">
    <div class="bn-ctrl">
      <input type="text" id="bnSearch" placeholder="배너명 / idx 검색" oninput="bnFilter()">
      <div class="bn-sep"></div>
      <div class="bn-pos-wrap" id="bnPosWrap"></div>
      <div class="bn-sep"></div>
      <button class="bn-btn bn-btn--pri" onclick="bnFetch()">새로고침</button>
      <span class="bn-cnt" id="bnCnt"></span>
      <button class="bn-btn" onclick="bnCopy()">복사</button>
      <span class="bn-copy-ok" id="bnCopyOk">복사됨</span>
      <span class="bn-status" id="bnStatus"></span>
    </div>
    <div class="bn-summary">
      <div class="bn-card"><div class="bn-card__label">배너수</div><div class="bn-card__value" id="bnSumTotal">-</div></div>
      <div class="bn-card"><div class="bn-card__label">총 조회수</div><div class="bn-card__value" id="bnSumViews">-</div></div>
      <div class="bn-card"><div class="bn-card__label">총 클릭수</div><div class="bn-card__value" id="bnSumClicks">-</div></div>
      <div class="bn-card"><div class="bn-card__label">평균 CTR</div><div class="bn-card__value" id="bnSumCTR">-</div></div>
      <div class="bn-card"><div class="bn-card__label">선택됨</div><div class="bn-card__value" id="bnSumSel">0개</div></div>
    </div>
    <div class="bn-twrap">
      <table class="bn-table">
        <thead><tr>
          <th style="width:28px;cursor:default" class="bn-center"><input type="checkbox" class="bn-chk" onchange="bnToggleAll(this)"></th>
          <th onclick="bnSort('idx')" style="width:50px" class="bn-center">idx<span class="bn-sort" id="bnSortidx"></span></th>
          <th style="width:64px;cursor:default">이미지</th>
          <th onclick="bnSort('title')">배너명<span class="bn-sort" id="bnSorttitle"></span></th>
          <th onclick="bnSort('position')" style="width:160px">상세위치<span class="bn-sort" id="bnSortposition"></span></th>
          <th onclick="bnSort('startDate')" style="width:86px">시작일<span class="bn-sort" id="bnSortstartDate"></span></th>
          <th onclick="bnSort('endDate')" style="width:86px">종료일<span class="bn-sort" id="bnSortendDate"></span></th>
          <th onclick="bnSort('views')" style="width:76px" class="bn-num">조회수<span class="bn-sort" id="bnSortviews"></span></th>
          <th onclick="bnSort('clicks')" style="width:76px" class="bn-num">클릭수<span class="bn-sort" id="bnSortclicks"></span></th>
          <th onclick="bnSort('ctr')" style="width:60px" class="bn-num">CTR(%)<span class="bn-sort" id="bnSortctr"></span></th>
        </tr></thead>
        <tbody id="bnTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- ═══ Tab 2: 일자별 현황 ═══ -->
  <div class="bn-tab-body" id="bnTabDaily">
    <div class="bn-ctrl">
      <label>시작일</label><input type="date" id="bnDailyStart">
      <label>종료일</label><input type="date" id="bnDailyEnd">
      <button class="bn-btn bn-btn--pri" onclick="bnDailyRender()">조회</button>
      <div class="bn-sep"></div>
      <button class="bn-btn" onclick="bnDHot('7d',this)">7일</button>
      <button class="bn-btn" onclick="bnDHot('14d',this)">14일</button>
      <button class="bn-btn" onclick="bnDHot('30d',this)">30일</button>
      <button class="bn-btn" onclick="bnDHot('all',this)">전체</button>
      <div class="bn-sep"></div>
      <button class="bn-btn" onclick="bnDailyCopy()">복사</button>
      <span class="bn-copy-ok" id="bnDailyCopyOk">복사됨</span>
      <span class="bn-status" id="bnDailyStatus"></span>
    </div>
    <div class="bn-summary">
      <div class="bn-card"><div class="bn-card__label">조회 기간</div><div class="bn-card__value" id="bnDSumRange">-</div></div>
      <div class="bn-card"><div class="bn-card__label">총 조회수</div><div class="bn-card__value" id="bnDSumViews">-</div></div>
      <div class="bn-card"><div class="bn-card__label">총 클릭수</div><div class="bn-card__value" id="bnDSumClicks">-</div></div>
      <div class="bn-card"><div class="bn-card__label">CTR</div><div class="bn-card__value" id="bnDSumCTR">-</div></div>
      <div class="bn-card"><div class="bn-card__label">피크일(조회)</div><div class="bn-card__value" id="bnDSumPeak">-</div></div>
    </div>
    <div class="bn-daily-chart"><canvas id="bnDailyChart"></canvas></div>
    <div class="bn-daily-twrap">
      <table class="bn-daily-table">
        <thead><tr>
          <th style="width:90px" onclick="bnDSort('date')">날짜<span class="bn-sort" id="bnDSdate"></span></th>
          <th style="width:44px" onclick="bnDSort('dow')">요일<span class="bn-sort" id="bnDSdow"></span></th>
          <th onclick="bnDSort('views')">조회수<span class="bn-sort" id="bnDSviews"></span></th>
          <th onclick="bnDSort('clicks')">클릭수<span class="bn-sort" id="bnDSclicks"></span></th>
          <th onclick="bnDSort('ctr')">CTR(%)<span class="bn-sort" id="bnDSctr"></span></th>
          <th onclick="bnDSort('viewDiff')">조회 전일비<span class="bn-sort" id="bnDSviewDiff"></span></th>
          <th onclick="bnDSort('clickDiff')">클릭 전일비<span class="bn-sort" id="bnDSclickDiff"></span></th>
        </tr></thead>
        <tbody id="bnDailyTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- ═══ Tab 3: 광고 리포트 ═══ -->
  <div class="bn-tab-body" id="bnTabReport">
    <div class="bn-ctrl">
      <span class="bn-cnt">선택된 배너</span>
      <div class="bn-rpt-chips" id="bnRptChips"></div>
      <div class="bn-sep"></div>
      <label>시작</label><input type="date" id="bnRptStart">
      <label>종료</label><input type="date" id="bnRptEnd">
      <button class="bn-btn bn-btn--pri" onclick="bnRptRender()">리포트 생성</button>
      <button class="bn-btn" onclick="bnRHot('7d',this)">7일</button>
      <button class="bn-btn" onclick="bnRHot('14d',this)">14일</button>
      <button class="bn-btn" onclick="bnRHot('30d',this)">30일</button>
      <button class="bn-btn" onclick="bnRHot('all',this)">전체</button>
      <div class="bn-sep"></div>
      <button class="bn-btn" onclick="bnRptCopy()">복사</button>
      <span class="bn-copy-ok" id="bnRptCopyOk">복사됨</span>
    </div>
    <div class="bn-rpt-content" id="bnRptContent">
      <div class="bn-rpt-empty">배너 목록에서 체크박스로 배너를 선택한 뒤<br>"광고 리포트" 탭에서 리포트를 생성하세요</div>
    </div>
  </div>

  <div class="bn-loading" id="bnLoading">
    <div class="bn-loading__bar"><div class="bn-loading__fill" id="bnLoadFill"></div></div>
    <div class="bn-loading__text" id="bnLoadText">데이터 조회 중...</div>
  </div>
</div>

<div class="bn-overlay" id="bnOverlay" onclick="bnClosePanel()"></div>
<div class="bn-panel" id="bnPanel">
  <div class="bn-panel__head">
    <div class="bn-panel__title" id="bnPanelTitle">-</div>
    <button class="bn-panel__close" onclick="bnClosePanel()">&#x2715;</button>
  </div>
  <div class="bn-panel__meta" id="bnPanelMeta"></div>
  <div class="bn-panel__ctrl">
    <label>시작</label><input type="date" id="bnDetailStart">
    <label>종료</label><input type="date" id="bnDetailEnd">
    <button class="bn-btn bn-btn--pri" onclick="bnRenderDetail()">조회</button>
    <button class="bn-btn" onclick="bnDetHot('7d',this)">7일</button>
    <button class="bn-btn" onclick="bnDetHot('14d',this)">14일</button>
    <button class="bn-btn" onclick="bnDetHot('30d',this)">30일</button>
    <button class="bn-btn" onclick="bnDetHot('all',this)">전체</button>
  </div>
  <div class="bn-panel__body" id="bnPanelBody">
    <div style="display:flex;align-items:center;justify-content:center;height:100%;color:#94a3b8;font-size:12px">배너를 선택하세요</div>
  </div>
</div>

<script>
/* ══════════════════════════════════════════════════════════════════
   BN - 배너 조회/클릭수 대시보드
   접두사: bn
   ══════════════════════════════════════════════════════════════════ */
var BN = {
  PROXY: 'https://script.google.com/macros/s/AKfycbzyZ3GkPnU_1D_gax47Fa96GGCz-kVJU3QReBIoMzLo54PcfONtFe_h7QS2vRNxTZq3/exec',
  banners: [], events: [], merged: [], filtered: [],
  dailyMap: {}, dailyTotal: {},
  sortCol: 'idx', sortDir: 'desc',
  dSortCol: 'date', dSortDir: 'desc',
  selIdx: null, checked: {},
  posFilter: '',
  detailChart: null, dailyChart: null, rptCharts: []
};

function bnApi(p) {
  var qs = Object.keys(p).map(function(k){return k+'='+encodeURIComponent(p[k])}).join('&');
  return fetch(BN.PROXY+'?'+qs,{redirect:'follow'}).then(function(r){return r.json()});
}
function bnN(v){if(v===0)return'0';return(v<0?'-':'')+Math.abs(v).toLocaleString()}
function bnS(v){var p=v<0?'-':'',a=Math.abs(v);if(a>=1e8)return p+(a/1e8).toFixed(1)+'억';if(a>=1e4)return p+(a/1e4).toFixed(0)+'만';return p+a.toLocaleString()}
function bnD(v){if(v===0)return'-';return(v>0?'+':'')+bnN(v)}
function bnFmt(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')}
var BN_DOW=['일','월','화','수','목','금','토'];
function bnDow(s){var p=s.split('-');return BN_DOW[new Date(+p[0],+p[1]-1,+p[2]).getDay()]}

function bnLoad(show,pct,txt){
  var el=document.getElementById('bnLoading');
  if(show)el.classList.add('bn--show');else el.classList.remove('bn--show');
  if(pct!==undefined)document.getElementById('bnLoadFill').style.width=pct+'%';
  if(txt)document.getElementById('bnLoadText').textContent=txt;
}

/* ── Tab Switch ── */
function bnTabSwitch(tab){
  document.querySelectorAll('#bnRoot .bn-tab').forEach(function(t){t.classList.remove('bn--active')});
  document.querySelectorAll('#bnRoot .bn-tab-body').forEach(function(b){b.classList.remove('bn--active')});
  var idx=tab==='list'?0:tab==='daily'?1:2;
  document.querySelectorAll('#bnRoot .bn-tabs .bn-tab')[idx].classList.add('bn--active');
  var bodies=['bnTabList','bnTabDaily','bnTabReport'];
  document.getElementById(bodies[idx]).classList.add('bn--active');
  if(tab==='daily'&&Object.keys(BN.dailyTotal).length>0&&!document.getElementById('bnDailyStart').value){
    var now=new Date();
    document.getElementById('bnDailyEnd').value=bnFmt(now);
    document.getElementById('bnDailyStart').value=bnFmt(new Date(now.getFullYear(),now.getMonth(),now.getDate()-29));
    bnDailyRender();
  }
  if(tab==='report') bnRptUpdateChips();
}

/* ── Fetch ── */
async function bnFetch(){
  bnLoad(true,10,'데이터 조회 중...');
  document.getElementById('bnStatus').textContent='조회 중...';
  try{
    var d=await bnApi({action:'bannerStats'});
    bnLoad(true,50,'데이터 처리 중...');
    if(d.error){alert('API 오류: '+d.error);bnLoad(false);return}
    BN.banners=(d.banners||[]).map(function(r){
      return{idx:Number(r.idx)||0,title:String(r.title||''),startDate:String(r.startDate||''),endDate:String(r.endDate||''),imageUrl:String(r.imageUrl||''),position:String(r.position||'')};
    });
    BN.events=(d.events||[]).map(function(r){
      return{date:String(r.date||''),clickOrView:String(r.clickOrView||''),bannerId:String(r.bannerId||''),eventCount:Number(r.eventCount)||0};
    });
    bnProcess();
    bnLoad(true,85,'렌더링 중...');
    bnBuildPosFilter();
    bnFilter();
    document.getElementById('bnStatus').textContent=BN.banners.length+'개 배너, '+BN.events.length+'건 이벤트';
    bnLoad(false);
  }catch(err){alert('통신 오류: '+err.message);bnLoad(false)}
}

function bnProcess(){
  var today=bnFmt(new Date());
  var agg={}, dailyMap={}, dailyTotal={};
  BN.events.forEach(function(e){
    var bid=e.bannerId, isV=e.clickOrView==='조회', isC=e.clickOrView==='클릭';
    if(!isV&&!isC)return;
    if(!agg[bid])agg[bid]={views:0,clicks:0};
    if(isV)agg[bid].views+=e.eventCount;
    if(isC)agg[bid].clicks+=e.eventCount;
    if(!dailyMap[bid])dailyMap[bid]={};
    if(!dailyMap[bid][e.date])dailyMap[bid][e.date]={views:0,clicks:0};
    if(isV)dailyMap[bid][e.date].views+=e.eventCount;
    if(isC)dailyMap[bid][e.date].clicks+=e.eventCount;
    if(!dailyTotal[e.date])dailyTotal[e.date]={views:0,clicks:0};
    if(isV)dailyTotal[e.date].views+=e.eventCount;
    if(isC)dailyTotal[e.date].clicks+=e.eventCount;
  });
  BN.dailyMap=dailyMap; BN.dailyTotal=dailyTotal;
  BN.merged=BN.banners.map(function(b){
    var a=agg[String(b.idx)]||{views:0,clicks:0};
    return{idx:b.idx,title:b.title,startDate:b.startDate,endDate:b.endDate,imageUrl:b.imageUrl,position:b.position,views:a.views,clicks:a.clicks,ctr:a.views>0?(a.clicks/a.views*100):0,isActive:b.endDate>=today};
  });
  BN.filtered=BN.merged.slice();
}

/* ── Position filter buttons ── */
function bnBuildPosFilter(){
  var positions={};
  BN.merged.forEach(function(b){if(b.position)positions[b.position]=true});
  var wrap=document.getElementById('bnPosWrap');
  var h='<span class="bn-pos-btn bn--on" onclick="bnPosClick(\'\',this)">전체</span>';
  Object.keys(positions).sort().forEach(function(p){
    // 짧은 라벨: "홈 중간배너(1000 * 380)" → "홈 중간배너"
    var short=p.replace(/\(.*\)/,'').trim();
    h+='<span class="bn-pos-btn" onclick="bnPosClick(\''+p.replace(/'/g,"\\'")+'\',this)" title="'+p+'">'+short+'</span>';
  });
  wrap.innerHTML=h;
}

function bnPosClick(pos,el){
  BN.posFilter=pos;
  document.querySelectorAll('#bnPosWrap .bn-pos-btn').forEach(function(b){b.classList.remove('bn--on')});
  el.classList.add('bn--on');
  bnFilter();
}

/* ── Filter ── */
function bnFilter(){
  var q=document.getElementById('bnSearch').value.trim().toLowerCase();
  var pos=BN.posFilter;
  BN.filtered=BN.merged.filter(function(b){
    if(q&&b.title.toLowerCase().indexOf(q)===-1&&String(b.idx).indexOf(q)===-1)return false;
    if(pos&&b.position!==pos)return false;
    return true;
  });
  bnRenderSummary();
  bnRenderTable();
}

function bnRenderSummary(){
  var f=BN.filtered, tv=0, tc=0;
  f.forEach(function(b){tv+=b.views;tc+=b.clicks});
  var ctr=tv>0?(tc/tv*100):0;
  var selCnt=Object.keys(BN.checked).filter(function(k){return BN.checked[k]}).length;
  document.getElementById('bnSumTotal').textContent=f.length+'개';
  document.getElementById('bnSumViews').textContent=bnS(tv);
  document.getElementById('bnSumClicks').textContent=bnS(tc);
  document.getElementById('bnSumCTR').textContent=ctr.toFixed(2)+'%';
  document.getElementById('bnSumSel').textContent=selCnt+'개';
  document.getElementById('bnRptBadge').textContent=selCnt>0?'('+selCnt+')':'';
}

/* ── Sort + Table ── */
function bnSort(col){
  if(BN.sortCol===col)BN.sortDir=BN.sortDir==='desc'?'asc':'desc';
  else{BN.sortCol=col;BN.sortDir=(col==='title'||col==='position'||col==='startDate'||col==='endDate')?'asc':'desc'}
  bnRenderTable();
}

function bnRenderTable(){
  var f=BN.filtered.slice(),col=BN.sortCol,dir=BN.sortDir;
  f.sort(function(a,b){
    var va=a[col],vb=b[col];
    if(typeof va==='string')return dir==='asc'?va.localeCompare(vb):vb.localeCompare(va);
    return dir==='asc'?va-vb:vb-va;
  });
  document.querySelectorAll('.bn-table .bn-sort').forEach(function(s){s.textContent=''});
  var si=document.getElementById('bnSort'+col);
  if(si)si.textContent=dir==='asc'?' \u25B2':' \u25BC';
  var h='';
  f.forEach(function(r){
    var sel=r.idx===BN.selIdx?' bn--sel':'';
    var chk=BN.checked[r.idx]?' bn--chk':'';
    var dot=r.isActive?'<span class="bn-active-dot bn-active-dot--on"></span>':'<span class="bn-active-dot bn-active-dot--off"></span>';
    var posShort=(r.position||'-').replace(/\(.*\)/,'').trim();
    h+='<tr class="'+sel+chk+'">';
    h+='<td class="bn-center" onclick="event.stopPropagation()"><input type="checkbox" class="bn-chk" '+(BN.checked[r.idx]?'checked':'')+' onchange="bnCheck('+r.idx+',this)"></td>';
    h+='<td class="bn-center bn-mono" style="color:#94a3b8">'+r.idx+'</td>';
    if(r.imageUrl){
      h+='<td><img class="bn-thumb" src="'+r.imageUrl+'" referrerpolicy="no-referrer" onerror="this.outerHTML=\'<span class=bn-thumb-empty>-</span>\'"></td>';
    }else{h+='<td><span class="bn-thumb-empty">-</span></td>'}
    h+='<td title="'+r.title.replace(/"/g,'&quot;')+'" onclick="bnSelect('+r.idx+')">'+dot+r.title+'</td>';
    h+='<td title="'+r.position+'" style="font-size:10px">'+posShort+'</td>';
    h+='<td class="bn-mono">'+r.startDate+'</td>';
    h+='<td class="bn-mono">'+r.endDate+'</td>';
    h+='<td class="bn-num">'+bnN(r.views)+'</td>';
    h+='<td class="bn-num">'+bnN(r.clicks)+'</td>';
    h+='<td class="bn-num">'+r.ctr.toFixed(2)+'</td>';
    h+='</tr>';
  });
  document.getElementById('bnTbody').innerHTML=h;
  document.getElementById('bnCnt').textContent=f.length+'건';
}

/* ── Checkbox ── */
function bnCheck(idx,el){
  BN.checked[idx]=el.checked;
  bnRenderSummary();
  bnRenderTable();
}
function bnToggleAll(el){
  var checked=el.checked;
  BN.filtered.forEach(function(b){BN.checked[b.idx]=checked});
  bnRenderSummary();
  bnRenderTable();
}

/* ── Side Panel ── */
function bnSelect(idx){
  BN.selIdx=idx;
  bnRenderTable();
  var b=BN.merged.filter(function(x){return x.idx===idx})[0];
  if(!b)return;
  document.getElementById('bnPanelTitle').textContent='['+b.idx+'] '+b.title;
  var meta='상세위치: '+(b.position||'-')+' &nbsp;|&nbsp; 기간: '+b.startDate+' ~ '+b.endDate;
  meta+=' &nbsp;|&nbsp; 상태: '+(b.isActive?'진행중':'종료');
  if(b.imageUrl)meta+='<br><img src="'+b.imageUrl+'" style="max-width:100%;max-height:80px;margin-top:4px;border-radius:3px" referrerpolicy="no-referrer" onerror="this.style.display=\'none\'">';
  document.getElementById('bnPanelMeta').innerHTML=meta;
  var now=new Date();
  document.getElementById('bnDetailEnd').value=bnFmt(now);
  document.getElementById('bnDetailStart').value=bnFmt(new Date(now.getFullYear(),now.getMonth(),now.getDate()-29));
  document.getElementById('bnOverlay').classList.add('bn--show');
  document.getElementById('bnPanel').classList.add('bn--show');
  bnRenderDetail();
}
function bnClosePanel(){
  document.getElementById('bnOverlay').classList.remove('bn--show');
  document.getElementById('bnPanel').classList.remove('bn--show');
  BN.selIdx=null;bnRenderTable();
}

function bnDetHot(key,el){
  var now=new Date(),end=bnFmt(now),start;
  switch(key){case'7d':start=bnFmt(new Date(now.getFullYear(),now.getMonth(),now.getDate()-6));break;case'14d':start=bnFmt(new Date(now.getFullYear(),now.getMonth(),now.getDate()-13));break;case'30d':start=bnFmt(new Date(now.getFullYear(),now.getMonth(),now.getDate()-29));break;case'all':start='';end='';break}
  document.getElementById('bnDetailStart').value=start;
  document.getElementById('bnDetailEnd').value=end;
  document.querySelectorAll('.bn-panel__ctrl .bn-btn:not(.bn-btn--pri)').forEach(function(b){b.classList.remove('bn-btn--on')});
  if(el)el.classList.add('bn-btn--on');
  bnRenderDetail();
}

function bnRenderDetail(){
  var bid=BN.selIdx;if(bid===null)return;
  var dd=BN.dailyMap[String(bid)]||{};
  var sd=document.getElementById('bnDetailStart').value,ed=document.getElementById('bnDetailEnd').value;
  var dates=Object.keys(dd).sort();
  if(sd)dates=dates.filter(function(d){return d>=sd});
  if(ed)dates=dates.filter(function(d){return d<=ed});
  var tv=0,tc=0,pv=0,pd='-';
  dates.forEach(function(d){var v=dd[d];tv+=v.views;tc+=v.clicks;if(v.views>pv){pv=v.views;pd=d}});
  var ctr=tv>0?(tc/tv*100):0;
  var body='<div class="bn-pcards">';
  body+='<div class="bn-pcard"><div class="bn-pcard__label">조회수</div><div class="bn-pcard__value">'+bnN(tv)+'</div></div>';
  body+='<div class="bn-pcard"><div class="bn-pcard__label">클릭수</div><div class="bn-pcard__value">'+bnN(tc)+'</div></div>';
  body+='<div class="bn-pcard"><div class="bn-pcard__label">CTR</div><div class="bn-pcard__value">'+ctr.toFixed(2)+'%</div></div>';
  body+='<div class="bn-pcard"><div class="bn-pcard__label">피크일</div><div class="bn-pcard__value" style="font-size:11px">'+pd+'</div></div>';
  body+='</div><div class="bn-chart-wrap"><canvas id="bnDetChart"></canvas></div>';
  body+='<div class="bn-panel__section">일별 상세 ('+dates.length+'일)</div>';
  body+='<div style="max-height:240px;overflow:auto"><table class="bn-dtable"><thead><tr><th>날짜</th><th>조회수</th><th>클릭수</th><th>CTR(%)</th><th>조회 전일비</th></tr></thead><tbody>';
  for(var i=dates.length-1;i>=0;i--){
    var dt=dates[i],dv=dd[dt];
    var prev=i>0?dd[dates[i-1]]:null;
    var diff=prev?dv.views-prev.views:null;
    var diffStr=diff===null?'-':bnD(diff);
    var diffCls=diff!==null&&diff!==0?(diff>0?' bn-pos':' bn-neg'):'';
    var dCtr=dv.views>0?(dv.clicks/dv.views*100).toFixed(2):'0.00';
    body+='<tr><td>'+dt+'</td><td>'+bnN(dv.views)+'</td><td>'+bnN(dv.clicks)+'</td><td>'+dCtr+'</td><td class="'+diffCls+'">'+diffStr+'</td></tr>';
  }
  body+='</tbody></table></div>';
  document.getElementById('bnPanelBody').innerHTML=body;
  // chart
  if(typeof Chart==='undefined'){setTimeout(function(){bnRenderDetail()},200);return}
  if(BN.detailChart){BN.detailChart.destroy();BN.detailChart=null}
  var cv=document.getElementById('bnDetChart');if(!cv)return;
  BN.detailChart=new Chart(cv,{type:'line',data:{labels:dates,datasets:[
    {label:'조회수',data:dates.map(function(d){return dd[d].views}),borderColor:'#4a90d9',backgroundColor:'rgba(74,144,217,.08)',borderWidth:1.5,pointRadius:dates.length>60?0:2,fill:true,tension:.3},
    {label:'클릭수',data:dates.map(function(d){return dd[d].clicks}),borderColor:'#e85d5d',backgroundColor:'rgba(232,93,93,.05)',borderWidth:1.5,pointRadius:dates.length>60?0:2,fill:true,tension:.3}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{font:{size:10},boxWidth:12}}},scales:{x:{ticks:{font:{size:9,family:"'JetBrains Mono',monospace"},maxRotation:45,autoSkip:true,maxTicksLimit:15},grid:{display:false}},y:{beginAtZero:true,ticks:{font:{size:9,family:"'JetBrains Mono',monospace"},callback:function(v){return v.toLocaleString()}},grid:{color:'#f0f4f9'}}}}});
}

/* ── Tab 2: Daily ── */
function bnDHot(key,el){
  var now=new Date(),end=bnFmt(now),start;
  switch(key){case'7d':start=bnFmt(new Date(now.getFullYear(),now.getMonth(),now.getDate()-6));break;case'14d':start=bnFmt(new Date(now.getFullYear(),now.getMonth(),now.getDate()-13));break;case'30d':start=bnFmt(new Date(now.getFullYear(),now.getMonth(),now.getDate()-29));break;case'all':start='';end='';break}
  document.getElementById('bnDailyStart').value=start;document.getElementById('bnDailyEnd').value=end;
  document.querySelectorAll('#bnTabDaily .bn-ctrl .bn-btn:not(.bn-btn--pri)').forEach(function(b){b.classList.remove('bn-btn--on')});
  if(el)el.classList.add('bn-btn--on');
  bnDailyRender();
}

function bnDSort(col){
  if(BN.dSortCol===col)BN.dSortDir=BN.dSortDir==='desc'?'asc':'desc';
  else{BN.dSortCol=col;BN.dSortDir='desc'}
  bnDailyRender();
}

function bnDailyRender(){
  var sd=document.getElementById('bnDailyStart').value,ed=document.getElementById('bnDailyEnd').value;
  var dates=Object.keys(BN.dailyTotal).sort();
  if(sd)dates=dates.filter(function(d){return d>=sd});
  if(ed)dates=dates.filter(function(d){return d<=ed});
  var tv=0,tc=0,pv=0,pd='-',rows=[];
  dates.forEach(function(dt,i){
    var dv=BN.dailyTotal[dt],v=dv.views,c=dv.clicks;
    tv+=v;tc+=c;if(v>pv){pv=v;pd=dt}
    var prev=i>0?BN.dailyTotal[dates[i-1]]:null;
    rows.push({date:dt,dow:bnDow(dt),views:v,clicks:c,ctr:v>0?(c/v*100):0,viewDiff:prev?v-prev.views:null,clickDiff:prev?c-prev.clicks:null});
  });
  var ctr=tv>0?(tc/tv*100):0;
  document.getElementById('bnDSumRange').textContent=dates.length+'일';
  document.getElementById('bnDSumViews').textContent=bnS(tv);
  document.getElementById('bnDSumClicks').textContent=bnS(tc);
  document.getElementById('bnDSumCTR').textContent=ctr.toFixed(2)+'%';
  document.getElementById('bnDSumPeak').textContent=pd+' ('+bnN(pv)+')';
  document.getElementById('bnDailyStatus').textContent=dates.length>0?dates[0]+' ~ '+dates[dates.length-1]:'-';
  var col=BN.dSortCol,dir=BN.dSortDir;
  rows.sort(function(a,b){var va=a[col],vb=b[col];if(va===null)va=-Infinity;if(vb===null)vb=-Infinity;if(typeof va==='string')return dir==='asc'?va.localeCompare(vb):vb.localeCompare(va);return dir==='asc'?va-vb:vb-va});
  document.querySelectorAll('.bn-daily-table .bn-sort').forEach(function(s){s.textContent=''});
  var se=document.getElementById('bnDS'+col);if(se)se.textContent=dir==='asc'?' \u25B2':' \u25BC';
  var h='';
  rows.forEach(function(r){
    var vd=r.viewDiff===null?'-':bnD(r.viewDiff),cd=r.clickDiff===null?'-':bnD(r.clickDiff);
    var vc=r.viewDiff!==null&&r.viewDiff!==0?(r.viewDiff>0?' bn-pos':' bn-neg'):'';
    var cc=r.clickDiff!==null&&r.clickDiff!==0?(r.clickDiff>0?' bn-pos':' bn-neg'):'';
    h+='<tr><td>'+r.date+'</td><td>'+r.dow+'</td><td>'+bnN(r.views)+'</td><td>'+bnN(r.clicks)+'</td><td>'+r.ctr.toFixed(2)+'</td><td class="'+vc+'">'+vd+'</td><td class="'+cc+'">'+cd+'</td></tr>';
  });
  document.getElementById('bnDailyTbody').innerHTML=h;
  // chart
  if(typeof Chart==='undefined'){setTimeout(function(){bnDailyRender()},200);return}
  if(BN.dailyChart){BN.dailyChart.destroy();BN.dailyChart=null}
  var cv=document.getElementById('bnDailyChart');if(!cv)return;
  BN.dailyChart=new Chart(cv,{type:'bar',data:{labels:dates,datasets:[
    {label:'조회수',data:dates.map(function(d){return BN.dailyTotal[d].views}),backgroundColor:'rgba(74,144,217,.5)',borderColor:'#4a90d9',borderWidth:1,borderRadius:2,order:2},
    {label:'클릭수',data:dates.map(function(d){return BN.dailyTotal[d].clicks}),backgroundColor:'rgba(232,93,93,.6)',borderColor:'#e85d5d',borderWidth:1,borderRadius:2,order:1}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{font:{size:10},boxWidth:12}}},scales:{x:{ticks:{font:{size:9,family:"'JetBrains Mono',monospace"},maxRotation:45,autoSkip:true,maxTicksLimit:15},grid:{display:false}},y:{beginAtZero:true,ticks:{font:{size:9,family:"'JetBrains Mono',monospace"},callback:function(v){return v.toLocaleString()}},grid:{color:'#f0f4f9'}}}}});
}

function bnDailyCopy(){
  var sd=document.getElementById('bnDailyStart').value,ed=document.getElementById('bnDailyEnd').value;
  var dates=Object.keys(BN.dailyTotal).sort();
  if(sd)dates=dates.filter(function(d){return d>=sd});if(ed)dates=dates.filter(function(d){return d<=ed});
  var lines=['날짜\t요일\t조회수\t클릭수\tCTR(%)'];
  dates.forEach(function(dt){var dv=BN.dailyTotal[dt];lines.push(dt+'\t'+bnDow(dt)+'\t'+dv.views+'\t'+dv.clicks+'\t'+(dv.views>0?(dv.clicks/dv.views*100).toFixed(2):'0.00'))});
  navigator.clipboard.writeText(lines.join('\n')).then(function(){var el=document.getElementById('bnDailyCopyOk');el.style.display='inline';setTimeout(function(){el.style.display='none'},1500)});
}

/* ── Tab 3: Report ── */
function bnGetCheckedList(){
  var ids=Object.keys(BN.checked).filter(function(k){return BN.checked[k]}).map(Number);
  return BN.merged.filter(function(b){return ids.indexOf(b.idx)!==-1}).sort(function(a,b){return b.idx-a.idx});
}

function bnRptUpdateChips(){
  var list=bnGetCheckedList();
  var h='';
  list.forEach(function(b){
    h+='<span class="bn-rpt-chip">['+b.idx+'] '+b.title.substring(0,20)+(b.title.length>20?'...':'')+' <span class="bn-rpt-chip__x" onclick="bnRptRemove('+b.idx+')">&times;</span></span>';
  });
  if(!h)h='<span style="color:#94a3b8;font-size:10px">배너 목록에서 체크박스로 선택하세요</span>';
  document.getElementById('bnRptChips').innerHTML=h;
}

function bnRptRemove(idx){
  BN.checked[idx]=false;
  bnRenderSummary();bnRenderTable();bnRptUpdateChips();
}

function bnRHot(key,el){
  var now=new Date(),end=bnFmt(now),start;
  switch(key){case'7d':start=bnFmt(new Date(now.getFullYear(),now.getMonth(),now.getDate()-6));break;case'14d':start=bnFmt(new Date(now.getFullYear(),now.getMonth(),now.getDate()-13));break;case'30d':start=bnFmt(new Date(now.getFullYear(),now.getMonth(),now.getDate()-29));break;case'all':start='';end='';break}
  document.getElementById('bnRptStart').value=start;document.getElementById('bnRptEnd').value=end;
  document.querySelectorAll('#bnTabReport .bn-ctrl .bn-btn:not(.bn-btn--pri)').forEach(function(b){b.classList.remove('bn-btn--on')});
  if(el)el.classList.add('bn-btn--on');
  bnRptRender();
}

var BN_COLORS=['#4a90d9','#e85d5d','#22c55e','#d49a2a','#8b5cf6','#06b6d4','#f43f5e','#84cc16','#f59e0b','#6366f1'];

function bnRptRender(){
  var list=bnGetCheckedList();
  if(list.length===0){
    document.getElementById('bnRptContent').innerHTML='<div class="bn-rpt-empty">배너 목록에서 체크박스로 배너를 선택한 뒤<br>"광고 리포트" 탭에서 리포트를 생성하세요</div>';
    return;
  }
  bnRptUpdateChips();
  var sd=document.getElementById('bnRptStart').value,ed=document.getElementById('bnRptEnd').value;
  if(!sd||!ed){var now=new Date();ed=bnFmt(now);sd=bnFmt(new Date(now.getFullYear(),now.getMonth(),now.getDate()-29));document.getElementById('bnRptStart').value=sd;document.getElementById('bnRptEnd').value=ed}

  // destroy old charts
  BN.rptCharts.forEach(function(c){c.destroy()});BN.rptCharts=[];

  // collect all dates in range
  var allDates={};
  list.forEach(function(b){
    var dd=BN.dailyMap[String(b.idx)]||{};
    Object.keys(dd).forEach(function(d){
      if(sd&&d<sd)return;if(ed&&d>ed)return;
      allDates[d]=true;
    });
  });
  var dates=Object.keys(allDates).sort();

  // ── Comparison chart ──
  var html='<div class="bn-rpt-section"><div class="bn-rpt-section__head">조회수 추이 비교</div><div class="bn-rpt-section__body"><div style="height:220px;position:relative"><canvas id="bnRptChartV"></canvas></div></div></div>';
  html+='<div class="bn-rpt-section"><div class="bn-rpt-section__head">클릭수 추이 비교</div><div class="bn-rpt-section__body"><div style="height:220px;position:relative"><canvas id="bnRptChartC"></canvas></div></div></div>';

  // ── Per-banner summary cards ──
  html+='<div class="bn-rpt-section"><div class="bn-rpt-section__head">배너별 요약 ('+sd+' ~ '+ed+')</div><div class="bn-rpt-section__body">';
  html+='<table class="bn-dtable"><thead><tr><th style="text-align:left">배너</th><th>idx</th><th>조회수</th><th>클릭수</th><th>CTR(%)</th><th>일평균 조회</th><th>일평균 클릭</th></tr></thead><tbody>';
  list.forEach(function(b){
    var dd=BN.dailyMap[String(b.idx)]||{};
    var tv=0,tc=0,days=0;
    dates.forEach(function(d){
      if(dd[d]){tv+=dd[d].views;tc+=dd[d].clicks;days++}
    });
    var ctr=tv>0?(tc/tv*100):0;
    var avgV=days>0?Math.round(tv/days):0;
    var avgC=days>0?Math.round(tc/days):0;
    html+='<tr><td>'+b.title.substring(0,30)+(b.title.length>30?'...':'')+'</td><td>'+b.idx+'</td><td>'+bnN(tv)+'</td><td>'+bnN(tc)+'</td><td>'+ctr.toFixed(2)+'</td><td>'+bnN(avgV)+'</td><td>'+bnN(avgC)+'</td></tr>';
  });
  html+='</tbody></table></div></div>';

  document.getElementById('bnRptContent').innerHTML=html;

  // render charts
  if(typeof Chart==='undefined'){setTimeout(function(){bnRptRender()},200);return}
  // Views chart
  var dsV=[],dsC=[];
  list.forEach(function(b,i){
    var dd=BN.dailyMap[String(b.idx)]||{};
    var color=BN_COLORS[i%BN_COLORS.length];
    var label='['+b.idx+'] '+b.title.substring(0,15);
    dsV.push({label:label,data:dates.map(function(d){return dd[d]?dd[d].views:0}),borderColor:color,backgroundColor:'transparent',borderWidth:1.5,pointRadius:dates.length>60?0:2,tension:.3});
    dsC.push({label:label,data:dates.map(function(d){return dd[d]?dd[d].clicks:0}),borderColor:color,backgroundColor:'transparent',borderWidth:1.5,pointRadius:dates.length>60?0:2,tension:.3});
  });
  var chartOpts={responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{font:{size:9},boxWidth:10}}},scales:{x:{ticks:{font:{size:8,family:"'JetBrains Mono',monospace"},maxRotation:45,autoSkip:true,maxTicksLimit:15},grid:{display:false}},y:{beginAtZero:true,ticks:{font:{size:9,family:"'JetBrains Mono',monospace"},callback:function(v){return v.toLocaleString()}},grid:{color:'#f0f4f9'}}}};
  var cvV=document.getElementById('bnRptChartV');
  if(cvV)BN.rptCharts.push(new Chart(cvV,{type:'line',data:{labels:dates,datasets:dsV},options:chartOpts}));
  var cvC=document.getElementById('bnRptChartC');
  if(cvC)BN.rptCharts.push(new Chart(cvC,{type:'line',data:{labels:dates,datasets:dsC},options:chartOpts}));
}

function bnRptCopy(){
  var list=bnGetCheckedList();if(list.length===0)return;
  var sd=document.getElementById('bnRptStart').value,ed=document.getElementById('bnRptEnd').value;
  var allDates={};
  list.forEach(function(b){
    var dd=BN.dailyMap[String(b.idx)]||{};
    Object.keys(dd).forEach(function(d){if((!sd||d>=sd)&&(!ed||d<=ed))allDates[d]=true});
  });
  var dates=Object.keys(allDates).sort();
  var lines=['배너\tidx\t조회수\t클릭수\tCTR(%)\t일평균조회\t일평균클릭'];
  list.forEach(function(b){
    var dd=BN.dailyMap[String(b.idx)]||{};
    var tv=0,tc=0,days=0;
    dates.forEach(function(d){if(dd[d]){tv+=dd[d].views;tc+=dd[d].clicks;days++}});
    var ctr=tv>0?(tc/tv*100).toFixed(2):'0.00';
    lines.push(b.title+'\t'+b.idx+'\t'+tv+'\t'+tc+'\t'+ctr+'\t'+(days>0?Math.round(tv/days):0)+'\t'+(days>0?Math.round(tc/days):0));
  });
  navigator.clipboard.writeText(lines.join('\n')).then(function(){var el=document.getElementById('bnRptCopyOk');el.style.display='inline';setTimeout(function(){el.style.display='none'},1500)});
}

/* ── Copy (Tab1) ── */
function bnCopy(){
  var f=BN.filtered.slice(),col=BN.sortCol,dir=BN.sortDir;
  f.sort(function(a,b){var va=a[col],vb=b[col];if(typeof va==='string')return dir==='asc'?va.localeCompare(vb):vb.localeCompare(va);return dir==='asc'?va-vb:vb-va});
  var lines=['idx\t배너명\t상세위치\t시작일\t종료일\t조회수\t클릭수\tCTR(%)'];
  f.forEach(function(r){lines.push(r.idx+'\t'+r.title+'\t'+r.position+'\t'+r.startDate+'\t'+r.endDate+'\t'+r.views+'\t'+r.clicks+'\t'+r.ctr.toFixed(2))});
  navigator.clipboard.writeText(lines.join('\n')).then(function(){var el=document.getElementById('bnCopyOk');el.style.display='inline';setTimeout(function(){el.style.display='none'},1500)});
}

/* ── Init ── */
(function(){
  if(typeof Chart==='undefined'){var s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js';document.head.appendChild(s)}
  setTimeout(function(){bnFetch()},0);
})();
</script>
