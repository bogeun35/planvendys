# HIFI 전표입력 양식 규격

## 개요
벤디스 ERP(HIFI)에 업로드하는 전표 엑셀 양식 규격이다.
정산 이체, 입금 매칭 등 각 업무에서 동일한 양식으로 전표를 생성한다.

## 엑셀 파일 구조

| 행 | 내용 |
|----|------|
| 1행 | 영문 컬럼명 (EVDN_SQ, EVDN_TP_CD, ...) |
| 2행 | 한글 컬럼명 (증빙순번, 증빙유형, ...) |
| 3행 | 컬럼 설명 (타입/길이/필수여부/설명) |
| 4행 | 빈 행 |
| **5행~** | **데이터 (전표 행)** |

- 전체 43컬럼 (A~AQ)
- GitHub에 양식 템플릿을 올려두고, SheetJS로 5행부터 채워넣는 방식
- 템플릿 위치: `docs/ops/templates/voucher-template.xlsx`


## 전체 컬럼 목록 (43컬럼)

| idx | 영문 | 한글 | 타입 | 필수 | 비고 |
|-----|------|------|------|------|------|
| 0 | EVDN_SQ | 증빙순번 | 숫자 | 필수 | 동일 전표 그룹은 같은 번호 |
| 1 | EVDN_TP_CD | 증빙유형 | 문자 | 필수 | |
| 2 | PARTNER_CD_EVI | 거래처코드(증빙) | 문자 | 조건부 | |
| 3 | PARTNER_NO_EVI | 사업자번호(증빙) | 문자 | 조건부 | |
| 4 | SPPRC_AMT_EVI | 공급가액(증빙) | 숫자 | 조건부 | |
| 5 | TAXAMT_AMT_EVI | 세액(증빙) | 숫자 | 조건부 | |
| 6 | EVDN_DT_EVI | 증빙일 | 문자(8) | 조건부 | YYYYMMDD |
| 7 | ELTR_EVDN_1_CONN_KEY_VAL | 국세청승인번호(증빙) | 문자 | 조건부 | 전자세금계산서용 |
| 8 | TIP_AMT | 봉사료 | 숫자 | - | 현금영수증 지출 시 |
| 9 | DEPT_CD | 부서 | 문자 | 필수 | 부서코드 |
| 10 | DRCRFG_CD | 차대 | 문자 | 필수 | |
| 11 | ACCT_CD | 계정코드 | 문자 | 필수 | |
| 12 | PARTNER_CD | 거래처코드 | 문자 | 조건부 | HIFI 거래처코드 |
| 13 | PARTNER_NO | 사업자번호 | 문자 | 조건부 | 사업자등록번호 |
| 14 | DOCU_AMT | 전표금액 | 숫자 | 필수 | |
| 15 | NOTE_DC | 적요 | 문자(200) | 필수 | 전표 설명 텍스트 |
| 16 | PJT_CD | 투자코드 | 문자 | - | |
| 17 | EVDN_CD | 증빙코드 | 문자 | - | |
| 18 | EVDN_DTL_CLAS_CD | 증빙상세항목 | 문자 | - | |
| 19 | CRNC_CD | 통화 | 문자 | 필수 | |
| 20 | EXRT_RT | 환율 | 숫자 | 필수 | |
| 21 | EXRT_RT_APLY_DT | 환율적용일 | 문자(8) | - | KRW 외 통화 시 |
| 22 | TRAN_AMT | 거래금액 | 숫자 | 필수 | KRW면 전표금액과 동일 |
| 23 | MCLS_TAX_FG | 과세구분 | 문자 | - | 관리항목 C82 |
| 24 | MCLS_FUNDS_PRARNDE | 자금예정일자 | 문자 | - | 관리항목 B22 |
| 25 | MCLS_DCST_CD | 세부거래처 | 문자 | - | 관리항목 C12 |
| 26 | MCLS_FNC_ACNT_NO | 금융계좌번호 | 문자 | - | 관리항목 A07 |
| 27 | BL_NO | BL번호 | 문자 | - | 관리항목 B07 |
| 28 | VAT_NDEDUCT_FG | 부가세공제구분 | 문자 | - | 관리항목 C83, 부가세 라인 시 |
| 29 | OCRN_WTDW_DTS | 발생(회수)연월 | 문자 | - | 관리항목 B25 |
| 30 | BIZAREA_CD | 사업장코드(부가세) | 문자(7) | - | 부가세 라인 시 |
| 31 | START_DT | 계산서일(부가세) | 문자(8) | - | YYYYMMDD |
| 32 | TAXAFS_CD | 세무구분(부가세) | 문자 | - | 과세: 11 |
| 33 | REASON_CD | 사유(부가세) | 문자 | - | |
| 34 | NDEDUCT_REASON_CD | 불공제사유(부가세) | 문자 | - | |
| 35 | SPPRC_AMT_TAX | 공급가액(부가세) | 숫자 | - | 부가세 라인 시 |
| 36 | TAXAMT_AMT_TAX | 세액(부가세) | 숫자 | - | 부가세 라인 시 |
| 37 | NTS_APRVL_NO | 국세청승인번호(부가세) | 문자 | - | 전자세금계산서 |
| 38 | RCVP_EMAIL_NM | 거래처 이메일 | 문자 | - | 매출 정발행 시 |
| 39 | SUBO_NO | 종사업장번호(부가세) | 문자 | - | |
| 40 | UPDATE_CD | 수정사유(부가세) | 문자 | - | |
| 41 | SRC_TAXBIL_NO | 원천세금번호 | 문자 | - | 수정세금계산서 시 |
| 42 | MCLS_BUYPARTNER_CD | 매입거래처코드 | 문자 | - | 관리항목 D85 |


## 실제 사용 컬럼 (조정전표 기준)

조정전표(증빙유형 10)에서 실제로 값을 넣는 컬럼은 다음과 같다.

| idx | 컬럼 | 항상 사용 | 조건부 | 값 |
|-----|------|----------|--------|-----|
| 0 | EVDN_SQ | O | | 날짜 그룹별 동일 순번 |
| 1 | EVDN_TP_CD | O | | `10/조정전표` (고정) |
| 6 | EVDN_DT_EVI | O | | `YYYYMMDD` |
| 9 | DEPT_CD | O | | 부서코드 |
| 10 | DRCRFG_CD | O | | `1/차변` 또는 `2/대변` |
| 11 | ACCT_CD | O | | 계정과목 코드 |
| 12 | PARTNER_CD | | 차변 | HIFI 거래처코드 |
| 13 | PARTNER_NO | | 차변 | 사업자등록번호 |
| 14 | DOCU_AMT | O | | 전표금액 |
| 15 | NOTE_DC | O | | 적요 |
| 19 | CRNC_CD | O | | `KRW` (고정) |
| 20 | EXRT_RT | O | | `1` (고정) |
| 22 | TRAN_AMT | O | | 전표금액과 동일 |
| 26 | MCLS_FNC_ACNT_NO | | 대변 | 출금 계좌번호 (벤디스) |


## 전표 그룹 규칙

### 증빙순번 (EVDN_SQ)
- 같은 증빙순번을 가진 행들이 하나의 전표를 구성한다
- 그룹핑 기준: **날짜 (이체일/입금일)**
- 같은 날짜의 모든 차변/대변을 동일 증빙순번으로 묶는다
- 전표 내 차변 합계 = 대변 합계 (대차 일치 필수)

### 차대 구분 (DRCRFG_CD)
| 값 | 의미 |
|----|------|
| `1/차변` | 돈이 들어온 쪽 (자산 증가 / 비용 발생 / 부채 감소) |
| `2/대변` | 돈이 나간 쪽 (자산 감소 / 수익 발생 / 부채 증가) |


## 전표 유형별 구조

### 1. 이체전표 (정산 출금)
벤디스가 가맹점에 정산금을 이체할 때 생성한다.

```
이체일 기준 그룹 (transferDate)
├── 대변 1건: 보통예금 (벤디스 출금 합계)
│   계정: 11020101 (보통예금)
│   부서: 300007 (TODO: 확인 필요)
│   금융계좌번호[26]: 벤디스 출금계좌
│   적요: "펌뱅킹출금전표_수시정산_{YYYYMMDD}"
│
├── 차변 N건: 미지급금 (개별 이체)
│   계정: 21030609 (미지급금)
│   부서: 300008 (TODO: 서비스별 매핑 확인)
│   거래처코드[12]: HIFI 거래처코드
│   사업자번호[13]: 가맹점 사업자번호
│   적요: "{정산서번호}_{은행명}_{계좌번호}_{거래처명}_{정산시작}_{정산종료}"
│
└── 대차 일치: 대변 합계 = 차변 합계
```

**적요 패턴 (차변)**: `{settlementIdx}_{transferBankName}_{transferBankAccountNumber}_{accountBizName}_{settlementStartDate}_{settlementEndDate}`

예시:
- 대변: `펌뱅킹출금전표_수시정산_20260120` (81,190,744원)
- 차변: `2026700010_기업은행_04912300456789_델리팜코리아_20260101_20260131` (24,300,357원)
- 차변: `2026700011_신한은행_140013624452_델리팜코리아_20260101_20260131` (24,496,968원)
- ...


### 2. 입금전표 (고객사 청구금 입금)
고객사가 청구서에 따라 입금했을 때 생성한다.

```
입금일 기준 그룹 (transactionDate)
├── 차변 1건: 보통예금 (입금 합계)
│   계정: 11020101 (보통예금)
│   부서: 300007
│   적요: "입금전표_{은행명}_{YYYYMMDD}"
│
├── 대변 N건: 미수금 (개별 매칭)
│   계정: 12071101 (미수금)
│   부서: 서비스별 (DEPT_MAP 참조)
│   사업자번호[13]: 고객사 사업자번호
│   적요: "{청구서명/적요}_{은행명}"
│
├── 대변 N건: 과오입금 (입금 > 청구 차이분)
│   계정: 21110118 (선수금/과오입금)
│   적요: "과오입금_{청구서명}_{은행명}"
│
└── 대차 일치: 차변 합계 = 대변 합계
```


## 계정과목 코드

| 코드 | 계정 | 용도 |
|------|------|------|
| 11020101 | 보통예금 | 은행 계좌 입출금 |
| 12071101 | 미수금 | 고객사에게 받을 청구금 |
| 21030609 | 미지급금 | 가맹점에게 줄 정산금 |
| 21110118 | 선수금/과오입금 | 입금 초과분 |


## 부서코드

| 코드 | 부서/서비스 | 비고 |
|------|-----------|------|
| 300007 | 공통 | 보통예금 합계 행에 사용 |
| 300008 | 식권대장(MEAL) | |
| 300009 | 복지대장(WELFARE) | |
| 300010 | 단체선물대장(GROUP_GIFT) | |
| 300011 | 광고(ADVERTISE) | |
| 300013 | 퀵대장(QUICK) | |
| 300014 | 법정교육(COMPULSORY_EDUCATION) | |

**매핑 기준**: `contractType` 필드로 서비스 구분
```javascript
var DEPT_MAP = {
    MEAL: '300008',
    WELFARE: '300009',
    GROUP_GIFT: '300010',
    ADVERTISE: '300011',
    QUICK: '300013',
    COMPULSORY_EDUCATION: '300014',
    '': '300007'  // 기본값
};
```


## 고정값

모든 조정전표에 공통으로 들어가는 값:

| 컬럼 | 값 | 설명 |
|------|-----|------|
| EVDN_TP_CD [1] | `10/조정전표` | 증빙유형 고정 |
| CRNC_CD [19] | `KRW` | 원화 고정 |
| EXRT_RT [20] | `1` | 환율 1 고정 |
| TRAN_AMT [22] | = DOCU_AMT | 전표금액과 동일 |


## 미확인/TODO 사항

- [ ] 이체전표 부서코드: 300007? 300008? (서비스별 매핑 필요 여부)
- [ ] 이체전표 거래처코드(PARTNER_CD [12]): Settlement 테이블에 없음 → 별도 매핑 테이블?
- [ ] 이체전표 대변 적요: "펌뱅킹출금전표_수시정산_{날짜}" 패턴이 항상 동일한지
- [ ] 이체전표 대변 금융계좌번호(MCLS_FNC_ACNT_NO [26]): 벤디스 출금계좌 → 어디서 가져오는지
- [ ] 입금전표 계정과목 정확도: 12071101(미수금), 21110118(과오입금) 확정 여부
- [ ] 입금전표 부서코드 매핑: contractType 기반이 맞는지
- [ ] 동일 거래처 여러 건 이체 시 거래처코드(PARTNER_CD) 동일하게 들어가는지
- [ ] 부가세 관련 컬럼(28~42): 조정전표에서는 사용하지 않는 것으로 보이나 확인 필요
- [ ] 증빙 관련 컬럼(2~8): 조정전표에서는 사용하지 않는 것으로 보이나 확인 필요


## 대시보드별 전표 생성 현황

| 대시보드 | 파일 | 전표 유형 | 그룹 기준 | 상태 |
|---------|------|----------|----------|------|
| 청구-입금 매칭 | billing-match.html | 입금전표 | transactionDate (입금일) | 구현완료 (계정/부서 하드코딩) |
| 정산 이체 관리 | settlement-transfer.html | 이체전표 | transferDate (이체일) | 구현완료 (계정/부서 TODO) |


## 기술 구현

### 양식 템플릿 방식
1. `voucher-template.xlsx` (1~4행만 있는 빈 양식)을 GitHub Pages에 호스팅
2. 브라우저에서 fetch로 양식을 가져옴
3. SheetJS(xlsx.full.min.js)로 파싱
4. 5행(0-indexed: row 4)부터 데이터를 셀 단위로 채움
5. 시트 범위(!ref) 업데이트 후 다운로드

### 코드 패턴
```javascript
// 1. 양식 fetch
var resp = await fetch(TEMPLATE_URL);
var buf = await resp.arrayBuffer();
var wb = XLSX.read(buf, {type: 'array'});
var ws = wb.Sheets[wb.SheetNames[0]];

// 2. 5행부터 데이터 채움
dataRows.forEach(function(row, ri) {
    row.forEach(function(val, ci) {
        if (val === '') return;
        var addr = XLSX.utils.encode_cell({r: 4 + ri, c: ci});
        ws[addr] = {v: val, t: typeof val === 'number' ? 'n' : 's'};
    });
});

// 3. 시트 범위 업데이트
var range = XLSX.utils.decode_range(ws['!ref'] || 'A1');
if (4 + dataRows.length - 1 > range.e.r) range.e.r = 4 + dataRows.length - 1;
if (42 > range.e.c) range.e.c = 42;
ws['!ref'] = XLSX.utils.encode_range(range);

// 4. 다운로드
XLSX.writeFile(wb, '전표입력_YYYYMMDD_전표유형.xlsx');
```

### 전표 행 생성 패턴
```javascript
// 43컬럼 빈 배열 생성
var row = new Array(43).fill('');

// 공통 필수값
row[0] = seq;              // EVDN_SQ: 증빙순번
row[1] = '10/조정전표';      // EVDN_TP_CD
row[6] = '20260120';       // EVDN_DT_EVI: YYYYMMDD
row[9] = '300008';         // DEPT_CD
row[10] = '1/차변';         // DRCRFG_CD
row[11] = '21030609';      // ACCT_CD
row[14] = 1000000;         // DOCU_AMT
row[15] = '적요 텍스트';     // NOTE_DC
row[19] = 'KRW';           // CRNC_CD
row[20] = 1;               // EXRT_RT
row[22] = 1000000;         // TRAN_AMT (= DOCU_AMT)

// 조건부 (차변일 때)
row[12] = '1110056';       // PARTNER_CD: 거래처코드
row[13] = '1850601433';    // PARTNER_NO: 사업자번호

// 조건부 (대변/보통예금일 때)
row[26] = '104730802403';  // MCLS_FNC_ACNT_NO: 금융계좌번호
```
