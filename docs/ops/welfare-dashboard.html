<!--
title: 복지대장 지급현황 대시보드
-->

<style>
.wf{display:flex;flex-direction:column;gap:12px;font-size:12px;color:#1a2332;position:relative}
.wf-loading{display:none;position:absolute;inset:0;background:rgba(255,255,255,.85);z-index:50;flex-direction:column;align-items:center;justify-content:center;gap:10px;border-radius:4px}
.wf-loading.active{display:flex}
.wf-loading__bar{width:200px;height:4px;background:#e2e8f0;border-radius:2px;overflow:hidden}
.wf-loading__fill{height:100%;background:#4a90d9;border-radius:2px;transition:width .3s ease;width:0}
.wf-loading__text{font-size:11px;color:#4a5568}
.wf-ctrl{display:flex;align-items:center;gap:8px;padding:8px 12px;background:#f8fafd;border:1px solid #e2e8f0;border-radius:4px;flex-wrap:wrap}
.wf-ctrl label{font-weight:600;color:#4a5568;white-space:nowrap}
.wf-ctrl input[type="date"]{padding:4px 8px;border:1px solid #d1d5db;border-radius:3px;font-size:12px;font-family:'Noto Sans KR',sans-serif;background:#fff;color:#1a2332;outline:none}
.wf-ctrl input[type="date"]:focus{border-color:#4a90d9;box-shadow:0 0 0 1px #4a90d9}
.wf-btn{padding:4px 14px;background:#4a90d9;color:#fff;border:none;border-radius:3px;font-size:12px;font-family:'Noto Sans KR',sans-serif;font-weight:600;cursor:pointer;white-space:nowrap;transition:background .15s}
.wf-btn:hover{background:#3a7bc8}
.wf-btn:disabled{background:#94a3b8;cursor:not-allowed}
.wf-btn--sm{padding:3px 10px;font-size:11px;font-weight:500;background:#fff;color:#4a5568;border:1px solid #d1d5db;border-radius:3px;cursor:pointer;transition:all .15s}
.wf-btn--sm:hover{background:#eef4fb;border-color:#4a90d9;color:#4a90d9}
.wf-btn--sm.copied{background:#22c55e;color:#fff;border-color:#22c55e}
.wf-hots{display:flex;gap:4px;margin-left:4px;padding-left:8px;border-left:1px solid #e2e8f0}
.wf-hot{padding:3px 8px;background:#fff;color:#4a5568;border:1px solid #d1d5db;border-radius:3px;font-size:11px;font-family:'Noto Sans KR',sans-serif;cursor:pointer;white-space:nowrap;transition:all .15s}
.wf-hot:hover{background:#eef4fb;border-color:#4a90d9;color:#4a90d9}
.wf-hot.active{background:#eef4fb;border-color:#4a90d9;color:#4a90d9;font-weight:600}
.wf-status{font-size:11px;color:#94a3b8;margin-left:auto;white-space:nowrap}
.wf-status--err{color:#e85d5d}
.wf-cards{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.wf-card{padding:10px 12px;background:#fff;border:1px solid #e2e8f0;border-radius:4px}
.wf-card__label{font-size:11px;color:#94a3b8;margin-bottom:4px}
.wf-card__value{font-size:16px;font-weight:700;color:#1a2332;font-family:'JetBrains Mono',monospace}
.wf-body{display:grid;grid-template-columns:1fr 340px;gap:12px;min-height:0}
.wf-grid-panel{border:1px solid #e2e8f0;border-radius:4px;background:#fff;display:flex;flex-direction:column;overflow:hidden}
.wf-grid-toolbar{display:flex;align-items:center;gap:8px;padding:6px 10px;background:#f8fafd;border-bottom:1px solid #e2e8f0}
.wf-grid-toolbar input{flex:1;padding:3px 8px;border:1px solid #d1d5db;border-radius:3px;font-size:11px;font-family:'Noto Sans KR',sans-serif;outline:none}
.wf-grid-toolbar input:focus{border-color:#4a90d9}
.wf-grid-toolbar span{font-size:11px;color:#94a3b8;white-space:nowrap}
.wf-grid-wrap{overflow:auto;max-height:440px}
.wf-grid{width:100%;border-collapse:collapse;font-size:12px;user-select:text;table-layout:fixed}
.wf-grid thead{position:sticky;top:0;z-index:2}
.wf-grid th{padding:5px 10px;text-align:left;font-weight:600;color:#4a5568;background:#f0f4f9;border-bottom:1px solid #e2e8f0;border-right:1px solid #edf1f7;white-space:nowrap;cursor:pointer;user-select:none;position:relative}
.wf-resizer{position:absolute;top:0;right:0;width:5px;height:100%;cursor:col-resize;user-select:none;z-index:2}
.wf-resizer:hover,.wf-resizer.wf-resizing{background:#4a90d9;opacity:0.4}
.wf-grid td{overflow:hidden;text-overflow:ellipsis}
.wf-grid th:last-child{border-right:none}
.wf-grid th:hover{background:#e6ecf3}
.wf-grid td{padding:4px 10px;border-bottom:1px solid #f0f4f9;border-right:1px solid #f5f7fa;white-space:nowrap}
.wf-grid td:last-child{border-right:none}
.wf-grid tbody tr{cursor:pointer;transition:background .08s}
.wf-grid tbody tr:hover td{background:#f8fafd}
.wf-grid tbody tr.selected td{background:#eef4fb}
.wf-grid td.cell-sel{background:#dce6f2!important;outline:1px solid #4a90d9;outline-offset:-1px}
.wf-grid td.cell-rng{background:#eef4fb!important}
.wf-grid .col-r{text-align:right;font-family:'JetBrains Mono',monospace;font-size:11px}
.wf-grid .col-c{text-align:center}
.wf-grid .col-id{color:#94a3b8;font-family:'JetBrains Mono',monospace;font-size:10px}
.wf-grid .col-rank{color:#94a3b8;font-size:11px;text-align:center;width:32px}
.amount-neg{color:#e85d5d}
.wf-detail{border:1px solid #e2e8f0;border-radius:4px;background:#fff;display:flex;flex-direction:column;overflow:hidden}
.wf-detail__head{padding:8px 12px;background:#f8fafd;border-bottom:1px solid #e2e8f0;font-weight:600;color:#4a5568;font-size:11px}
.wf-detail__body{padding:12px;overflow-y:auto;max-height:440px}
.wf-detail__empty{color:#94a3b8;font-size:11px;text-align:center;padding:40px 12px}
.wf-detail__name{font-size:14px;font-weight:700;margin-bottom:2px;color:#1a2332}
.wf-detail__id{font-size:10px;color:#94a3b8;font-family:'JetBrains Mono',monospace;margin-bottom:10px;word-break:break-all}
.wf-detail__stats{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid #f0f4f9}
.wf-detail__stat-label{font-size:10px;color:#94a3b8}
.wf-detail__stat-value{font-size:13px;font-weight:700;color:#1a2332;font-family:'JetBrains Mono',monospace}
.wf-detail__row{display:grid;grid-template-columns:80px 1fr 70px;gap:6px;align-items:center;padding:3px 8px;background:#f8fafd;border-radius:3px;font-size:11px;margin-bottom:2px}
.wf-detail__row .d{color:#4a5568;font-family:'JetBrains Mono',monospace}
.wf-detail__row .a{font-family:'JetBrains Mono',monospace;font-weight:600;text-align:right}
.wf-detail__bar-section{margin-top:12px;padding-top:10px;border-top:1px solid #f0f4f9}
.wf-detail__bar-title{font-size:11px;color:#94a3b8;margin-bottom:8px}
.wf-bar{display:flex;align-items:center;gap:6px;margin-bottom:3px;font-size:10px}
.wf-bar .bl{width:54px;text-align:right;color:#4a5568;font-family:'JetBrains Mono',monospace;flex-shrink:0}
.wf-bar .bf{height:14px;border-radius:2px;min-width:2px;transition:width .3s ease}
.wf-bar .bv{color:#94a3b8;font-family:'JetBrains Mono',monospace;flex-shrink:0}
.wf-compare{border:1px solid #e2e8f0;border-radius:4px;background:#fff;overflow:hidden}
.wf-compare__head{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:#f8fafd;border-bottom:1px solid #e2e8f0}
.wf-compare__title{font-size:12px;font-weight:600;color:#4a5568}
.wf-compare__body{padding:12px}
.wf-compare__empty{text-align:center;padding:24px;font-size:12px;color:#94a3b8}
.wf-cmp-summary{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px}
.wf-cmp-card{padding:8px 10px;background:#f8fafd;border-radius:4px;border:1px solid #edf1f7}
.wf-cmp-card__label{font-size:10px;color:#94a3b8;margin-bottom:3px}
.wf-cmp-card__row{display:flex;align-items:baseline;gap:6px}
.wf-cmp-card__val{font-size:14px;font-weight:700;font-family:'JetBrains Mono',monospace}
.wf-cmp-card__change{font-size:11px;font-family:'JetBrains Mono',monospace;font-weight:600}
.wf-cmp-card__change.up{color:#22c55e}
.wf-cmp-card__change.down{color:#e85d5d}
.wf-cmp-card__change.flat{color:#94a3b8}
.wf-cmp-card__sub{font-size:10px;color:#94a3b8;margin-top:2px;font-family:'JetBrains Mono',monospace}
.wf-chart{margin-bottom:16px}
.wf-chart__title{font-size:11px;color:#94a3b8;margin-bottom:8px}
.wf-chart__legend{display:flex;gap:16px;margin-bottom:8px;font-size:11px}
.wf-chart__legend-item{display:flex;align-items:center;gap:4px}
.wf-chart__legend-dot{width:10px;height:10px;border-radius:2px}
.wf-chart__bars{display:flex;align-items:flex-end;gap:2px;height:160px;padding:0 4px;border-bottom:1px solid #e2e8f0}
.wf-chart__col{display:flex;flex-direction:column;align-items:center;flex:1;gap:1px;height:100%}
.wf-chart__col-bars{display:flex;gap:1px;align-items:flex-end;flex:1;width:100%}
.wf-chart__fill{flex:1;border-radius:2px 2px 0 0;min-height:2px;transition:height .3s ease}
.wf-chart__label{font-size:9px;color:#94a3b8;font-family:'JetBrains Mono',monospace;padding-top:3px}
.wf-cmp-table{width:100%;border-collapse:collapse;font-size:11px;table-layout:fixed}
.wf-cmp-table thead{position:sticky;top:0;z-index:1}
.wf-cmp-table th{padding:4px 8px;text-align:left;font-weight:600;color:#4a5568;background:#f0f4f9;border-bottom:1px solid #e2e8f0;border-right:1px solid #edf1f7;white-space:nowrap;cursor:pointer;user-select:none;position:relative}
.wf-cmp-table td{overflow:hidden;text-overflow:ellipsis}
.wf-cmp-table th:last-child{border-right:none}
.wf-cmp-table th:hover{background:#e6ecf3}
.wf-cmp-table td{padding:3px 8px;border-bottom:1px solid #f0f4f9;border-right:1px solid #f5f7fa;white-space:nowrap}
.wf-cmp-table td:last-child{border-right:none}
.wf-cmp-table .col-r{text-align:right;font-family:'JetBrains Mono',monospace}
.wf-cmp-table .col-id{color:#94a3b8;font-family:'JetBrains Mono',monospace;font-size:10px}
.wf-cmp-table tbody tr:hover td{background:#f8fafd}
/* Insight Section */
.wf-insight{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.wf-insight__panel{border:1px solid #e2e8f0;border-radius:4px;background:#fff;padding:12px;overflow:hidden}
.wf-insight__title{font-size:11px;font-weight:600;color:#4a5568;margin-bottom:10px}
.wf-insight__bars{display:flex;align-items:flex-end;gap:1px;height:120px;border-bottom:1px solid #e2e8f0}
.wf-insight__bar-col{flex:1;display:flex;flex-direction:column;align-items:center;height:100%;justify-content:flex-end}
.wf-insight__bar-fill{width:100%;border-radius:2px 2px 0 0;min-height:1px;background:#4a90d9;transition:height .3s}
.wf-insight__bar-label{font-size:8px;color:#94a3b8;font-family:'JetBrains Mono',monospace;padding-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;text-align:center}
.wf-insight__row{display:flex;align-items:center;gap:6px;margin-bottom:4px;font-size:11px}
.wf-insight__row .lbl{width:80px;color:#4a5568;flex-shrink:0;font-size:10px}
.wf-insight__row .bar{height:14px;border-radius:2px;background:#4a90d9;min-width:2px;transition:width .3s}
.wf-insight__row .bar.acc{background:#d49a2a}
.wf-insight__row .val{color:#94a3b8;font-family:'JetBrains Mono',monospace;font-size:10px;flex-shrink:0;white-space:nowrap}
.wf-insight__dist-row{display:flex;align-items:center;gap:6px;margin-bottom:3px;font-size:11px}
.wf-insight__dist-row .lbl{width:90px;color:#4a5568;font-size:10px;flex-shrink:0}
.wf-insight__dist-row .cnt{width:40px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:10px;color:#1a2332;flex-shrink:0}
.wf-insight__dist-row .bar{height:12px;border-radius:2px;background:#4a90d9;min-width:2px;flex:1;max-width:150px}

/* Detail 2-column layout */
.wf-detail__dates{display:flex;flex-direction:column;gap:2px;margin-bottom:8px}
.wf-detail__date-header{display:grid;grid-template-columns:72px 1fr 58px;gap:4px;padding:3px 6px;font-size:10px;font-weight:600;color:#94a3b8;border-bottom:1px solid #e2e8f0}
.wf-detail__date-row{padding:4px 6px;border-radius:3px;background:#f8fafd}
.wf-detail__date-summary{display:grid;grid-template-columns:72px 1fr 58px;gap:4px;align-items:center;font-size:11px}
.wf-detail__date-summary .d{color:#4a5568;font-family:'JetBrains Mono',monospace}
.wf-detail__date-summary .a{font-family:'JetBrains Mono',monospace;font-weight:600;text-align:right}
.wf-detail__users{margin-top:3px;padding-left:4px;border-left:2px solid #e2e8f0}
.wf-detail__user-row{display:grid;grid-template-columns:1fr 58px;gap:4px;padding:1px 6px;font-size:10px;color:#94a3b8}
.wf-detail__user-row .uid{font-family:'JetBrains Mono',monospace;overflow:hidden;text-overflow:ellipsis}
.wf-detail__user-row .ua{font-family:'JetBrains Mono',monospace;text-align:right;color:#4a5568}

.wf-empty{display:flex;align-items:center;justify-content:center;height:200px;color:#94a3b8;font-size:13px;border:1px solid #e2e8f0;border-radius:4px;background:#fff}
@keyframes wf-spin{to{transform:rotate(360deg)}}
</style>

<div class="wf" id="wfRoot">
    <div class="wf-loading" id="wfLoading">
        <div class="wf-loading__bar"><div class="wf-loading__fill" id="wfLoadFill"></div></div>
        <div class="wf-loading__text" id="wfLoadText">데이터 조회 중...</div>
    </div>
    <div class="wf-ctrl">
        <label>시작일</label><input type="date" id="wfStart" />
        <label>종료일</label><input type="date" id="wfEnd" />
        <button class="wf-btn" id="wfFetchBtn" onclick="wfFetch()">조회</button>
        <div class="wf-hots">
            <button class="wf-hot" onclick="wfHot('today',this)">오늘</button>
            <button class="wf-hot active" onclick="wfHot('thisMonth',this)">이번달</button>
            <button class="wf-hot" onclick="wfHot('lastMonth',this)">지난달</button>
            <button class="wf-hot" onclick="wfHot('twoMonthsAgo',this)">지지난달</button>
            <button class="wf-hot" onclick="wfHot('thisYear',this)">올해</button>
            <button class="wf-hot" onclick="wfHot('lastYear',this)">작년</button>
        </div>
        <span class="wf-status" id="wfStatus">조회 버튼을 눌러주세요</span>
    </div>
    <div class="wf-cards" id="wfCards" style="display:none">
        <div class="wf-card"><div class="wf-card__label">총 지급액</div><div class="wf-card__value" id="cTotal">-</div></div>
        <div class="wf-card"><div class="wf-card__label">고객사 수</div><div class="wf-card__value" id="cCompany">-</div></div>
        <div class="wf-card"><div class="wf-card__label">고유 사용자</div><div class="wf-card__value" id="cUsers">-</div></div>
        <div class="wf-card"><div class="wf-card__label">건수</div><div class="wf-card__value" id="cTx">-</div></div>
        <div class="wf-card"><div class="wf-card__label">인당 평균</div><div class="wf-card__value" id="cAvgUser">-</div></div>
    </div>
    <div class="wf-body" id="wfBody" style="display:none">
        <div class="wf-grid-panel">
            <div class="wf-grid-toolbar">
                <input type="text" id="wfSearch" placeholder="고객사명 또는 comId 검색..." oninput="wfFilter()" />
                <span id="wfCount">0개사</span>
                <button class="wf-btn--sm" id="wfCopyBtn" onclick="wfCopyTable()">클립보드 복사</button>
            </div>
            <div class="wf-grid-wrap" id="wfGridWrap">
                <table class="wf-grid" id="wfGrid">
                    <thead><tr>
                        <th class="col-rank" style="width:40px" onclick="wfSort('rank')">#<div class="wf-resizer" onmousedown="wfResizeStart(event)"></div></th>
                        <th onclick="wfSort('comId')" style="min-width:290px">comId<div class="wf-resizer" onmousedown="wfResizeStart(event)"></div></th>
                        <th onclick="wfSort('name')" style="min-width:120px">고객사명<div class="wf-resizer" onmousedown="wfResizeStart(event)"></div></th>
                        <th class="col-r" onclick="wfSort('totalAmount')">지급액(원)<div class="wf-resizer" onmousedown="wfResizeStart(event)"></div></th>
                        <th class="col-c" onclick="wfSort('userCount')">사용자(명)<div class="wf-resizer" onmousedown="wfResizeStart(event)"></div></th>
                        <th class="col-r" onclick="wfSort('avgPerUser')">인당 평균(원)<div class="wf-resizer" onmousedown="wfResizeStart(event)"></div></th>
                        <th class="col-c" onclick="wfSort('txCount')">건수</th>
                    </tr></thead>
                    <tbody id="wfTbody"></tbody>
                </table>
            </div>
        </div>
        <div class="wf-detail">
            <div class="wf-detail__head">고객사 상세 (날짜별)</div>
            <div class="wf-detail__body" id="wfDetail"><div class="wf-detail__empty">테이블에서 고객사를 클릭하세요</div></div>
        </div>
    </div>
    <div class="wf-insight" id="wfInsight" style="display:none">
        <div class="wf-insight__panel" id="wfInsDaily"><div class="wf-insight__title">일자별 지급 추이</div></div>
        <div class="wf-insight__panel" id="wfInsPareto"><div class="wf-insight__title">상위 고객사 집중도</div></div>
        <div class="wf-insight__panel" id="wfInsDist"><div class="wf-insight__title">고객사 규모 분포</div></div>
    </div>
    <div class="wf-compare" id="wfCompare" style="display:none">
        <div class="wf-compare__head">
            <div class="wf-compare__title">전년 동기간 비교</div>
            <button class="wf-btn" id="wfCmpBtn" onclick="wfCmpFetch()">비교하기</button>
        </div>
        <div class="wf-compare__body" id="wfCmpBody"><div class="wf-compare__empty">조회 후 비교하기 버튼을 눌러주세요</div></div>
    </div>
    <div class="wf-empty" id="wfEmpty">조회 기간을 선택하고 조회 버튼을 눌러주세요</div>
</div>

<script>
var W={
    PROXY:'https://script.google.com/macros/s/AKfycbzyZ3GkPnU_1D_gax47Fa96GGCz-kVJU3QReBIoMzLo54PcfONtFe_h7QS2vRNxTZq3/exec',
    QID:1339, raw:[], grouped:[], filtered:[],
    sortCol:'totalAmount', sortDir:'desc', selComId:null,
    cmpRows:[], cmpSortCol:'diff', cmpSortDir:'desc'
};

function wfApi(p){var q=Object.keys(p).map(function(k){return k+'='+encodeURIComponent(p[k])}).join('&');return fetch(W.PROXY+'?'+q,{redirect:'follow'}).then(function(r){return r.json()})}
function wfLoadShow(m,p){document.getElementById('wfLoading').classList.add('active');document.getElementById('wfLoadText').textContent=m||'';document.getElementById('wfLoadFill').style.width=(p||10)+'%'}
function wfLoadProg(m,p){document.getElementById('wfLoadText').textContent=m;document.getElementById('wfLoadFill').style.width=p+'%'}
function wfLoadHide(){document.getElementById('wfLoading').classList.remove('active')}

/* Date */
function wfFd(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')}
function wfLd(y,m){return new Date(y,m,0).getDate()}
function wfHot(k,el){
    var n=new Date(),y=n.getFullYear(),m=n.getMonth(),s,e;
    switch(k){
        case'today':s=e=wfFd(n);break;
        case'thisMonth':s=y+'-'+String(m+1).padStart(2,'0')+'-01';e=y+'-'+String(m+1).padStart(2,'0')+'-'+String(wfLd(y,m+1)).padStart(2,'0');break;
        case'lastMonth':var lm=m===0?11:m-1,ly=m===0?y-1:y;s=ly+'-'+String(lm+1).padStart(2,'0')+'-01';e=ly+'-'+String(lm+1).padStart(2,'0')+'-'+String(wfLd(ly,lm+1)).padStart(2,'0');break;
        case'twoMonthsAgo':var tm=m-2,ty=y;if(tm<0){tm+=12;ty--}s=ty+'-'+String(tm+1).padStart(2,'0')+'-01';e=ty+'-'+String(tm+1).padStart(2,'0')+'-'+String(wfLd(ty,tm+1)).padStart(2,'0');break;
        case'thisYear':s=y+'-01-01';e=y+'-12-31';break;
        case'lastYear':s=(y-1)+'-01-01';e=(y-1)+'-12-31';break;
    }
    document.getElementById('wfStart').value=s;document.getElementById('wfEnd').value=e;
    var bs=document.querySelectorAll('.wf-hot');for(var i=0;i<bs.length;i++)bs[i].classList.remove('active');if(el)el.classList.add('active');
}
(function(){var n=new Date(),y=n.getFullYear(),m=n.getMonth();document.getElementById('wfStart').value=y+'-'+String(m+1).padStart(2,'0')+'-01';document.getElementById('wfEnd').value=y+'-'+String(m+1).padStart(2,'0')+'-'+String(wfLd(y,m+1)).padStart(2,'0')})();
function wfSetStatus(t,err){var el=document.getElementById('wfStatus');el.className='wf-status'+(err?' wf-status--err':'');el.textContent=t}
function wfShowEmpty(){document.getElementById('wfEmpty').style.display='flex';document.getElementById('wfBody').style.display='none';document.getElementById('wfCards').style.display='none';document.getElementById('wfInsight').style.display='none';document.getElementById('wfCompare').style.display='none'}

/* Fetch */
async function wfFetch(){
    var sd=document.getElementById('wfStart').value,ed=document.getElementById('wfEnd').value;
    if(!sd||!ed)return;
    document.getElementById('wfFetchBtn').disabled=true;
    wfLoadShow('Redash 쿼리 실행 중...',15);
    document.getElementById('wfCmpBody').innerHTML='<div class="wf-compare__empty">조회 후 비교하기 버튼을 눌러주세요</div>';
    try{
        var d=await wfApi({action:'post',queryId:W.QID,startDate:sd,endDate:ed});
        if(d&&d.query_result){wfLoadProg('데이터 처리 중...',80);wfProcess(d.query_result.data.rows,sd,ed);wfLoadHide();document.getElementById('wfFetchBtn').disabled=false;return}
        if(d&&d.job){await wfPoll(d.job.id,sd,ed);wfLoadHide();document.getElementById('wfFetchBtn').disabled=false;return}
        wfLoadHide();wfSetStatus('조회 실패: '+(d&&d.message?d.message:'응답 없음'),true);wfShowEmpty();
    }catch(e){wfLoadHide();console.error(e);wfSetStatus('조회 실패: '+e.message,true);wfShowEmpty()}
    document.getElementById('wfFetchBtn').disabled=false;
}
async function wfPoll(jid,sd,ed){
    for(var i=0;i<60;i++){
        await new Promise(function(r){setTimeout(r,1000)});
        wfLoadProg('쿼리 실행 중... ('+(i+1)+'s)',15+Math.min(i*1.2,60));
        var d=await wfApi({action:'job',jobId:jid});
        if(d.job.status===3){wfLoadProg('데이터 처리 중...',80);var rd=await wfApi({action:'result',resultId:d.job.query_result_id});wfProcess(rd.query_result.data.rows,sd,ed);return}
        if(d.job.status===4)throw new Error(d.job.error||'fail');
    }throw new Error('타임아웃');
}

/* Process */
function wfProcess(rows,sd,ed){
    W.raw=rows.map(function(r){return{comId:String(r.comId||''),name:String(r.name||''),userId:String(r.userId||''),executeDate:String(r.executeDate||''),amount:Number(r.amount)||0}});
    var map={},allUsers=new Set();
    W.raw.forEach(function(r){
        allUsers.add(r.userId);
        if(!map[r.comId])map[r.comId]={comId:r.comId,name:r.name,totalAmount:0,users:new Set(),txCount:0};
        var g=map[r.comId];g.totalAmount+=r.amount;g.users.add(r.userId);g.txCount++;
    });
    W.grouped=Object.values(map).map(function(g){g.userCount=g.users.size;g.avgPerUser=g.userCount>0?Math.round(g.totalAmount/g.userCount):0;return g});
    W.grouped.sort(function(a,b){return b.totalAmount-a.totalAmount});
    var ta=0;W.grouped.forEach(function(g){ta+=g.totalAmount});
    document.getElementById('cTotal').textContent=wfN(ta)+'원';
    document.getElementById('cCompany').textContent=W.grouped.length.toLocaleString()+'개';
    document.getElementById('cUsers').textContent=allUsers.size.toLocaleString()+'명';
    document.getElementById('cTx').textContent=W.raw.length.toLocaleString()+'건';
    document.getElementById('cAvgUser').textContent=(allUsers.size>0?wfN(Math.round(ta/allUsers.size)):'-')+'원';
    document.getElementById('wfCards').style.display='grid';
    document.getElementById('wfBody').style.display='grid';
    document.getElementById('wfInsight').style.display='grid';
    document.getElementById('wfCompare').style.display='block';
    document.getElementById('wfEmpty').style.display='none';
    W.sortCol='totalAmount';W.sortDir='desc';W.selComId=null;
    document.getElementById('wfSearch').value='';
    wfRender();wfRenderDetail();wfRenderInsight();
    wfSetStatus(sd+' ~ '+ed+' ('+W.grouped.length+'개사, '+W.raw.length+'건)');
}

/* Grid */
function wfRender(){
    var q=(document.getElementById('wfSearch').value||'').toLowerCase();
    W.filtered=W.grouped.filter(function(g){return!q||g.name.toLowerCase().indexOf(q)>=0||g.comId.toLowerCase().indexOf(q)>=0});
    W.filtered.sort(function(a,b){var va=a[W.sortCol],vb=b[W.sortCol];if(typeof va==='string'){va=va.toLowerCase();vb=vb.toLowerCase()}return W.sortDir==='asc'?(va<vb?-1:va>vb?1:0):(va>vb?-1:va<vb?1:0)});
    document.getElementById('wfTbody').innerHTML=W.filtered.map(function(g,i){
        var sel=W.selComId===g.comId?' selected':'';
        return'<tr class="'+sel+'" onclick="wfSelect(\''+g.comId.replace(/'/g,"\\'")+'\')">'
            +'<td class="col-rank">'+(i+1)+'</td>'
            +'<td class="col-id">'+g.comId+'</td>'
            +'<td>'+g.name+'</td>'
            +'<td class="col-r">'+wfN(g.totalAmount)+'</td>'
            +'<td class="col-c">'+g.userCount.toLocaleString()+'</td>'
            +'<td class="col-r">'+wfN(g.avgPerUser)+'</td>'
            +'<td class="col-c">'+g.txCount+'</td></tr>';
    }).join('');
    document.getElementById('wfCount').textContent=W.filtered.length+'개사';
}
function wfFilter(){wfRender()}
function wfSort(c){if(c==='rank')c='totalAmount';if(W.sortCol===c){W.sortDir=W.sortDir==='asc'?'desc':'asc'}else{W.sortCol=c;W.sortDir=c==='name'||c==='comId'?'asc':'desc'}wfRender()}
function wfSelect(cid){W.selComId=W.selComId===cid?null:cid;wfRender();wfRenderDetail()}

/* 클립보드 복사 (헤더포함, 숫자만) */
function wfCopyTable(){
    var h=['#','comId','고객사명','지급액(원)','사용자(명)','인당 평균(원)','건수'].join('\t');
    var rows=W.filtered.map(function(g,i){return[(i+1),g.comId,g.name,g.totalAmount,g.userCount,g.avgPerUser,g.txCount].join('\t')});
    wfClip(h+'\n'+rows.join('\n'),'wfCopyBtn');
}
function wfClip(text,btnId){
    navigator.clipboard.writeText(text).then(function(){
        var btn=document.getElementById(btnId);btn.textContent='복사 완료';btn.classList.add('copied');
        setTimeout(function(){btn.textContent='클립보드 복사';btn.classList.remove('copied')},1500);
    });
}

/* 셀 범위선택 + Ctrl+C */
(function(){
    var dragging=false,sTd=null,eTd=null;
    document.addEventListener('mousedown',function(e){var td=e.target.closest('#wfGrid td');if(!td)return;dragging=true;sTd=eTd=td;hl()});
    document.addEventListener('mousemove',function(e){if(!dragging)return;var td=e.target.closest('#wfGrid td');if(td){eTd=td;hl()}});
    document.addEventListener('mouseup',function(){dragging=false});
    document.addEventListener('copy',function(e){
        var sels=document.querySelectorAll('#wfGrid td.cell-sel,#wfGrid td.cell-rng');if(!sels.length)return;
        var rm={};sels.forEach(function(td){var tr=td.parentElement,ri=Array.from(tr.parentElement.children).indexOf(tr),ci=Array.from(tr.children).indexOf(td);if(!rm[ri])rm[ri]={};rm[ri][ci]=td.textContent.trim()});
        var lines=Object.keys(rm).sort(function(a,b){return a-b}).map(function(ri){var cols=rm[ri];return Object.keys(cols).sort(function(a,b){return a-b}).map(function(ci){return cols[ci]}).join('\t')});
        e.clipboardData.setData('text/plain',lines.join('\n'));e.preventDefault();
    });
    function hl(){
        document.querySelectorAll('#wfGrid td.cell-sel,#wfGrid td.cell-rng').forEach(function(td){td.classList.remove('cell-sel','cell-rng')});
        if(!sTd||!eTd)return;var tbody=document.getElementById('wfTbody');if(!tbody)return;
        var rows=Array.from(tbody.children),sr=rows.indexOf(sTd.parentElement),sc=Array.from(sTd.parentElement.children).indexOf(sTd);
        var er=rows.indexOf(eTd.parentElement),ec=Array.from(eTd.parentElement.children).indexOf(eTd);
        var r1=Math.min(sr,er),r2=Math.max(sr,er),c1=Math.min(sc,ec),c2=Math.max(sc,ec);
        for(var ri=r1;ri<=r2;ri++){var row=rows[ri];if(!row)continue;var cells=row.children;for(var ci=c1;ci<=c2;ci++){if(cells[ci])cells[ci].classList.add(ri===sr&&ci===sc?'cell-sel':'cell-rng')}}
    }
})();

/* Detail - 2단 구조: 날짜별 요약 + userId 리스트 */
function wfRenderDetail(){
    var body=document.getElementById('wfDetail');
    if(!W.selComId){body.innerHTML='<div class="wf-detail__empty">테이블에서 고객사를 클릭하세요</div>';return}
    var g=W.grouped.find(function(x){return x.comId===W.selComId});
    if(!g){body.innerHTML='<div class="wf-detail__empty">데이터 없음</div>';return}

    // 날짜별 그룹 + 각 날짜의 userId별 내역
    var dateMap={},rawByDate={};
    W.raw.filter(function(r){return r.comId===W.selComId}).forEach(function(r){
        if(!dateMap[r.executeDate])dateMap[r.executeDate]={date:r.executeDate,amount:0,users:new Set(),count:0};
        var d=dateMap[r.executeDate];d.amount+=r.amount;d.users.add(r.userId);d.count++;
        if(!rawByDate[r.executeDate])rawByDate[r.executeDate]=[];
        rawByDate[r.executeDate].push({userId:r.userId,amount:r.amount});
    });
    var dates=Object.values(dateMap).sort(function(a,b){return a.date.localeCompare(b.date)});
    var mx=Math.max.apply(null,dates.map(function(d){return Math.abs(d.amount)}).concat([1]));

    var h='<div class="wf-detail__name">'+g.name+'</div>'
        +'<div class="wf-detail__id">'+g.comId+'</div>'
        +'<div class="wf-detail__stats">'
        +'<div><div class="wf-detail__stat-label">총 지급액</div><div class="wf-detail__stat-value">'+wfN(g.totalAmount)+'원</div></div>'
        +'<div><div class="wf-detail__stat-label">고유 사용자</div><div class="wf-detail__stat-value">'+g.userCount.toLocaleString()+'명</div></div>'
        +'<div><div class="wf-detail__stat-label">인당 평균</div><div class="wf-detail__stat-value">'+wfN(g.avgPerUser)+'원</div></div>'
        +'<div><div class="wf-detail__stat-label">건수</div><div class="wf-detail__stat-value">'+g.txCount+'건</div></div>'
        +'</div>';

    h+='<div style="font-size:11px;color:#4a5568;font-weight:600;margin-bottom:4px">날짜별 내역 + 사용자</div>';
    h+='<div class="wf-detail__date-header"><span>날짜</span><span></span><span style="text-align:right">소계</span></div>';
    h+='<div class="wf-detail__dates">';
    dates.forEach(function(d){
        var w=Math.max((Math.abs(d.amount)/mx)*100,2);
        var users=rawByDate[d.date]||[];
        h+='<div class="wf-detail__date-row">'
            +'<div class="wf-detail__date-summary">'
            +'<span class="d">'+d.date.slice(5)+'</span>'
            +'<span class="bf" style="height:10px;border-radius:2px;background:'+(d.amount<0?'#e85d5d':'#4a90d9')+';width:'+w+'%"></span>'
            +'<span class="a'+(d.amount<0?' amount-neg':'')+'">'+wfS(d.amount)+'</span>'
            +'</div>';
        // userId별 하위 리스트
        if(users.length>0){
            h+='<div class="wf-detail__users">';
            users.sort(function(a,b){return Math.abs(b.amount)-Math.abs(a.amount)});
            users.forEach(function(u){
                h+='<div class="wf-detail__user-row">'
                    +'<span class="uid" title="'+u.userId+'">'+u.userId+'</span>'
                    +'<span class="ua'+(u.amount<0?' amount-neg':'')+'">'+wfN(u.amount)+'</span></div>';
            });
            h+='</div>';
        }
        h+='</div>';
    });
    h+='</div>';
    body.innerHTML=h;
}

/* ═══ Insight ═══ */
function wfRenderInsight(){
    wfInsDaily();
    wfInsPareto();
    wfInsDist();
}

/* 1. 일자별 전체 지급 추이 */
function wfInsDaily(){
    var el=document.getElementById('wfInsDaily');
    var dateMap={};
    W.raw.forEach(function(r){
        if(!dateMap[r.executeDate])dateMap[r.executeDate]={amount:0,count:0,users:new Set()};
        var d=dateMap[r.executeDate];d.amount+=r.amount;d.count++;d.users.add(r.userId);
    });
    var dates=Object.keys(dateMap).sort();
    if(!dates.length){el.innerHTML='<div class="wf-insight__title">일자별 지급 추이</div><div style="color:#94a3b8;font-size:11px;text-align:center;padding:20px">데이터 없음</div>';return}
    var mx=0;dates.forEach(function(d){mx=Math.max(mx,dateMap[d].amount)});
    if(mx===0)mx=1;

    var h='<div class="wf-insight__title">일자별 지급 추이 ('+dates.length+'일)</div>';
    h+='<div class="wf-insight__bars">';
    dates.forEach(function(d){
        var v=dateMap[d];
        var pct=Math.max((v.amount/mx)*100,1);
        h+='<div class="wf-insight__bar-col" title="'+d+'\n'+wfS(v.amount)+' / '+v.users.size+'명 / '+v.count+'건">'
            +'<div class="wf-insight__bar-fill" style="height:'+pct+'%"></div>'
            +'</div>';
    });
    h+='</div><div style="display:flex;justify-content:space-between;font-size:9px;color:#94a3b8;font-family:JetBrains Mono,monospace;margin-top:2px"><span>'+dates[0].slice(5)+'</span><span>'+dates[dates.length-1].slice(5)+'</span></div>';
    // 요약
    var total=0,maxDay='',maxAmt=0,minDay='',minAmt=Infinity;
    dates.forEach(function(d){var a=dateMap[d].amount;total+=a;if(a>maxAmt){maxAmt=a;maxDay=d}if(a<minAmt){minAmt=a;minDay=d}});
    var avg=dates.length>0?Math.round(total/dates.length):0;
    h+='<div style="margin-top:8px;font-size:10px;color:#4a5568;line-height:1.6">'
        +'일평균: <b style="font-family:JetBrains Mono,monospace">'+wfS(avg)+'</b>'
        +' / 최고: <b style="font-family:JetBrains Mono,monospace">'+maxDay.slice(5)+' '+wfS(maxAmt)+'</b>'
        +' / 최저: <b style="font-family:JetBrains Mono,monospace">'+minDay.slice(5)+' '+wfS(minAmt)+'</b></div>';
    el.innerHTML=h;
}

/* 2. 상위 고객사 집중도 (파레토) */
function wfInsPareto(){
    var el=document.getElementById('wfInsPareto');
    var sorted=W.grouped.slice().sort(function(a,b){return b.totalAmount-a.totalAmount});
    var total=0;sorted.forEach(function(g){total+=g.totalAmount});
    if(!sorted.length||total===0){el.innerHTML='<div class="wf-insight__title">상위 고객사 집중도</div><div style="color:#94a3b8;font-size:11px;text-align:center;padding:20px">데이터 없음</div>';return}

    // 구간별 누적 계산
    var tiers=[1,3,5,10,20,50];
    var results=[];
    tiers.forEach(function(n){
        if(n>sorted.length)return;
        var sum=0;for(var i=0;i<n&&i<sorted.length;i++)sum+=sorted[i].totalAmount;
        var pct=(sum/total*100).toFixed(1);
        results.push({n:n,sum:sum,pct:parseFloat(pct)});
    });

    var h='<div class="wf-insight__title">상위 고객사 집중도 (총 '+sorted.length+'개사)</div>';
    results.forEach(function(r){
        h+='<div class="wf-insight__row">'
            +'<span class="lbl">상위 '+r.n+'개사</span>'
            +'<span class="bar" style="width:'+Math.max(r.pct*1.2,2)+'px"></span>'
            +'<span class="bar acc" style="width:'+Math.max(r.pct*1.2,2)+'px;opacity:0.3"></span>'
            +'<span class="val">'+r.pct+'% ('+wfS(r.sum)+')</span></div>';
    });
    // 상위 5개사 리스트
    h+='<div style="margin-top:8px;border-top:1px solid #f0f4f9;padding-top:6px">';
    sorted.slice(0,5).forEach(function(g,i){
        var pct=(g.totalAmount/total*100).toFixed(1);
        h+='<div style="display:flex;gap:4px;font-size:10px;margin-bottom:2px;align-items:center">'
            +'<span style="color:#94a3b8;width:14px;text-align:right">'+(i+1)+'</span>'
            +'<span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#4a5568">'+g.name+'</span>'
            +'<span style="font-family:JetBrains Mono,monospace;color:#1a2332;font-weight:600">'+pct+'%</span></div>';
    });
    h+='</div>';
    el.innerHTML=h;
}

/* 3. 고객사 규모 분포 */
function wfInsDist(){
    var el=document.getElementById('wfInsDist');
    var buckets=[
        {label:'1억 이상',min:1e8,max:Infinity,count:0,sum:0},
        {label:'5천만~1억',min:5e7,max:1e8,count:0,sum:0},
        {label:'1천만~5천만',min:1e7,max:5e7,count:0,sum:0},
        {label:'500만~1천만',min:5e6,max:1e7,count:0,sum:0},
        {label:'100만~500만',min:1e6,max:5e6,count:0,sum:0},
        {label:'10만~100만',min:1e5,max:1e6,count:0,sum:0},
        {label:'10만 미만',min:0,max:1e5,count:0,sum:0}
    ];
    W.grouped.forEach(function(g){
        var a=g.totalAmount;
        for(var i=0;i<buckets.length;i++){
            if(a>=buckets[i].min&&a<buckets[i].max){buckets[i].count++;buckets[i].sum+=a;break}
        }
    });
    var maxCnt=0;buckets.forEach(function(b){if(b.count>maxCnt)maxCnt=b.count});
    if(maxCnt===0)maxCnt=1;

    var h='<div class="wf-insight__title">고객사 규모 분포 (지급액 기준)</div>';
    buckets.forEach(function(b){
        if(b.count===0)return;
        var w=Math.max((b.count/maxCnt)*120,2);
        h+='<div class="wf-insight__dist-row">'
            +'<span class="lbl">'+b.label+'</span>'
            +'<span class="cnt">'+b.count+'개사</span>'
            +'<span class="bar" style="width:'+w+'px"></span>'
            +'<span class="val">'+wfS(b.sum)+'</span></div>';
    });
    el.innerHTML=h;
}

/* ═══ Compare ═══ */
async function wfCmpFetch(){
    var sd=document.getElementById('wfStart').value,ed=document.getElementById('wfEnd').value;
    if(!sd||!ed||!W.raw.length)return;
    var psd=wfShiftY(sd,-1),ped=wfShiftY(ed,-1);
    document.getElementById('wfCmpBtn').disabled=true;
    wfLoadShow('전년 동기간 조회 중... ('+psd+' ~ '+ped+')',15);
    try{
        var d=await wfApi({action:'post',queryId:W.QID,startDate:psd,endDate:ped});
        if(d&&d.query_result){wfLoadProg('비교 처리 중...',80);wfBuildCmp(d.query_result.data.rows,psd,ped);wfLoadHide();document.getElementById('wfCmpBtn').disabled=false;return}
        if(d&&d.job){
            for(var i=0;i<60;i++){await new Promise(function(r){setTimeout(r,1000)});wfLoadProg('쿼리 실행 중... ('+(i+1)+'s)',15+Math.min(i*1.2,60));
                var j=await wfApi({action:'job',jobId:d.job.id});
                if(j.job.status===3){wfLoadProg('비교 처리 중...',80);var rd=await wfApi({action:'result',resultId:j.job.query_result_id});wfBuildCmp(rd.query_result.data.rows,psd,ped);wfLoadHide();document.getElementById('wfCmpBtn').disabled=false;return}
                if(j.job.status===4)throw new Error(j.job.error||'fail');
            }throw new Error('타임아웃');
        }throw new Error(d&&d.message?d.message:'응답 없음');
    }catch(e){wfLoadHide();document.getElementById('wfCmpBody').innerHTML='<div class="wf-compare__empty" style="color:#e85d5d">비교 실패: '+e.message+'</div>'}
    document.getElementById('wfCmpBtn').disabled=false;
}
function wfShiftY(ds,off){var p=ds.split('-');var y=parseInt(p[0])+off,m=parseInt(p[1]),d=parseInt(p[2]),mx=wfLd(y,m);if(d>mx)d=mx;return y+'-'+String(m).padStart(2,'0')+'-'+String(d).padStart(2,'0')}

function wfBuildCmp(prevRows,psd,ped){
    var sd=document.getElementById('wfStart').value;
    var pm={},prevAll=new Set();
    prevRows.forEach(function(r){
        var cid=String(r.comId||''),amt=Number(r.amount)||0,uid=String(r.userId||'');
        prevAll.add(uid);
        if(!pm[cid])pm[cid]={comId:cid,name:String(r.name||''),totalAmount:0,users:new Set(),txCount:0};
        pm[cid].totalAmount+=amt;pm[cid].users.add(uid);pm[cid].txCount++;
    });
    var prevArr=Object.values(pm).map(function(g){g.userCount=g.users.size;return g});
    var curTot=0,curUsers=new Set();W.raw.forEach(function(r){curTot+=r.amount;curUsers.add(r.userId)});
    var curUC=curUsers.size,curCC=W.grouped.length;
    var prevTot=0;prevArr.forEach(function(g){prevTot+=g.totalAmount});
    var prevUC=prevAll.size,prevCC=prevArr.length;

    var h='<div class="wf-cmp-summary">';
    h+=wfCmpCard('총 지급액',curTot,prevTot,true);
    h+=wfCmpCard('고객사 수',curCC,prevCC,false);
    h+=wfCmpCard('사용자',curUC,prevUC,false);
    h+=wfCmpCard('인당 평균',curUC>0?Math.round(curTot/curUC):0,prevUC>0?Math.round(prevTot/prevUC):0,true);
    h+='</div>';

    // 월별 차트
    var curM=wfByMonth(W.raw,'amount'),prevM=wfByMonth(prevRows.map(function(r){return{executeDate:String(r.executeDate||''),amount:Number(r.amount)||0}}),'amount');
    var months=wfMergeM(curM,prevM,sd.slice(0,4),psd.slice(0,4));
    if(months.length>0){
        var maxV=0;months.forEach(function(mk){maxV=Math.max(maxV,curM[mk.cur]||0,prevM[mk.prev]||0)});
        h+='<div class="wf-chart"><div class="wf-chart__title">월별 지급액 비교</div>'
            +'<div class="wf-chart__legend"><div class="wf-chart__legend-item"><div class="wf-chart__legend-dot" style="background:#4a90d9"></div>'+sd.slice(0,4)+'년 (당기)</div>'
            +'<div class="wf-chart__legend-item"><div class="wf-chart__legend-dot" style="background:#d1d5db"></div>'+psd.slice(0,4)+'년 (전년)</div></div>'
            +'<div class="wf-chart__bars">';
        months.forEach(function(mk){
            var cv=curM[mk.cur]||0,pv=prevM[mk.prev]||0;
            var ch=maxV>0?Math.max((cv/maxV)*140,2):2,ph=maxV>0?Math.max((pv/maxV)*140,2):2;
            h+='<div class="wf-chart__col"><div class="wf-chart__col-bars">'
                +'<div class="wf-chart__fill" style="height:'+ph+'px;background:#d1d5db" title="전년 '+wfS(pv)+'"></div>'
                +'<div class="wf-chart__fill" style="height:'+ch+'px;background:#4a90d9" title="당기 '+wfS(cv)+'"></div>'
                +'</div><div class="wf-chart__label">'+mk.label+'</div></div>';
        });
        h+='</div></div>';
    }

    // 비교 테이블 데이터 생성
    W.cmpRows=[];
    W.grouped.forEach(function(g){
        var prev=pm[g.comId];var pAmt=prev?prev.totalAmount:0;var pUC=prev?prev.userCount:0;var pAvg=pUC>0?Math.round(pAmt/pUC):0;
        W.cmpRows.push({comId:g.comId,name:g.name,curAmt:g.totalAmount,prevAmt:pAmt,diff:g.totalAmount-pAmt,curUC:g.userCount,prevUC:pUC,diffUC:g.userCount-pUC,curAvg:g.avgPerUser,prevAvg:pAvg,diffAvg:g.avgPerUser-pAvg});
    });
    prevArr.forEach(function(p){
        if(!W.grouped.find(function(g){return g.comId===p.comId})){
            var pAvg=p.userCount>0?Math.round(p.totalAmount/p.userCount):0;
            W.cmpRows.push({comId:p.comId,name:p.name,curAmt:0,prevAmt:p.totalAmount,diff:-p.totalAmount,curUC:0,prevUC:p.userCount,diffUC:-p.userCount,curAvg:0,prevAvg:pAvg,diffAvg:-pAvg});
        }
    });
    W.cmpSortCol='diff';W.cmpSortDir='desc';
    wfCmpSortApply();

    h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">'
        +'<div style="font-size:11px;color:#4a5568;font-weight:600">고객사별 전년 비교 ('+W.cmpRows.length+'개사)</div>'
        +'<button class="wf-btn--sm" id="wfCmpCopyBtn" onclick="wfCmpCopy()">클립보드 복사</button></div>'
        +'<div style="overflow-x:auto;max-height:400px;overflow-y:auto">'
        +'<table class="wf-cmp-table" id="wfCmpTable"><thead><tr>'
        +'<th onclick="wfCmpSort(\'comId\')" style="min-width:290px">comId<div class="wf-resizer" onmousedown="wfResizeStart(event)"></div></th>'
        +'<th onclick="wfCmpSort(\'name\')" style="min-width:120px">고객사명<div class="wf-resizer" onmousedown="wfResizeStart(event)"></div></th>'
        +'<th class="col-r" onclick="wfCmpSort(\'curAmt\')">당기(원)<div class="wf-resizer" onmousedown="wfResizeStart(event)"></div></th>'
        +'<th class="col-r" onclick="wfCmpSort(\'prevAmt\')">전년(원)<div class="wf-resizer" onmousedown="wfResizeStart(event)"></div></th>'
        +'<th class="col-r" onclick="wfCmpSort(\'diff\')">증감(원)<div class="wf-resizer" onmousedown="wfResizeStart(event)"></div></th>'
        +'<th class="col-r" onclick="wfCmpSort(\'pct\')">증감률(%)<div class="wf-resizer" onmousedown="wfResizeStart(event)"></div></th>'
        +'<th class="col-r" onclick="wfCmpSort(\'curUC\')">당기(명)<div class="wf-resizer" onmousedown="wfResizeStart(event)"></div></th>'
        +'<th class="col-r" onclick="wfCmpSort(\'prevUC\')">전년(명)<div class="wf-resizer" onmousedown="wfResizeStart(event)"></div></th>'
        +'<th class="col-r" onclick="wfCmpSort(\'diffUC\')">증감(명)<div class="wf-resizer" onmousedown="wfResizeStart(event)"></div></th>'
        +'<th class="col-r" onclick="wfCmpSort(\'curAvg\')">당기 평균(원)<div class="wf-resizer" onmousedown="wfResizeStart(event)"></div></th>'
        +'<th class="col-r" onclick="wfCmpSort(\'prevAvg\')">전년 평균(원)<div class="wf-resizer" onmousedown="wfResizeStart(event)"></div></th>'
        +'<th class="col-r" onclick="wfCmpSort(\'diffAvg\')">평균 증감(원)</th>'
        +'</tr></thead><tbody id="wfCmpTbody"></tbody></table></div>';
    document.getElementById('wfCmpBody').innerHTML=h;
    wfCmpRender();
}

function wfCmpSortApply(){
    W.cmpRows.sort(function(a,b){
        var va,vb;
        if(W.cmpSortCol==='pct'){va=a.prevAmt?a.diff/Math.abs(a.prevAmt):(a.curAmt>0?9999:-9999);vb=b.prevAmt?b.diff/Math.abs(b.prevAmt):(b.curAmt>0?9999:-9999)}
        else if(W.cmpSortCol==='diff'){va=Math.abs(a.diff);vb=Math.abs(b.diff)}
        else{va=a[W.cmpSortCol];vb=b[W.cmpSortCol]}
        if(typeof va==='string'){va=va.toLowerCase();vb=vb.toLowerCase()}
        return W.cmpSortDir==='asc'?(va<vb?-1:va>vb?1:0):(va>vb?-1:va<vb?1:0);
    });
}
function wfCmpSort(c){
    if(W.cmpSortCol===c){W.cmpSortDir=W.cmpSortDir==='asc'?'desc':'asc'}
    else{W.cmpSortCol=c;W.cmpSortDir=c==='name'||c==='comId'?'asc':'desc'}
    wfCmpSortApply();wfCmpRender();
}
function wfCmpRender(){
    var tb=document.getElementById('wfCmpTbody');if(!tb)return;
    tb.innerHTML=W.cmpRows.map(function(r){
        var pct=r.prevAmt!==0?((r.diff/Math.abs(r.prevAmt))*100).toFixed(1):(r.curAmt>0?'NEW':(r.curAmt===0&&r.prevAmt>0?'OUT':'-'));
        var cls=r.diff>0?' style="color:#22c55e"':r.diff<0?' style="color:#e85d5d"':'';
        var clsU=r.diffUC>0?' style="color:#22c55e"':r.diffUC<0?' style="color:#e85d5d"':'';
        var clsA=r.diffAvg>0?' style="color:#22c55e"':r.diffAvg<0?' style="color:#e85d5d"':'';
        return'<tr>'
            +'<td class="col-id">'+r.comId+'</td>'
            +'<td>'+r.name+'</td>'
            +'<td class="col-r">'+wfN(r.curAmt)+'</td>'
            +'<td class="col-r" style="color:#94a3b8">'+wfN(r.prevAmt)+'</td>'
            +'<td class="col-r"'+cls+'>'+wfD(r.diff)+'</td>'
            +'<td class="col-r"'+cls+'>'+pct+'</td>'
            +'<td class="col-r">'+wfN(r.curUC)+'</td>'
            +'<td class="col-r" style="color:#94a3b8">'+wfN(r.prevUC)+'</td>'
            +'<td class="col-r"'+clsU+'>'+wfD(r.diffUC)+'</td>'
            +'<td class="col-r">'+wfN(r.curAvg)+'</td>'
            +'<td class="col-r" style="color:#94a3b8">'+wfN(r.prevAvg)+'</td>'
            +'<td class="col-r"'+clsA+'>'+wfD(r.diffAvg)+'</td></tr>';
    }).join('');
}

/* 비교 테이블 클립보드 복사 */
function wfCmpCopy(){
    var h=['comId','고객사명','당기(원)','전년(원)','증감(원)','증감률(%)','당기(명)','전년(명)','증감(명)','당기 평균(원)','전년 평균(원)','평균 증감(원)'].join('\t');
    var rows=W.cmpRows.map(function(r){
        var pct=r.prevAmt!==0?((r.diff/Math.abs(r.prevAmt))*100).toFixed(1):(r.curAmt>0?'NEW':(r.curAmt===0&&r.prevAmt>0?'OUT':'-'));
        return[r.comId,r.name,r.curAmt,r.prevAmt,r.diff,pct,r.curUC,r.prevUC,r.diffUC,r.curAvg,r.prevAvg,r.diffAvg].join('\t');
    });
    wfClip(h+'\n'+rows.join('\n'),'wfCmpCopyBtn');
}

function wfCmpCard(label,cur,prev,isMoney){
    var diff=cur-prev,pct=prev!==0?((diff/Math.abs(prev))*100).toFixed(1):'0.0';
    var cls=diff>0?'up':diff<0?'down':'flat',arrow=diff>0?'+':'';
    return'<div class="wf-cmp-card"><div class="wf-cmp-card__label">'+label+'</div><div class="wf-cmp-card__row"><div class="wf-cmp-card__val">'+(isMoney?wfS(cur):cur.toLocaleString())+'</div><div class="wf-cmp-card__change '+cls+'">'+arrow+(isMoney?wfS(diff):(diff>0?'+':'')+diff)+' ('+pct+'%)</div></div><div class="wf-cmp-card__sub">전년: '+(isMoney?wfS(prev):prev.toLocaleString())+'</div></div>';
}
function wfByMonth(rows,field){var m={};rows.forEach(function(r){var mk=r.executeDate?r.executeDate.slice(0,7):'';if(mk)m[mk]=(m[mk]||0)+(Number(r[field])||0)});return m}
function wfMergeM(a,b,curY,prevY){var ms=new Set();Object.keys(a).forEach(function(k){ms.add(k.slice(5,7))});Object.keys(b).forEach(function(k){ms.add(k.slice(5,7))});return Array.from(ms).sort().map(function(m){return{cur:curY+'-'+m,prev:prevY+'-'+m,label:m+'월'}})}

/* ── Column Resize ── */
var wfResizeState={th:null,startX:0,startW:0};
function wfResizeStart(e){e.stopPropagation();e.preventDefault();var th=e.target.parentElement;wfResizeState.th=th;wfResizeState.startX=e.clientX;wfResizeState.startW=th.offsetWidth;e.target.classList.add('wf-resizing');document.addEventListener('mousemove',wfResizeMove);document.addEventListener('mouseup',wfResizeEnd);}
function wfResizeMove(e){if(!wfResizeState.th)return;var newW=Math.max(40,wfResizeState.startW+(e.clientX-wfResizeState.startX));wfResizeState.th.style.width=newW+'px';}
function wfResizeEnd(){if(wfResizeState.th){var r=wfResizeState.th.querySelector('.wf-resizer');if(r)r.classList.remove('wf-resizing');}wfResizeState.th=null;document.removeEventListener('mousemove',wfResizeMove);document.removeEventListener('mouseup',wfResizeEnd);}

/* 포맷 함수 */
function wfN(v){if(v===0)return'0';return(v<0?'-':'')+Math.abs(v).toLocaleString()}
function wfS(v){var p=v<0?'-':'',a=Math.abs(v);if(a>=1e8)return p+(a/1e8).toFixed(1)+'억';if(a>=1e4)return p+(a/1e4).toFixed(0)+'만';return p+a.toLocaleString()}
function wfD(v){if(v===0)return'-';return(v>0?'+':'')+wfN(v)}
</script>
