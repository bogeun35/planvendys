<!--
title: 일자별 잔여식대
meta: 최종 수정: 2026.02.18
-->

<style>
.dp{font-family:'Noto Sans KR',sans-serif;font-size:12px;color:#1a2332;position:relative}
.dp *{box-sizing:border-box}
.dp-ctrl{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid #e2e8f0;flex-wrap:wrap}
.dp-ctrl label{font-size:11px;color:#94a3b8}
.dp-ctrl input[type=date]{border:1px solid #d1d5db;border-radius:3px;padding:3px 6px;font-size:12px;font-family:'Noto Sans KR',sans-serif}
.dp-ctrl .dp-btn{padding:4px 12px;border:1px solid #d1d5db;border-radius:3px;background:#fff;cursor:pointer;font-size:11px;font-family:'Noto Sans KR',sans-serif;color:#4a5568}
.dp-ctrl .dp-btn:hover{background:#f0f4f9}
.dp-ctrl .dp-btn--primary{background:#4a90d9;color:#fff;border-color:#4a90d9}
.dp-ctrl .dp-btn--primary:hover{background:#3a7bc8}
.dp-ctrl .dp-btn--active{background:#eef4fb;border-color:#4a90d9;color:#4a90d9}
.dp-ctrl .dp-sep{width:1px;height:20px;background:#e2e8f0}
.dp-status{margin-left:auto;font-size:11px;color:#94a3b8}
.dp-hint{font-size:10px;color:#94a3b8;font-style:italic;margin-left:4px}

.dp-summary{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;padding:10px 0}
.dp-card{background:#f8fafd;border:1px solid #e2e8f0;border-radius:4px;padding:8px 10px}
.dp-card__label{font-size:10px;color:#94a3b8;margin-bottom:2px}
.dp-card__value{font-size:15px;font-weight:700;font-family:'JetBrains Mono',monospace;color:#1a2332}

.dp-tbar{display:flex;align-items:center;gap:6px;padding:6px 0;border-bottom:1px solid #e2e8f0}
.dp-tbar input[type=text]{width:200px;border:1px solid #d1d5db;border-radius:3px;padding:3px 6px;font-size:11px;font-family:'Noto Sans KR',sans-serif}
.dp-tbar .dp-btn{padding:3px 8px;font-size:11px}
.dp-copy-ok{color:#22c55e;font-size:11px;display:none}
.dp-cnt{font-size:11px;color:#94a3b8}

.dp-twrap{overflow:auto;max-height:calc(100vh - 300px);min-height:300px}
.dp-table{width:100%;border-collapse:collapse}
.dp-table th{position:sticky;top:0;background:#f0f4f9;border-bottom:2px solid #d1d5db;padding:4px 8px;font-size:11px;font-weight:600;color:#4a5568;text-align:right;cursor:pointer;white-space:nowrap;z-index:1}
.dp-table th:first-child,.dp-table th:nth-child(2),.dp-table th:nth-child(3){text-align:left}
.dp-table th:hover{background:#e2e8f0}
.dp-table th .dp-sort{font-size:9px;margin-left:2px;color:#94a3b8}
.dp-table td{padding:4px 8px;border-bottom:1px solid #f0f4f9;font-size:11px;text-align:right;font-family:'JetBrains Mono',monospace;white-space:nowrap}
.dp-table td:first-child{text-align:center;font-family:'JetBrains Mono',monospace;font-size:10px;color:#94a3b8;width:36px}
.dp-table td:nth-child(2){text-align:left;font-family:'JetBrains Mono',monospace;font-size:10px;color:#4a5568;max-width:100px;overflow:hidden;text-overflow:ellipsis}
.dp-table td:nth-child(3){text-align:left;font-family:'Noto Sans KR',sans-serif;font-size:11px;max-width:160px;overflow:hidden;text-overflow:ellipsis}
.dp-table tr{cursor:pointer}
.dp-table tr:hover{background:#f8fafd}
.dp-table tr.dp-row--sel{background:#eef4fb}
.dp-table .dp-neg{color:#e85d5d}
.dp-table .dp-pos{color:#22c55e}

/* ── Side Panel ── */
.dp-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.15);z-index:100;opacity:0;pointer-events:none;transition:opacity 0.2s}
.dp-overlay.dp-show{opacity:1;pointer-events:auto}
.dp-panel{position:fixed;top:0;right:0;bottom:0;width:520px;background:#fff;z-index:101;box-shadow:-4px 0 20px rgba(0,0,0,0.1);transform:translateX(100%);transition:transform 0.25s ease;display:flex;flex-direction:column;font-family:'Noto Sans KR',sans-serif}
.dp-panel.dp-show{transform:translateX(0)}
.dp-panel__head{display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid #e2e8f0;background:#f8fafd;gap:8px;flex-shrink:0}
.dp-panel__title{font-size:14px;font-weight:700;color:#1a2332;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dp-panel__close{width:28px;height:28px;border:1px solid #d1d5db;border-radius:3px;background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;color:#4a5568;flex-shrink:0}
.dp-panel__close:hover{background:#f0f4f9}
.dp-panel__sub{font-size:10px;color:#94a3b8;padding:4px 16px 0;flex-shrink:0}
.dp-panel__ctrl{display:flex;align-items:center;gap:6px;padding:8px 16px;border-bottom:1px solid #e2e8f0;flex-shrink:0;flex-wrap:wrap}
.dp-panel__ctrl label{font-size:11px;color:#94a3b8}
.dp-panel__ctrl input[type=date]{border:1px solid #d1d5db;border-radius:3px;padding:3px 6px;font-size:11px;font-family:'Noto Sans KR',sans-serif}
.dp-panel__ctrl .dp-btn{padding:3px 8px;font-size:10px}
.dp-panel__body{flex:1;overflow:auto;padding:12px 16px}
.dp-panel__cards{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:12px}
.dp-pcard{background:#f8fafd;border:1px solid #e2e8f0;border-radius:3px;padding:5px 7px}
.dp-pcard__label{font-size:10px;color:#94a3b8}
.dp-pcard__value{font-size:13px;font-weight:700;font-family:'JetBrains Mono',monospace}
.dp-panel__section{font-size:11px;font-weight:600;color:#4a5568;margin:8px 0 4px}
.dp-dtable{width:100%;border-collapse:collapse}
.dp-dtable th{background:#f0f4f9;padding:3px 6px;font-size:10px;font-weight:600;color:#4a5568;text-align:right;border-bottom:1px solid #d1d5db;position:sticky;top:0;z-index:1}
.dp-dtable th:first-child{text-align:left}
.dp-dtable td{padding:3px 6px;font-size:11px;text-align:right;font-family:'JetBrains Mono',monospace;border-bottom:1px solid #f0f4f9}
.dp-dtable td:first-child{text-align:left;font-family:'Noto Sans KR',sans-serif;font-size:11px}
.dp-dtable .dp-neg{color:#e85d5d}
.dp-dtable .dp-pos{color:#22c55e}
.dp-chart-wrap{margin-top:10px;height:180px;position:relative}

/* ── Loading ── */
.dp-loading{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.85);display:none;align-items:center;justify-content:center;z-index:10;flex-direction:column;gap:8px}
.dp-loading.dp-show{display:flex}
.dp-loading__bar{width:200px;height:4px;background:#e2e8f0;border-radius:2px;overflow:hidden}
.dp-loading__fill{height:100%;background:#4a90d9;border-radius:2px;width:0%;transition:width 0.3s}
.dp-loading__text{font-size:11px;color:#4a5568}
</style>

<div class="dp" id="dpRoot">
  <div class="dp-ctrl">
    <label>시작일</label>
    <input type="date" id="dpStart" min="2026-02-17">
    <label>종료일</label>
    <input type="date" id="dpEnd" min="2026-02-17">
    <button class="dp-btn dp-btn--primary" onclick="dpFetch()">조회</button>
    <div class="dp-sep"></div>
    <button class="dp-btn" onclick="dpHot('today',this)">오늘</button>
    <button class="dp-btn" onclick="dpHot('yesterday',this)">어제</button>
    <button class="dp-btn" onclick="dpHot('thisWeek',this)">이번주</button>
    <button class="dp-btn" onclick="dpHot('lastWeek',this)">지난주</button>
    <button class="dp-btn" onclick="dpHot('thisMonth',this)">이번달</button>
    <button class="dp-btn" onclick="dpHot('lastMonth',this)">지난달</button>
    <span class="dp-hint">범위 선택 시 마지막 날짜의 잔액이 표시됩니다</span>
    <span class="dp-status" id="dpStatus"></span>
  </div>
  <div class="dp-summary">
    <div class="dp-card"><div class="dp-card__label">조회 고객사</div><div class="dp-card__value" id="dpSumCom">-</div></div>
    <div class="dp-card"><div class="dp-card__label">총합 잔여</div><div class="dp-card__value" id="dpSumTotal">-</div></div>
    <div class="dp-card"><div class="dp-card__label">일일식대</div><div class="dp-card__value" id="dpSumDaily">-</div></div>
    <div class="dp-card"><div class="dp-card__label">장기식대</div><div class="dp-card__value" id="dpSumLong">-</div></div>
    <div class="dp-card"><div class="dp-card__label">무제한식대</div><div class="dp-card__value" id="dpSumUnlimited">-</div></div>
    <div class="dp-card"><div class="dp-card__label">신청식대</div><div class="dp-card__value" id="dpSumRequest">-</div></div>
    <div class="dp-card"><div class="dp-card__label">복지포인트</div><div class="dp-card__value" id="dpSumWelfare">-</div></div>
  </div>
  <div class="dp-tbar">
    <input type="text" id="dpSearch" placeholder="고객사명 / comId 검색" oninput="dpFilter()">
    <span class="dp-cnt" id="dpCnt"></span>
    <button class="dp-btn" onclick="dpCopy()">복사</button>
    <span class="dp-copy-ok" id="dpCopyOk">복사됨</span>
  </div>
  <div class="dp-twrap">
    <table class="dp-table">
      <thead><tr>
        <th style="width:36px;cursor:default">No</th>
        <th onclick="dpSort('comId')">comId<span class="dp-sort" id="dpSortcomId"></span></th>
        <th onclick="dpSort('comName')" style="min-width:120px">고객사명<span class="dp-sort" id="dpSortcomName"></span></th>
        <th onclick="dpSort('daily')">일일식대(원)<span class="dp-sort" id="dpSortdaily"></span></th>
        <th onclick="dpSort('longTerm')">장기식대(원)<span class="dp-sort" id="dpSortlongTerm"></span></th>
        <th onclick="dpSort('unlimited')">무제한식대(원)<span class="dp-sort" id="dpSortunlimited"></span></th>
        <th onclick="dpSort('request')">신청식대(원)<span class="dp-sort" id="dpSortrequest"></span></th>
        <th onclick="dpSort('welfare')">복지포인트(원)<span class="dp-sort" id="dpSortwelfare"></span></th>
        <th onclick="dpSort('total')">총합(원)<span class="dp-sort" id="dpSorttotal"></span></th>
      </tr></thead>
      <tbody id="dpTbody"></tbody>
    </table>
  </div>
  <div class="dp-loading" id="dpLoading">
    <div class="dp-loading__bar"><div class="dp-loading__fill" id="dpLoadFill"></div></div>
    <div class="dp-loading__text" id="dpLoadText">데이터 조회 중...</div>
  </div>
</div>

<div class="dp-overlay" id="dpOverlay" onclick="dpClosePanel()"></div>
<div class="dp-panel" id="dpPanel">
  <div class="dp-panel__head">
    <div class="dp-panel__title" id="dpPanelTitle">-</div>
    <button class="dp-panel__close" onclick="dpClosePanel()">&#x2715;</button>
  </div>
  <div class="dp-panel__sub" id="dpPanelSub"></div>
  <div class="dp-panel__ctrl">
    <label>시작</label>
    <input type="date" id="dpDetailStart" min="2026-02-17">
    <label>종료</label>
    <input type="date" id="dpDetailEnd" min="2026-02-17">
    <button class="dp-btn dp-btn--primary" onclick="dpDetailFetch()">이력 조회</button>
    <button class="dp-btn" onclick="dpDetailHot('7d',this)">7일</button>
    <button class="dp-btn" onclick="dpDetailHot('14d',this)">14일</button>
    <button class="dp-btn" onclick="dpDetailHot('30d',this)">30일</button>
    <button class="dp-btn" onclick="dpDetailHot('all',this)">전체</button>
  </div>
  <div class="dp-panel__body" id="dpPanelBody">
    <div style="display:flex;align-items:center;justify-content:center;height:100%;color:#94a3b8;font-size:12px">이력 조회 버튼을 눌러주세요</div>
  </div>
</div>

<script>
var DP = {
  PROXY: 'https://script.google.com/macros/s/AKfycbzyZ3GkPnU_1D_gax47Fa96GGCz-kVJU3QReBIoMzLo54PcfONtFe_h7QS2vRNxTZq3/exec',
  MIN_DATE: '2026-02-17',
  raw: [], latest: [], filtered: [],
  sortCol: 'total', sortDir: 'desc',
  selComId: null, selComName: '',
  dates: [], byCompany: {}, detailChart: null
};

function dpApi(p) {
  var qs = Object.keys(p).map(function(k){ return k+'='+encodeURIComponent(p[k]); }).join('&');
  return fetch(DP.PROXY+'?'+qs,{redirect:'follow'}).then(function(r){return r.json();});
}
function dpN(v){if(v===0)return'0';return(v<0?'-':'')+Math.abs(v).toLocaleString();}
function dpS(v){var p=v<0?'-':'',a=Math.abs(v);if(a>=1e8)return p+(a/1e8).toFixed(1)+'억';if(a>=1e4)return p+(a/1e4).toFixed(0)+'만';return p+a.toLocaleString();}
function dpD(v){if(v===0)return'-';return(v>0?'+':'')+dpN(v);}
function dpFmt(d){return d.toISOString().slice(0,10);}

function dpHot(key,el){
  var now=new Date(),y=now.getFullYear(),m=now.getMonth(),d=now.getDate(),s,e;
  switch(key){
    case'today':s=e=dpFmt(now);break;
    case'yesterday':s=e=dpFmt(new Date(y,m,d-1));break;
    case'thisWeek':var w=now.getDay()||7;s=dpFmt(new Date(y,m,d-w+1));e=dpFmt(new Date(y,m,d-w+7));break;
    case'lastWeek':var w2=now.getDay()||7;s=dpFmt(new Date(y,m,d-w2-6));e=dpFmt(new Date(y,m,d-w2));break;
    case'thisMonth':s=y+'-'+String(m+1).padStart(2,'0')+'-01';e=dpFmt(new Date(y,m+1,0));break;
    case'lastMonth':s=y+'-'+String(m).padStart(2,'0')+'-01';e=dpFmt(new Date(y,m,0));break;
  }
  if(s<DP.MIN_DATE)s=DP.MIN_DATE;
  document.getElementById('dpStart').value=s;
  document.getElementById('dpEnd').value=e;
  document.querySelectorAll('.dp-ctrl .dp-btn:not(.dp-btn--primary)').forEach(function(b){b.classList.remove('dp-btn--active');});
  if(el)el.classList.add('dp-btn--active');
  dpFetch();
}

function dpLoad(show,pct,txt){
  var el=document.getElementById('dpLoading');
  if(show)el.classList.add('dp-show');else el.classList.remove('dp-show');
  if(pct!==undefined)document.getElementById('dpLoadFill').style.width=pct+'%';
  if(txt)document.getElementById('dpLoadText').textContent=txt;
}

async function dpFetch(){
  var sd=document.getElementById('dpStart').value,ed=document.getElementById('dpEnd').value;
  if(!sd||!ed){alert('날짜를 선택하세요');return;}
  if(sd<DP.MIN_DATE)sd=DP.MIN_DATE;
  dpLoad(true,10,'데이터 조회 중...');
  document.getElementById('dpStatus').textContent='조회 중...';
  try{
    var d=await dpApi({action:'daypoint',startDate:sd,endDate:ed});
    dpLoad(true,70,'데이터 처리 중...');
    if(d.error){alert('API 오류: '+d.error);dpLoad(false);return;}
    DP.raw=d.rows||[];
    dpProcess();
    dpLoad(true,90,'렌더링 중...');
    dpRenderSummary();
    dpRenderTable();
    document.getElementById('dpStatus').textContent=DP.raw.length.toLocaleString()+'건 / '+DP.latest.length+'개사 ('+sd+' ~ '+ed+')';
    dpLoad(false);
  }catch(err){alert('통신 오류: '+err.message);dpLoad(false);}
}

function dpProcess(){
  var byComp={},dateSet={};
  DP.raw.forEach(function(r){
    var cid=String(r.comId||''),dt=String(r.date||'');
    dateSet[dt]=true;
    if(!byComp[cid])byComp[cid]={comId:cid,comName:String(r.comName||''),dates:{}};
    byComp[cid].dates[dt]={daily:Number(r.daily)||0,longTerm:Number(r.longTerm)||0,unlimited:Number(r.unlimited)||0,request:Number(r.request)||0,welfare:Number(r.welfare)||0,total:Number(r.total)||0};
  });
  DP.byCompany=byComp;
  DP.dates=Object.keys(dateSet).sort();
  var ld=DP.dates[DP.dates.length-1]||'',list=[];
  Object.keys(byComp).forEach(function(cid){
    var c=byComp[cid],d=c.dates[ld]||{daily:0,longTerm:0,unlimited:0,request:0,welfare:0,total:0};
    list.push({comId:cid,comName:c.comName,daily:d.daily,longTerm:d.longTerm,unlimited:d.unlimited,request:d.request,welfare:d.welfare,total:d.total});
  });
  DP.latest=list;DP.filtered=list.slice();DP.selComId=null;
}

function dpRenderSummary(){
  var f=DP.filtered,sD=0,sL=0,sU=0,sR=0,sW=0,sT=0;
  f.forEach(function(r){sD+=r.daily;sL+=r.longTerm;sU+=r.unlimited;sR+=r.request;sW+=r.welfare;sT+=r.total;});
  document.getElementById('dpSumCom').textContent=f.length.toLocaleString()+'개';
  document.getElementById('dpSumTotal').textContent=dpN(sT);
  document.getElementById('dpSumDaily').textContent=dpN(sD);
  document.getElementById('dpSumLong').textContent=dpN(sL);
  document.getElementById('dpSumUnlimited').textContent=dpN(sU);
  document.getElementById('dpSumRequest').textContent=dpN(sR);
  document.getElementById('dpSumWelfare').textContent=dpN(sW);
}

function dpSort(col){
  if(DP.sortCol===col)DP.sortDir=DP.sortDir==='desc'?'asc':'desc';
  else{DP.sortCol=col;DP.sortDir=col==='comName'?'asc':'desc';}
  dpRenderTable();
}

function dpFilter(){
  var q=document.getElementById('dpSearch').value.trim().toLowerCase();
  DP.filtered=!q?DP.latest.slice():DP.latest.filter(function(r){return r.comName.toLowerCase().indexOf(q)!==-1||r.comId.toLowerCase().indexOf(q)!==-1;});
  dpRenderSummary();dpRenderTable();
}

function dpRenderTable(){
  var f=DP.filtered.slice(),col=DP.sortCol,dir=DP.sortDir;
  f.sort(function(a,b){var va=a[col],vb=b[col];if(typeof va==='string')return dir==='asc'?va.localeCompare(vb):vb.localeCompare(va);return dir==='asc'?va-vb:vb-va;});
  document.querySelectorAll('.dp-table .dp-sort').forEach(function(s){s.textContent='';});
  var si=document.getElementById('dpSort'+col);if(si)si.textContent=dir==='asc'?' ▲':' ▼';
  var h='';
  f.forEach(function(r,i){
    var sel=r.comId===DP.selComId?' dp-row--sel':'';
    h+='<tr class="'+sel+'" onclick="dpSelect(\''+r.comId.replace(/'/g,"\\'")+'\')">';
    h+='<td>'+(i+1)+'</td>';
    h+='<td title="'+r.comId+'">'+r.comId.substring(0,8)+'</td>';
    h+='<td title="'+r.comName+'">'+r.comName+'</td>';
    h+='<td>'+dpN(r.daily)+'</td>';
    h+='<td>'+dpN(r.longTerm)+'</td>';
    h+='<td class="'+(r.unlimited<0?'dp-neg':'')+'">'+dpN(r.unlimited)+'</td>';
    h+='<td class="'+(r.request<0?'dp-neg':'')+'">'+dpN(r.request)+'</td>';
    h+='<td>'+dpN(r.welfare)+'</td>';
    h+='<td style="font-weight:600">'+dpN(r.total)+'</td></tr>';
  });
  document.getElementById('dpTbody').innerHTML=h;
  document.getElementById('dpCnt').textContent=f.length+'개';
}

function dpSelect(comId){
  DP.selComId=comId;
  var c=DP.byCompany[comId];if(!c)return;
  DP.selComName=c.comName;
  dpRenderTable();
  document.getElementById('dpPanelTitle').textContent=c.comName;
  document.getElementById('dpPanelSub').textContent='comId: '+comId;
  document.getElementById('dpDetailStart').value=document.getElementById('dpStart').value;
  document.getElementById('dpDetailEnd').value=document.getElementById('dpEnd').value;
  document.getElementById('dpOverlay').classList.add('dp-show');
  document.getElementById('dpPanel').classList.add('dp-show');
  dpRenderDetailFromCache();
}

function dpClosePanel(){
  document.getElementById('dpOverlay').classList.remove('dp-show');
  document.getElementById('dpPanel').classList.remove('dp-show');
  DP.selComId=null;dpRenderTable();
}

function dpDetailHot(key,el){
  var now=new Date(),s,e=dpFmt(now);
  switch(key){
    case'7d':s=dpFmt(new Date(now.getFullYear(),now.getMonth(),now.getDate()-6));break;
    case'14d':s=dpFmt(new Date(now.getFullYear(),now.getMonth(),now.getDate()-13));break;
    case'30d':s=dpFmt(new Date(now.getFullYear(),now.getMonth(),now.getDate()-29));break;
    case'all':s=DP.MIN_DATE;break;
  }
  if(s<DP.MIN_DATE)s=DP.MIN_DATE;
  document.getElementById('dpDetailStart').value=s;
  document.getElementById('dpDetailEnd').value=e;
  document.querySelectorAll('.dp-panel__ctrl .dp-btn:not(.dp-btn--primary)').forEach(function(b){b.classList.remove('dp-btn--active');});
  if(el)el.classList.add('dp-btn--active');
  dpDetailFetch();
}

async function dpDetailFetch(){
  var cid=DP.selComId;if(!cid)return;
  var sd=document.getElementById('dpDetailStart').value,ed=document.getElementById('dpDetailEnd').value;
  if(!sd||!ed){alert('날짜를 선택하세요');return;}
  if(sd<DP.MIN_DATE)sd=DP.MIN_DATE;
  var body=document.getElementById('dpPanelBody');
  body.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#94a3b8;font-size:12px">조회 중...</div>';
  try{
    var d=await dpApi({action:'daypoint',startDate:sd,endDate:ed});
    if(d.error){body.innerHTML='<div style="padding:16px;color:#e85d5d">오류: '+d.error+'</div>';return;}
    var rows=(d.rows||[]).filter(function(r){return String(r.comId||'')===cid;}),dateMap={};
    rows.forEach(function(r){dateMap[String(r.date||'')]={daily:Number(r.daily)||0,longTerm:Number(r.longTerm)||0,unlimited:Number(r.unlimited)||0,request:Number(r.request)||0,welfare:Number(r.welfare)||0,total:Number(r.total)||0};});
    dpRenderDetailContent(Object.keys(dateMap).sort(),dateMap);
  }catch(err){body.innerHTML='<div style="padding:16px;color:#e85d5d">통신 오류: '+err.message+'</div>';}
}

function dpRenderDetailFromCache(){
  var cid=DP.selComId,c=DP.byCompany[cid];if(!c)return;
  var dates=DP.dates.filter(function(dt){return!!c.dates[dt];});
  if(!dates.length){document.getElementById('dpPanelBody').innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#94a3b8;font-size:12px">해당 기간 데이터 없음</div>';return;}
  dpRenderDetailContent(dates,c.dates);
}

function dpRenderDetailContent(dates,dateMap){
  var body=document.getElementById('dpPanelBody');
  var ld=dates[dates.length-1]||'',lv=dateMap[ld]||{};
  var h='<div class="dp-panel__cards">';
  [['일일식대',lv.daily||0],['장기식대',lv.longTerm||0],['무제한식대',lv.unlimited||0],['신청식대',lv.request||0],['복지포인트',lv.welfare||0],['총합',lv.total||0]].forEach(function(it){
    h+='<div class="dp-pcard"><div class="dp-pcard__label">'+it[0]+'</div><div class="dp-pcard__value">'+dpN(it[1])+'</div></div>';
  });
  h+='</div>';
  if(dates.length>0){
    h+='<div class="dp-panel__section">날짜별 이력 ('+dates.length+'일)</div>';
    h+='<div style="max-height:240px;overflow:auto"><table class="dp-dtable"><thead><tr><th>날짜</th><th>일일</th><th>장기</th><th>무제한</th><th>신청</th><th>복지</th><th>총합</th><th>변동</th></tr></thead><tbody>';
    var prev=null;
    dates.forEach(function(dt){
      var d=dateMap[dt];if(!d)return;
      var diff='';
      if(prev!==null){var ch=d.total-prev;diff='<span class="'+(ch>0?'dp-pos':ch<0?'dp-neg':'')+'">'+dpD(ch)+'</span>';}
      h+='<tr><td>'+dt.slice(5)+'</td><td>'+dpN(d.daily)+'</td><td>'+dpN(d.longTerm)+'</td><td class="'+(d.unlimited<0?'dp-neg':'')+'">'+dpN(d.unlimited)+'</td><td class="'+(d.request<0?'dp-neg':'')+'">'+dpN(d.request)+'</td><td>'+dpN(d.welfare)+'</td><td style="font-weight:600">'+dpN(d.total)+'</td><td>'+diff+'</td></tr>';
      prev=d.total;
    });
    h+='</tbody></table></div>';
  }
  if(dates.length>=2)h+='<div class="dp-panel__section">총합 추이</div><div class="dp-chart-wrap"><canvas id="dpChart"></canvas></div>';
  body.innerHTML=h;
  if(dates.length>=2&&typeof Chart!=='undefined')dpRenderChart(dates,dateMap);
}

function dpRenderChart(dates,dateMap){
  var canvas=document.getElementById('dpChart');if(!canvas)return;
  if(DP.detailChart){DP.detailChart.destroy();DP.detailChart=null;}
  DP.detailChart=new Chart(canvas,{
    type:'line',
    data:{labels:dates.map(function(d){return d.slice(5);}),datasets:[{label:'총합',data:dates.map(function(d){var r=dateMap[d];return r?r.total:0;}),borderColor:'#4a90d9',backgroundColor:'rgba(74,144,217,0.1)',fill:true,tension:0.3,pointRadius:dates.length>30?0:3,pointBackgroundColor:'#4a90d9',borderWidth:2}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:function(ctx){return dpN(ctx.parsed.y)+'원';}}}},scales:{x:{grid:{display:false},ticks:{font:{size:10},maxTicksLimit:10}},y:{grid:{color:'#f0f4f9'},ticks:{font:{size:10,family:'JetBrains Mono'},callback:function(v){return dpS(v);}}}}}
  });
}

function dpCopy(){
  var f=DP.filtered.slice(),col=DP.sortCol,dir=DP.sortDir;
  f.sort(function(a,b){var va=a[col],vb=b[col];if(typeof va==='string')return dir==='asc'?va.localeCompare(vb):vb.localeCompare(va);return dir==='asc'?va-vb:vb-va;});
  var lines=['No\tcomId\t고객사명\t일일식대\t장기식대\t무제한식대\t신청식대\t복지포인트\t총합'];
  f.forEach(function(r,i){lines.push((i+1)+'\t'+r.comId+'\t'+r.comName+'\t'+r.daily+'\t'+r.longTerm+'\t'+r.unlimited+'\t'+r.request+'\t'+r.welfare+'\t'+r.total);});
  navigator.clipboard.writeText(lines.join('\n')).then(function(){var ok=document.getElementById('dpCopyOk');ok.style.display='inline';setTimeout(function(){ok.style.display='none';},1500);});
}

(function dpInit(){
  if(typeof Chart==='undefined'){var sc=document.createElement('script');sc.src='https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js';document.head.appendChild(sc);}
  var today=dpFmt(new Date());if(today<DP.MIN_DATE)today=DP.MIN_DATE;
  document.getElementById('dpStart').value=today;
  document.getElementById('dpEnd').value=today;
  setTimeout(function(){dpFetch();},0);
})();
</script>
